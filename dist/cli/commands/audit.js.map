{"version":3,"file":"audit.js","sources":["../../../src/cli/commands/audit.ts"],"sourcesContent":["/**\n * Audit Command\n *\n * CLI commands for querying and managing the exochain audit log.\n * Provides access to:\n * - Query audit events with filtering\n * - Create checkpoints for chain finality\n * - Verify audit chain integrity\n * - Check and manage sync status with peers\n * - Export audit log data\n *\n * @module cli/commands/audit\n */\n\nimport { Command } from 'commander';\nimport chalk from 'chalk';\nimport ora from 'ora';\nimport { existsSync } from 'fs';\nimport { join } from 'path';\nimport { writeFile } from 'fs/promises';\nimport {\n  createAuditChain,\n  createAuditChainConfig,\n  type LedgerEvent,\n  type EventQueryOptions,\n  type ChainStats,\n  type Checkpoint,\n  type HybridLogicalClock,\n} from '../../audit/index.js';\nimport {\n  createSyndicationService,\n  type PeerInfo,\n  type SyncResult,\n} from '../../audit/services/syndication.js';\nimport { validateProjectRoot } from '../../core/security.js';\n\n/**\n * Format a date for display\n *\n * @param date - Date to format\n * @returns Formatted date string\n */\nfunction formatDate(date: Date | undefined): string {\n  if (!date) return 'N/A';\n  return date.toISOString().replace('T', ' ').replace(/\\.\\d{3}Z$/, '');\n}\n\n/**\n * Format HLC timestamp for display\n *\n * @param hlc - Hybrid logical clock to format\n * @returns Formatted timestamp string\n */\nfunction formatHLC(hlc: HybridLogicalClock): string {\n  const date = new Date(hlc.physicalMs);\n  return `${formatDate(date)} (L:${hlc.logical})`;\n}\n\n/**\n * Format duration in milliseconds for display\n *\n * @param ms - Duration in milliseconds\n * @returns Formatted duration string\n */\nfunction formatDuration(ms: number): string {\n  if (ms < 1000) return `${ms}ms`;\n  if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;\n  return `${(ms / 60000).toFixed(1)}m`;\n}\n\n/**\n * Print events in a table format\n *\n * @param events - Events to display\n */\nfunction printEventsTable(events: LedgerEvent[]): void {\n  if (events.length === 0) {\n    console.log(chalk.gray('  No events found'));\n    return;\n  }\n\n  // Header\n  console.log(\n    chalk.gray(\n      '  ' +\n        'ID'.padEnd(16) +\n        'Type'.padEnd(24) +\n        'Author'.padEnd(20) +\n        'Timestamp'\n    )\n  );\n  console.log(chalk.gray('  ' + '-'.repeat(80)));\n\n  // Rows\n  for (const event of events) {\n    const id = event.id.substring(0, 14) + '..';\n    const type = event.envelope.payload.type;\n    const author = event.envelope.author.substring(0, 18);\n    const timestamp = formatHLC(event.envelope.hlc);\n\n    const typeColor =\n      type.includes('Created') ? chalk.green :\n      type.includes('Deleted') ? chalk.red :\n      type.includes('Updated') ? chalk.yellow :\n      type.includes('Completed') ? chalk.cyan :\n      type.includes('Started') ? chalk.blue :\n      chalk.white;\n\n    console.log(\n      '  ' +\n        chalk.gray(id.padEnd(16)) +\n        typeColor(type.padEnd(24)) +\n        chalk.gray(author.padEnd(20)) +\n        chalk.gray(timestamp)\n    );\n  }\n}\n\n/**\n * Print chain statistics\n *\n * @param stats - Chain statistics to display\n */\nfunction printChainStats(stats: ChainStats): void {\n  const statusColor =\n    stats.status === 'healthy' ? chalk.green :\n    stats.status === 'syncing' ? chalk.yellow :\n    chalk.red;\n\n  console.log(chalk.white('  Overview'));\n  console.log(chalk.gray(`    Status:           `) + statusColor(stats.status));\n  console.log(chalk.gray(`    Total events:     ${stats.totalEvents}`));\n  console.log(chalk.gray(`    Checkpoint height: ${stats.checkpointHeight}`));\n  console.log(chalk.gray(`    Unique authors:   ${stats.uniqueAuthors}`));\n  if (stats.lastEventTime) {\n    console.log(chalk.gray(`    Last event:       ${formatDate(stats.lastEventTime)}`));\n  }\n\n  if (Object.keys(stats.eventsByType).length > 0) {\n    console.log();\n    console.log(chalk.white('  Events by Type'));\n    const sortedTypes = Object.entries(stats.eventsByType)\n      .sort((a, b) => b[1] - a[1]);\n\n    for (const [type, count] of sortedTypes) {\n      const bar = '|'.repeat(Math.min(Math.ceil(count / 5), 30));\n      console.log(\n        chalk.gray(`    ${type.padEnd(24)} ${String(count).padStart(5)} `) +\n        chalk.blue(bar)\n      );\n    }\n  }\n}\n\n/**\n * Print checkpoint information\n *\n * @param checkpoint - Checkpoint to display\n */\nfunction printCheckpoint(checkpoint: Checkpoint | null): void {\n  if (!checkpoint) {\n    console.log(chalk.gray('  No checkpoints created yet'));\n    return;\n  }\n\n  console.log(chalk.white('  Latest Checkpoint'));\n  console.log(chalk.gray(`    Height:     ${checkpoint.height}`));\n  console.log(chalk.gray(`    Event root: ${checkpoint.eventRoot.substring(0, 32)}...`));\n  console.log(chalk.gray(`    State root: ${checkpoint.stateRoot.substring(0, 32)}...`));\n  console.log(chalk.gray(`    Timestamp:  ${formatDate(checkpoint.timestamp)}`));\n  console.log(chalk.gray(`    Signatures: ${checkpoint.validatorSignatures.length}`));\n}\n\n/**\n * Print peer information in table format\n *\n * @param peers - Peers to display\n */\nfunction printPeersTable(peers: PeerInfo[]): void {\n  if (peers.length === 0) {\n    console.log(chalk.gray('  No peers configured'));\n    return;\n  }\n\n  console.log(\n    chalk.gray(\n      '  ' +\n        'ID'.padEnd(16) +\n        'Status'.padEnd(14) +\n        'Last Sync'.padEnd(22) +\n        'Events (Rx/Tx)'\n    )\n  );\n  console.log(chalk.gray('  ' + '-'.repeat(70)));\n\n  for (const peer of peers) {\n    const statusColor =\n      peer.status === 'connected' ? chalk.green :\n      peer.status === 'syncing' ? chalk.yellow :\n      peer.status === 'error' ? chalk.red :\n      chalk.gray;\n\n    const lastSync = peer.lastSyncTime ? formatDate(peer.lastSyncTime) : 'Never';\n    const events = `${peer.eventsReceived}/${peer.eventsSent}`;\n\n    console.log(\n      '  ' +\n        chalk.gray(peer.id.padEnd(16)) +\n        statusColor(peer.status.padEnd(14)) +\n        chalk.gray(lastSync.padEnd(22)) +\n        chalk.gray(events)\n    );\n\n    if (peer.lastError) {\n      console.log(chalk.red(`     Error: ${peer.lastError}`));\n    }\n  }\n}\n\n/**\n * Print sync results\n *\n * @param results - Sync results to display\n */\nfunction printSyncResults(results: SyncResult[]): void {\n  if (results.length === 0) {\n    console.log(chalk.gray('  No sync operations performed'));\n    return;\n  }\n\n  console.log(\n    chalk.gray(\n      '  ' +\n        'Peer'.padEnd(16) +\n        'Status'.padEnd(10) +\n        'Received'.padEnd(10) +\n        'Sent'.padEnd(10) +\n        'Duration'\n    )\n  );\n  console.log(chalk.gray('  ' + '-'.repeat(60)));\n\n  for (const result of results) {\n    const statusColor = result.success ? chalk.green : chalk.red;\n    const status = result.success ? 'OK' : 'FAIL';\n\n    console.log(\n      '  ' +\n        chalk.gray(result.peerId.substring(0, 14).padEnd(16)) +\n        statusColor(status.padEnd(10)) +\n        chalk.gray(String(result.eventsReceived).padEnd(10)) +\n        chalk.gray(String(result.eventsSent).padEnd(10)) +\n        chalk.gray(formatDuration(result.duration))\n    );\n\n    if (result.error) {\n      console.log(chalk.red(`     Error: ${result.error}`));\n    }\n  }\n}\n\n/**\n * Parse date string to HLC for filtering\n *\n * @param dateStr - Date string to parse\n * @returns HLC timestamp or undefined\n */\nfunction parseDateToHLC(dateStr: string | undefined): HybridLogicalClock | undefined {\n  if (!dateStr) return undefined;\n\n  const date = new Date(dateStr);\n  if (isNaN(date.getTime())) {\n    throw new Error(`Invalid date format: ${dateStr}`);\n  }\n\n  return {\n    physicalMs: date.getTime(),\n    logical: 0,\n  };\n}\n\n/**\n * Create audit command with subcommands\n *\n * @returns Configured audit command\n */\nexport function createAuditCommand(): Command {\n  const audit = new Command('audit')\n    .description('Query and manage the exochain audit log');\n\n  // ============================================================================\n  // Query subcommand\n  // ============================================================================\n  audit\n    .command('query')\n    .description('Query the audit log')\n    .option('-t, --type <type>', 'Filter by event type (e.g., NodeCreated, WorkflowCompleted)')\n    .option('-s, --start <date>', 'Start date (ISO format, e.g., 2024-01-01)')\n    .option('-e, --end <date>', 'End date (ISO format)')\n    .option('-l, --limit <n>', 'Maximum results to return', '50')\n    .option('-a, --author <did>', 'Filter by author DID')\n    .option('--json', 'Output as JSON')\n    .option('-p, --path <path>', 'Project root path', '.')\n    .action(async (options) => {\n      const spinner = ora('Querying audit log...').start();\n\n      try {\n        const projectRoot = validateProjectRoot(options.path);\n        const auditChain = createAuditChain(createAuditChainConfig());\n\n        // Build query options\n        const queryOptions: EventQueryOptions = {\n          limit: parseInt(options.limit, 10) || 50,\n          includeProof: false,\n        };\n\n        if (options.type) {\n          queryOptions.type = options.type;\n        }\n\n        if (options.author) {\n          queryOptions.author = options.author;\n        }\n\n        if (options.start) {\n          queryOptions.since = parseDateToHLC(options.start);\n        }\n\n        if (options.end) {\n          queryOptions.until = parseDateToHLC(options.end);\n        }\n\n        const result = await auditChain.queryEvents(queryOptions);\n\n        spinner.stop();\n\n        if (options.json) {\n          console.log(JSON.stringify({\n            events: result.events.map(e => ({\n              id: e.id,\n              type: e.envelope.payload.type,\n              author: e.envelope.author,\n              timestamp: e.envelope.hlc.physicalMs,\n              parents: e.envelope.parents,\n              payload: e.envelope.payload,\n            })),\n            totalCount: result.totalCount,\n            hasMore: result.hasMore,\n          }, null, 2));\n          return;\n        }\n\n        console.log(chalk.cyan('\\n  Audit Log Query Results\\n'));\n        console.log(chalk.gray(`  Found ${result.totalCount} events (showing ${result.events.length})`));\n        if (result.hasMore) {\n          console.log(chalk.gray('  (more results available, increase --limit to see more)'));\n        }\n        console.log();\n\n        printEventsTable(result.events);\n\n        // Show chain stats summary\n        console.log();\n        const stats = auditChain.getStats();\n        console.log(chalk.gray(`  Chain status: `) + chalk.green(stats.status));\n        console.log();\n\n      } catch (error) {\n        spinner.fail('Query failed');\n        console.error(chalk.red(String(error)));\n        process.exit(1);\n      }\n    });\n\n  // ============================================================================\n  // Checkpoint subcommand\n  // ============================================================================\n  audit\n    .command('checkpoint')\n    .description('Create a checkpoint in the audit chain')\n    .option('-n, --name <name>', 'Checkpoint name/label')\n    .option('-t, --tags <tags>', 'Comma-separated tags')\n    .option('--json', 'Output as JSON')\n    .option('-p, --path <path>', 'Project root path', '.')\n    .action(async (options) => {\n      const spinner = ora('Creating checkpoint...').start();\n\n      try {\n        const projectRoot = validateProjectRoot(options.path);\n        const auditChain = createAuditChain(createAuditChainConfig());\n\n        // Create the checkpoint\n        const checkpoint = await auditChain.createCheckpoint();\n\n        spinner.succeed('Checkpoint created!');\n\n        if (options.json) {\n          console.log(JSON.stringify({\n            height: checkpoint.height,\n            eventRoot: checkpoint.eventRoot,\n            stateRoot: checkpoint.stateRoot,\n            timestamp: checkpoint.timestamp.toISOString(),\n            signatures: checkpoint.validatorSignatures.length,\n            name: options.name,\n            tags: options.tags?.split(',').map((t: string) => t.trim()),\n          }, null, 2));\n          return;\n        }\n\n        console.log(chalk.cyan('\\n  Checkpoint Details\\n'));\n\n        if (options.name) {\n          console.log(chalk.white(`  Name: ${options.name}`));\n        }\n        if (options.tags) {\n          const tags = options.tags.split(',').map((t: string) => t.trim());\n          console.log(chalk.white(`  Tags: ${tags.join(', ')}`));\n        }\n\n        console.log();\n        printCheckpoint(checkpoint);\n        console.log();\n\n      } catch (error) {\n        spinner.fail('Checkpoint creation failed');\n        console.error(chalk.red(String(error)));\n        process.exit(1);\n      }\n    });\n\n  // ============================================================================\n  // Verify subcommand\n  // ============================================================================\n  audit\n    .command('verify')\n    .description('Verify audit chain integrity')\n    .option('--full', 'Perform full chain verification (slower)')\n    .option('--json', 'Output as JSON')\n    .option('-p, --path <path>', 'Project root path', '.')\n    .action(async (options) => {\n      const spinner = ora('Verifying audit chain integrity...').start();\n\n      try {\n        const projectRoot = validateProjectRoot(options.path);\n        const auditChain = createAuditChain(createAuditChainConfig());\n\n        const startTime = Date.now();\n        const stats = auditChain.getStats();\n        const checkpoint = auditChain.getLatestCheckpoint();\n\n        // Verify chain structure\n        const issues: string[] = [];\n        const warnings: string[] = [];\n\n        // Check for basic chain health\n        if (stats.status === 'degraded') {\n          issues.push('Chain status is degraded');\n        }\n\n        // Check checkpoint consistency\n        if (stats.checkpointHeight > 0 && !checkpoint) {\n          issues.push('Checkpoint height > 0 but no checkpoint found');\n        }\n\n        // Check for orphan events (no parents and not genesis)\n        const chainData = auditChain.export();\n        let genesisCount = 0;\n        for (const event of chainData.events) {\n          if (event.envelope.parents.length === 0) {\n            genesisCount++;\n          }\n        }\n        if (genesisCount > 1) {\n          warnings.push(`Multiple genesis events found: ${genesisCount}`);\n        }\n\n        // Verify tips are valid\n        const tips = auditChain.getTips();\n        if (tips.length === 0 && chainData.events.length > 0) {\n          issues.push('No chain tips but events exist');\n        }\n\n        // Check event ordering if full verification\n        if (options.full) {\n          spinner.text = 'Performing full chain verification...';\n\n          // Verify event IDs and signatures\n          for (const event of chainData.events) {\n            // Check parent existence\n            for (const parentId of event.envelope.parents) {\n              const parent = chainData.events.find(e => e.id === parentId);\n              if (!parent) {\n                issues.push(`Event ${event.id.substring(0, 12)}.. references missing parent ${parentId.substring(0, 12)}..`);\n              }\n            }\n          }\n        }\n\n        const duration = Date.now() - startTime;\n        const valid = issues.length === 0;\n\n        spinner.stop();\n\n        if (options.json) {\n          console.log(JSON.stringify({\n            valid,\n            issues,\n            warnings,\n            stats: {\n              totalEvents: stats.totalEvents,\n              checkpointHeight: stats.checkpointHeight,\n              status: stats.status,\n              tips: tips.length,\n            },\n            duration,\n          }, null, 2));\n          return;\n        }\n\n        console.log(chalk.cyan('\\n  Audit Chain Verification\\n'));\n\n        if (valid) {\n          console.log(chalk.green('  Status: VALID'));\n        } else {\n          console.log(chalk.red('  Status: INVALID'));\n        }\n\n        console.log();\n        console.log(chalk.white('  Statistics'));\n        console.log(chalk.gray(`    Events verified:    ${stats.totalEvents}`));\n        console.log(chalk.gray(`    Checkpoint height:  ${stats.checkpointHeight}`));\n        console.log(chalk.gray(`    Chain tips:         ${tips.length}`));\n        console.log(chalk.gray(`    Verification time:  ${formatDuration(duration)}`));\n\n        if (issues.length > 0) {\n          console.log();\n          console.log(chalk.red('  Issues Found'));\n          for (const issue of issues) {\n            console.log(chalk.red(`    - ${issue}`));\n          }\n        }\n\n        if (warnings.length > 0) {\n          console.log();\n          console.log(chalk.yellow('  Warnings'));\n          for (const warning of warnings) {\n            console.log(chalk.yellow(`    - ${warning}`));\n          }\n        }\n\n        console.log();\n\n        if (!valid) {\n          process.exit(1);\n        }\n\n      } catch (error) {\n        spinner.fail('Verification failed');\n        console.error(chalk.red(String(error)));\n        process.exit(1);\n      }\n    });\n\n  // ============================================================================\n  // Sync subcommand group\n  // ============================================================================\n  const sync = audit\n    .command('sync')\n    .description('Manage audit chain synchronization');\n\n  // sync status\n  sync\n    .command('status')\n    .description('Check synchronization status')\n    .option('--json', 'Output as JSON')\n    .option('-p, --path <path>', 'Project root path', '.')\n    .action(async (options) => {\n      const spinner = ora('Checking sync status...').start();\n\n      try {\n        const projectRoot = validateProjectRoot(options.path);\n        const auditChain = createAuditChain(createAuditChainConfig());\n        const syndication = createSyndicationService({ auditChain });\n\n        const stats = syndication.getStats();\n        const chainStats = auditChain.getStats();\n\n        spinner.stop();\n\n        if (options.json) {\n          console.log(JSON.stringify({\n            service: {\n              running: stats.isRunning,\n              autoSyncEnabled: stats.autoSyncEnabled,\n              syncInterval: stats.syncInterval,\n            },\n            peers: {\n              total: stats.totalPeers,\n              connected: stats.connectedPeers,\n              syncing: stats.syncingPeers,\n              error: stats.errorPeers,\n            },\n            transfer: {\n              received: stats.totalEventsReceived,\n              sent: stats.totalEventsSent,\n              errors: stats.totalErrors,\n            },\n            chain: {\n              status: chainStats.status,\n              events: chainStats.totalEvents,\n              checkpointHeight: chainStats.checkpointHeight,\n            },\n          }, null, 2));\n          return;\n        }\n\n        console.log(chalk.cyan('\\n  Sync Status\\n'));\n\n        // Service status\n        console.log(chalk.white('  Service'));\n        console.log(chalk.gray(`    Running:      `) + (stats.isRunning ? chalk.green('Yes') : chalk.gray('No')));\n        console.log(chalk.gray(`    Auto-sync:    `) + (stats.autoSyncEnabled ? chalk.green('Enabled') : chalk.gray('Disabled')));\n        if (stats.autoSyncEnabled) {\n          console.log(chalk.gray(`    Interval:     ${formatDuration(stats.syncInterval)}`));\n        }\n\n        // Peer status\n        console.log();\n        console.log(chalk.white('  Peers'));\n        console.log(chalk.gray(`    Total:        ${stats.totalPeers}`));\n        console.log(chalk.gray(`    Connected:    `) + chalk.green(String(stats.connectedPeers)));\n        if (stats.syncingPeers > 0) {\n          console.log(chalk.gray(`    Syncing:      `) + chalk.yellow(String(stats.syncingPeers)));\n        }\n        if (stats.errorPeers > 0) {\n          console.log(chalk.gray(`    Errors:       `) + chalk.red(String(stats.errorPeers)));\n        }\n\n        // Transfer stats\n        console.log();\n        console.log(chalk.white('  Transfer Statistics'));\n        console.log(chalk.gray(`    Events received: ${stats.totalEventsReceived}`));\n        console.log(chalk.gray(`    Events sent:     ${stats.totalEventsSent}`));\n        if (stats.totalErrors > 0) {\n          console.log(chalk.gray(`    Errors:          `) + chalk.red(String(stats.totalErrors)));\n        }\n\n        // Chain status\n        console.log();\n        console.log(chalk.white('  Chain'));\n        const chainStatusColor =\n          chainStats.status === 'healthy' ? chalk.green :\n          chainStats.status === 'syncing' ? chalk.yellow :\n          chalk.red;\n        console.log(chalk.gray(`    Status:       `) + chainStatusColor(chainStats.status));\n        console.log(chalk.gray(`    Events:       ${chainStats.totalEvents}`));\n        console.log(chalk.gray(`    Checkpoint:   ${chainStats.checkpointHeight}`));\n\n        console.log();\n\n      } catch (error) {\n        spinner.fail('Status check failed');\n        console.error(chalk.red(String(error)));\n        process.exit(1);\n      }\n    });\n\n  // sync peers\n  sync\n    .command('peers')\n    .description('List sync peers')\n    .option('--json', 'Output as JSON')\n    .option('-p, --path <path>', 'Project root path', '.')\n    .action(async (options) => {\n      const spinner = ora('Fetching peer list...').start();\n\n      try {\n        const projectRoot = validateProjectRoot(options.path);\n        const auditChain = createAuditChain(createAuditChainConfig());\n        const syndication = createSyndicationService({ auditChain });\n\n        const peers = syndication.getAllPeers();\n\n        spinner.stop();\n\n        if (options.json) {\n          console.log(JSON.stringify({\n            peers: peers.map(p => ({\n              id: p.id,\n              endpoint: p.endpoint,\n              did: p.did,\n              status: p.status,\n              lastSync: p.lastSyncTime?.toISOString(),\n              lastCheckpointHeight: p.lastCheckpointHeight,\n              eventsReceived: p.eventsReceived,\n              eventsSent: p.eventsSent,\n              errors: p.errors,\n              lastError: p.lastError,\n              latency: p.latency,\n            })),\n            summary: {\n              total: peers.length,\n              connected: peers.filter(p => p.status === 'connected').length,\n              error: peers.filter(p => p.status === 'error').length,\n            },\n          }, null, 2));\n          return;\n        }\n\n        console.log(chalk.cyan('\\n  Sync Peers\\n'));\n\n        printPeersTable(peers);\n\n        // Summary\n        const connected = peers.filter(p => p.status === 'connected').length;\n        const errors = peers.filter(p => p.status === 'error').length;\n\n        console.log();\n        console.log(chalk.gray(`  Total: ${peers.length}, Connected: ${connected}, Errors: ${errors}`));\n        console.log();\n\n      } catch (error) {\n        spinner.fail('Failed to fetch peers');\n        console.error(chalk.red(String(error)));\n        process.exit(1);\n      }\n    });\n\n  // sync now (force immediate sync)\n  sync\n    .command('now')\n    .description('Force immediate synchronization with all peers')\n    .option('--json', 'Output as JSON')\n    .option('-p, --path <path>', 'Project root path', '.')\n    .action(async (options) => {\n      const spinner = ora('Syncing with peers...').start();\n\n      try {\n        const projectRoot = validateProjectRoot(options.path);\n        const auditChain = createAuditChain(createAuditChainConfig());\n        const syndication = createSyndicationService({ auditChain });\n\n        await syndication.start();\n        const results = await syndication.forceSyncNow();\n        await syndication.stop();\n\n        spinner.stop();\n\n        if (options.json) {\n          console.log(JSON.stringify({\n            results: results.map(r => ({\n              peerId: r.peerId,\n              success: r.success,\n              eventsReceived: r.eventsReceived,\n              eventsSent: r.eventsSent,\n              newCheckpointHeight: r.newCheckpointHeight,\n              duration: r.duration,\n              error: r.error,\n            })),\n            summary: {\n              total: results.length,\n              successful: results.filter(r => r.success).length,\n              failed: results.filter(r => !r.success).length,\n            },\n          }, null, 2));\n          return;\n        }\n\n        console.log(chalk.cyan('\\n  Sync Results\\n'));\n\n        printSyncResults(results);\n\n        // Summary\n        const successful = results.filter(r => r.success).length;\n        const failed = results.filter(r => !r.success).length;\n        const totalReceived = results.reduce((sum, r) => sum + r.eventsReceived, 0);\n        const totalSent = results.reduce((sum, r) => sum + r.eventsSent, 0);\n\n        console.log();\n        console.log(chalk.gray(`  Peers: ${results.length} (${successful} successful, ${failed} failed)`));\n        console.log(chalk.gray(`  Events: ${totalReceived} received, ${totalSent} sent`));\n        console.log();\n\n        if (failed > 0) {\n          process.exit(1);\n        }\n\n      } catch (error) {\n        spinner.fail('Sync failed');\n        console.error(chalk.red(String(error)));\n        process.exit(1);\n      }\n    });\n\n  // ============================================================================\n  // Export subcommand\n  // ============================================================================\n  audit\n    .command('export')\n    .description('Export audit log data')\n    .option('-o, --output <file>', 'Output file path')\n    .option('-f, --format <format>', 'Export format (json|jsonl)', 'json')\n    .option('-t, --type <type>', 'Filter by event type')\n    .option('-s, --start <date>', 'Start date filter')\n    .option('-e, --end <date>', 'End date filter')\n    .option('-l, --limit <n>', 'Maximum events to export')\n    .option('-p, --path <path>', 'Project root path', '.')\n    .action(async (options) => {\n      const spinner = ora('Exporting audit log...').start();\n\n      try {\n        const projectRoot = validateProjectRoot(options.path);\n        const auditChain = createAuditChain(createAuditChainConfig());\n\n        // Build query options\n        const queryOptions: EventQueryOptions = {\n          includeProof: true,\n        };\n\n        if (options.type) {\n          queryOptions.type = options.type;\n        }\n\n        if (options.start) {\n          queryOptions.since = parseDateToHLC(options.start);\n        }\n\n        if (options.end) {\n          queryOptions.until = parseDateToHLC(options.end);\n        }\n\n        if (options.limit) {\n          queryOptions.limit = parseInt(options.limit, 10);\n        }\n\n        const result = await auditChain.queryEvents(queryOptions);\n        const chainData = auditChain.export();\n        const checkpoint = auditChain.getLatestCheckpoint();\n\n        // Format export data\n        const exportData = {\n          metadata: {\n            exportedAt: new Date().toISOString(),\n            chainStatus: auditChain.getStats().status,\n            totalEvents: result.totalCount,\n            exportedEvents: result.events.length,\n            checkpointHeight: checkpoint?.height ?? 0,\n            filters: {\n              type: options.type,\n              startDate: options.start,\n              endDate: options.end,\n              limit: options.limit,\n            },\n          },\n          checkpoint: checkpoint ? {\n            height: checkpoint.height,\n            eventRoot: checkpoint.eventRoot,\n            stateRoot: checkpoint.stateRoot,\n            timestamp: checkpoint.timestamp.toISOString(),\n            signatures: checkpoint.validatorSignatures.length,\n          } : null,\n          events: result.events.map(e => ({\n            id: e.id,\n            type: e.envelope.payload.type,\n            author: e.envelope.author,\n            timestamp: new Date(e.envelope.hlc.physicalMs).toISOString(),\n            hlc: e.envelope.hlc,\n            parents: e.envelope.parents,\n            payload: e.envelope.payload,\n            signature: e.signature,\n          })),\n          tips: chainData.tips,\n        };\n\n        let output: string;\n        if (options.format === 'jsonl') {\n          // JSON Lines format - one event per line\n          const lines = [\n            JSON.stringify({ type: 'metadata', data: exportData.metadata }),\n            ...(exportData.checkpoint ? [JSON.stringify({ type: 'checkpoint', data: exportData.checkpoint })] : []),\n            ...exportData.events.map(e => JSON.stringify({ type: 'event', data: e })),\n          ];\n          output = lines.join('\\n');\n        } else {\n          output = JSON.stringify(exportData, null, 2);\n        }\n\n        spinner.stop();\n\n        if (options.output) {\n          const outputPath = join(projectRoot, options.output);\n          await writeFile(outputPath, output, 'utf-8');\n          console.log(chalk.green(`\\n  Exported ${result.events.length} events to ${outputPath}\\n`));\n        } else {\n          console.log(output);\n        }\n\n      } catch (error) {\n        spinner.fail('Export failed');\n        console.error(chalk.red(String(error)));\n        process.exit(1);\n      }\n    });\n\n  // ============================================================================\n  // Stats subcommand\n  // ============================================================================\n  audit\n    .command('stats')\n    .description('Show audit chain statistics')\n    .option('--json', 'Output as JSON')\n    .option('-p, --path <path>', 'Project root path', '.')\n    .action(async (options) => {\n      try {\n        const projectRoot = validateProjectRoot(options.path);\n        const auditChain = createAuditChain(createAuditChainConfig());\n\n        const stats = auditChain.getStats();\n        const checkpoint = auditChain.getLatestCheckpoint();\n        const tips = auditChain.getTips();\n\n        if (options.json) {\n          console.log(JSON.stringify({\n            stats,\n            checkpoint: checkpoint ? {\n              height: checkpoint.height,\n              eventRoot: checkpoint.eventRoot,\n              stateRoot: checkpoint.stateRoot,\n              timestamp: checkpoint.timestamp.toISOString(),\n              signatures: checkpoint.validatorSignatures.length,\n            } : null,\n            tips: {\n              count: tips.length,\n              ids: tips,\n            },\n          }, null, 2));\n          return;\n        }\n\n        console.log(chalk.cyan('\\n  Audit Chain Statistics\\n'));\n\n        printChainStats(stats);\n\n        console.log();\n        printCheckpoint(checkpoint);\n\n        if (tips.length > 0) {\n          console.log();\n          console.log(chalk.white('  Chain Tips'));\n          console.log(chalk.gray(`    Count: ${tips.length}`));\n          for (const tip of tips.slice(0, 5)) {\n            console.log(chalk.gray(`    - ${tip.substring(0, 32)}...`));\n          }\n          if (tips.length > 5) {\n            console.log(chalk.gray(`    ... and ${tips.length - 5} more`));\n          }\n        }\n\n        console.log();\n\n      } catch (error) {\n        console.error(chalk.red('Failed to get statistics:'), String(error));\n        process.exit(1);\n      }\n    });\n\n  return audit;\n}\n"],"names":[],"mappings":"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"}