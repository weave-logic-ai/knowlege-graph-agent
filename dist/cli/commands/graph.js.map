{"version":3,"file":"graph.js","sources":["../../../src/cli/commands/graph.ts"],"sourcesContent":["/**\n * Graph Command\n *\n * Generate and update knowledge graph from documentation.\n */\n\nimport { Command } from 'commander';\nimport chalk from 'chalk';\nimport ora from 'ora';\nimport { existsSync } from 'fs';\nimport { join } from 'path';\nimport { generateAndSave, updateGraph } from '../../generators/graph-generator.js';\nimport { validateProjectRoot, validateDocsPath } from '../../core/security.js';\n\n/**\n * Create graph command\n */\nexport function createGraphCommand(): Command {\n  const command = new Command('graph');\n\n  command\n    .description('Generate or update knowledge graph from documentation')\n    .option('-p, --path <path>', 'Project root path', '.')\n    .option('-d, --docs <path>', 'Docs directory path', 'docs')\n    .option('-u, --update', 'Incremental update instead of full regeneration')\n    .option('-v, --verbose', 'Show detailed output')\n    .action(async (options) => {\n      const spinner = ora('Generating knowledge graph...').start();\n\n      try {\n        // Validate paths to prevent traversal attacks\n        const projectRoot = validateProjectRoot(options.path);\n        const docsPath = validateDocsPath(projectRoot, options.docs);\n        const dbPath = join(projectRoot, '.kg', 'knowledge.db');\n\n        // Check if docs exist\n        if (!existsSync(docsPath)) {\n          spinner.fail(`Docs directory not found: ${docsPath}`);\n          console.log(chalk.gray('  Run ') + chalk.cyan('kg docs init') + chalk.gray(' to create it'));\n          process.exit(1);\n        }\n\n        // Check if KG is initialized\n        if (!existsSync(join(projectRoot, '.kg'))) {\n          spinner.fail('Knowledge graph not initialized');\n          console.log(chalk.gray('  Run ') + chalk.cyan('kg init') + chalk.gray(' first'));\n          process.exit(1);\n        }\n\n        let result;\n\n        if (options.update && existsSync(dbPath)) {\n          // Incremental update\n          spinner.text = 'Updating knowledge graph...';\n          result = await updateGraph(dbPath, docsPath);\n\n          spinner.succeed('Knowledge graph updated!');\n\n          console.log();\n          console.log(chalk.white('  Changes:'));\n          console.log(chalk.green(`    Added:   ${result.added}`));\n          console.log(chalk.blue(`    Updated: ${result.updated}`));\n          console.log(chalk.yellow(`    Removed: ${result.removed}`));\n\n        } else {\n          // Full generation\n          spinner.text = 'Scanning documentation...';\n\n          result = await generateAndSave(\n            {\n              projectRoot,\n              outputPath: docsPath,\n            },\n            dbPath\n          );\n\n          if (result.success) {\n            spinner.succeed('Knowledge graph generated!');\n          } else {\n            spinner.warn('Knowledge graph generated with errors');\n          }\n\n          console.log();\n          console.log(chalk.white('  Statistics:'));\n          console.log(chalk.gray(`    Files scanned: ${result.stats.filesScanned}`));\n          console.log(chalk.green(`    Nodes created: ${result.stats.nodesCreated}`));\n          console.log(chalk.blue(`    Edges created: ${result.stats.edgesCreated}`));\n        }\n\n        // Show errors if any\n        const errors = 'errors' in result ? result.errors : result.stats?.errors;\n        if (errors && errors.length > 0) {\n          console.log();\n          console.log(chalk.yellow('  Warnings:'));\n          errors.slice(0, 5).forEach((err: string) => {\n            console.log(chalk.gray(`    - ${err}`));\n          });\n          if (errors.length > 5) {\n            console.log(chalk.gray(`    ... and ${errors.length - 5} more`));\n          }\n        }\n\n        console.log();\n        console.log(chalk.cyan('Next: ') + chalk.white('kg stats') + chalk.gray(' to view graph statistics'));\n        console.log();\n\n      } catch (error) {\n        spinner.fail('Failed to generate knowledge graph');\n        console.error(chalk.red(String(error)));\n        process.exit(1);\n      }\n    });\n\n  // Add subcommands\n  command\n    .command('analyze')\n    .description('Analyze graph structure and suggest improvements')\n    .option('-p, --path <path>', 'Project root path', '.')\n    .action(async (options) => {\n      const spinner = ora('Analyzing graph...').start();\n\n      try {\n        const projectRoot = validateProjectRoot(options.path);\n        const dbPath = join(projectRoot, '.kg', 'knowledge.db');\n\n        if (!existsSync(dbPath)) {\n          spinner.fail('Knowledge graph not found. Run \"kg graph\" first.');\n          process.exit(1);\n        }\n\n        const { createDatabase } = await import('../../core/database.js');\n        const db = createDatabase(dbPath);\n\n        const stats = db.getStats();\n        spinner.succeed('Graph analysis complete!');\n\n        console.log();\n        console.log(chalk.white('  Graph Health:'));\n\n        // Orphan analysis\n        if (stats.orphanNodes > 0) {\n          console.log(chalk.yellow(`    ⚠ ${stats.orphanNodes} orphan nodes (no links)`));\n        } else {\n          console.log(chalk.green('    ✓ No orphan nodes'));\n        }\n\n        // Connection density\n        const density = stats.avgLinksPerNode;\n        if (density < 1) {\n          console.log(chalk.yellow(`    ⚠ Low link density (${density} avg links/node)`));\n        } else {\n          console.log(chalk.green(`    ✓ Good link density (${density} avg links/node)`));\n        }\n\n        // Most connected nodes\n        if (stats.mostConnected.length > 0) {\n          console.log();\n          console.log(chalk.white('  Most Connected:'));\n          stats.mostConnected.forEach(({ id, connections }) => {\n            console.log(chalk.gray(`    ${id}: ${connections} connections`));\n          });\n        }\n\n        db.close();\n        console.log();\n\n      } catch (error) {\n        spinner.fail('Analysis failed');\n        console.error(chalk.red(String(error)));\n        process.exit(1);\n      }\n    });\n\n  return command;\n}\n"],"names":[],"mappings":"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"}