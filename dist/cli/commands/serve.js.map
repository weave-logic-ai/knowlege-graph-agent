{"version":3,"file":"serve.js","sources":["../../../src/cli/commands/serve.ts"],"sourcesContent":["/**\n * Serve Command\n *\n * CLI command for running all Knowledge Graph Agent services concurrently.\n * Supports MCP server (stdio), GraphQL server (HTTP), and web dashboard.\n *\n * @module cli/commands/serve\n */\n\nimport { Command } from 'commander';\nimport chalk from 'chalk';\nimport ora from 'ora';\nimport { join } from 'path';\nimport { existsSync } from 'fs';\nimport {\n  ServerManager,\n  createServerManager,\n  createDefaultConfig,\n  DEFAULT_GRAPHQL_PORT,\n  DEFAULT_DASHBOARD_PORT,\n  DEFAULT_DATABASE_PATH,\n} from '../../server/index.js';\nimport type {\n  ServerConfig,\n  ServeCommandOptions,\n  ParsedServeOptions,\n  ServerEventType,\n} from '../../server/types.js';\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\n/**\n * Parse and validate serve command options\n */\nfunction parseOptions(options: ServeCommandOptions, projectRoot: string): ParsedServeOptions {\n  // Determine which servers to enable\n  let mcp = options.mcp ?? false;\n  let graphql = options.graphql ?? false;\n  let dashboard = options.dashboard ?? false;\n\n  // --all enables everything\n  if (options.all) {\n    mcp = true;\n    graphql = true;\n    dashboard = true;\n  }\n\n  // If no specific servers selected, default to MCP only\n  if (!mcp && !graphql && !dashboard) {\n    mcp = true;\n  }\n\n  // Parse ports\n  const graphqlPort =\n    typeof options.portGraphql === 'string'\n      ? parseInt(options.portGraphql, 10)\n      : options.portGraphql ?? DEFAULT_GRAPHQL_PORT;\n\n  const dashboardPort =\n    typeof options.portDashboard === 'string'\n      ? parseInt(options.portDashboard, 10)\n      : options.portDashboard ?? DEFAULT_DASHBOARD_PORT;\n\n  // Validate ports\n  if (graphql && (isNaN(graphqlPort) || graphqlPort < 1 || graphqlPort > 65535)) {\n    throw new Error(`Invalid GraphQL port: ${options.portGraphql}`);\n  }\n\n  if (dashboard && (isNaN(dashboardPort) || dashboardPort < 1 || dashboardPort > 65535)) {\n    throw new Error(`Invalid Dashboard port: ${options.portDashboard}`);\n  }\n\n  // Check for port conflicts\n  if (graphql && dashboard && graphqlPort === dashboardPort) {\n    throw new Error(`GraphQL and Dashboard cannot use the same port (${graphqlPort})`);\n  }\n\n  // Database path\n  const databasePath = options.db\n    ? join(projectRoot, options.db)\n    : join(projectRoot, DEFAULT_DATABASE_PATH);\n\n  return {\n    mcp,\n    graphql,\n    dashboard,\n    graphqlPort,\n    dashboardPort,\n    databasePath,\n    verbose: options.verbose ?? false,\n  };\n}\n\n/**\n * Build server configuration from parsed options\n */\nfunction buildConfig(options: ParsedServeOptions, projectRoot: string): ServerConfig {\n  const defaultConfig = createDefaultConfig(projectRoot);\n\n  return {\n    ...defaultConfig,\n    projectRoot,\n    mcp: {\n      ...defaultConfig.mcp,\n      enabled: options.mcp,\n    },\n    graphql: {\n      ...defaultConfig.graphql,\n      enabled: options.graphql,\n      port: options.graphqlPort,\n    },\n    dashboard: {\n      ...defaultConfig.dashboard,\n      enabled: options.dashboard,\n      port: options.dashboardPort,\n    },\n    database: {\n      ...defaultConfig.database,\n      path: options.databasePath,\n    },\n    verbose: options.verbose,\n  };\n}\n\n/**\n * Display server status summary\n */\nfunction displayStatus(config: ServerConfig): void {\n  console.log(chalk.cyan.bold('\\n  Knowledge Graph Agent Servers\\n'));\n\n  // MCP status\n  const mcpStatus = config.mcp.enabled ? chalk.green('enabled') : chalk.gray('disabled');\n  console.log(`  ${chalk.white('MCP Server:')}     ${mcpStatus}`);\n  if (config.mcp.enabled) {\n    console.log(chalk.gray('                  Transport: stdio'));\n  }\n\n  // GraphQL status\n  const graphqlStatus = config.graphql.enabled ? chalk.green('enabled') : chalk.gray('disabled');\n  console.log(`  ${chalk.white('GraphQL Server:')} ${graphqlStatus}`);\n  if (config.graphql.enabled) {\n    console.log(chalk.gray(`                  Port: ${config.graphql.port}`));\n    console.log(chalk.gray(`                  URL: http://localhost:${config.graphql.port}/graphql`));\n  }\n\n  // Dashboard status\n  const dashboardStatus = config.dashboard.enabled ? chalk.green('enabled') : chalk.gray('disabled');\n  console.log(`  ${chalk.white('Dashboard:')}      ${dashboardStatus}`);\n  if (config.dashboard.enabled) {\n    console.log(chalk.gray(`                  Port: ${config.dashboard.port}`));\n    console.log(chalk.gray(`                  URL: http://localhost:${config.dashboard.port}`));\n  }\n\n  console.log();\n  console.log(chalk.gray(`  Database: ${config.database.path}`));\n  console.log();\n}\n\n/**\n * Display help for combining MCP with HTTP servers\n */\nfunction displayMCPWarning(): void {\n  console.log(chalk.yellow.bold('\\n  Note: MCP + HTTP Servers'));\n  console.log(chalk.gray('  When running MCP server with GraphQL/Dashboard:'));\n  console.log(chalk.gray('  - MCP server uses stdio (standard input/output)'));\n  console.log(chalk.gray('  - HTTP servers will run on their configured ports'));\n  console.log(chalk.gray('  - The process will remain active until terminated'));\n  console.log();\n}\n\n// ============================================================================\n// Signal Handlers\n// ============================================================================\n\n/**\n * Setup graceful shutdown handlers\n */\nfunction setupSignalHandlers(manager: ServerManager): void {\n  let shutdownInitiated = false;\n\n  const shutdown = async (signal: string): Promise<void> => {\n    if (shutdownInitiated) {\n      console.log(chalk.yellow('\\n  Shutdown already in progress...'));\n      return;\n    }\n\n    shutdownInitiated = true;\n    console.log(chalk.cyan(`\\n  Received ${signal}, shutting down gracefully...`));\n\n    try {\n      await manager.gracefulShutdown();\n      console.log(chalk.green('  Shutdown complete'));\n      process.exit(0);\n    } catch (error) {\n      console.error(chalk.red('  Shutdown error:'), String(error));\n      process.exit(1);\n    }\n  };\n\n  process.on('SIGINT', () => shutdown('SIGINT'));\n  process.on('SIGTERM', () => shutdown('SIGTERM'));\n\n  // Handle uncaught errors\n  process.on('uncaughtException', async (error) => {\n    console.error(chalk.red('\\n  Uncaught exception:'), error.message);\n    await shutdown('uncaughtException');\n  });\n\n  process.on('unhandledRejection', async (reason) => {\n    console.error(\n      chalk.red('\\n  Unhandled rejection:'),\n      reason instanceof Error ? reason.message : String(reason)\n    );\n    await shutdown('unhandledRejection');\n  });\n}\n\n// ============================================================================\n// Command Implementation\n// ============================================================================\n\n/**\n * Create the serve command\n */\nexport function createServeCommand(): Command {\n  const serve = new Command('serve')\n    .description('Run Knowledge Graph Agent servers')\n    .addHelpText(\n      'after',\n      `\nExamples:\n  $ kg serve                      # Start MCP server only (default)\n  $ kg serve --graphql            # Start GraphQL server on port 4000\n  $ kg serve --dashboard          # Start Dashboard on port 3000\n  $ kg serve --all                # Start all servers\n  $ kg serve --mcp --graphql      # Start MCP and GraphQL servers\n\n  # Custom ports\n  $ kg serve --graphql --port-graphql 8080\n  $ kg serve --dashboard --port-dashboard 8000\n\n  # All servers with custom ports\n  $ kg serve --all --port-graphql 4001 --port-dashboard 3001\n\n  # Custom database location\n  $ kg serve --all --db ./data/knowledge.db\n\nNotes:\n  - MCP server uses stdio transport (for Claude Desktop integration)\n  - GraphQL and Dashboard use HTTP on their respective ports\n  - When running MCP with HTTP servers, the process stays active\n  - Use Ctrl+C to gracefully shutdown all servers\n`\n    )\n    .option('--mcp', 'Enable MCP server (stdio transport)')\n    .option('--graphql', 'Enable GraphQL server')\n    .option('--dashboard', 'Enable web dashboard')\n    .option('--port-graphql <port>', `GraphQL server port (default: ${DEFAULT_GRAPHQL_PORT})`)\n    .option('--port-dashboard <port>', `Dashboard server port (default: ${DEFAULT_DASHBOARD_PORT})`)\n    .option('--all', 'Enable all servers')\n    .option('--db <path>', 'Database file path (relative to project root)')\n    .option('-v, --verbose', 'Enable verbose logging')\n    .action(async (options: ServeCommandOptions) => {\n      const projectRoot = process.cwd();\n      const spinner = ora('Initializing servers...').start();\n\n      try {\n        // Check for .kg directory or initialize\n        const kgDir = join(projectRoot, '.kg');\n        if (!existsSync(kgDir)) {\n          spinner.text = 'Creating .kg directory...';\n        }\n\n        // Parse and validate options\n        const parsedOptions = parseOptions(options, projectRoot);\n        const config = buildConfig(parsedOptions, projectRoot);\n\n        // Display configuration\n        spinner.stop();\n        displayStatus(config);\n\n        // Warn about MCP + HTTP combination\n        if (\n          config.mcp.enabled &&\n          (config.graphql.enabled || config.dashboard.enabled)\n        ) {\n          displayMCPWarning();\n        }\n\n        // Create and initialize server manager\n        spinner.start('Starting servers...');\n        const manager = await createServerManager(config);\n\n        // Setup signal handlers for graceful shutdown\n        setupSignalHandlers(manager);\n\n        // Subscribe to events for logging\n        if (parsedOptions.verbose) {\n          const eventTypes: ServerEventType[] = [\n            'server:starting',\n            'server:started',\n            'server:stopping',\n            'server:stopped',\n            'server:error',\n          ];\n\n          for (const eventType of eventTypes) {\n            manager.on(eventType, (event) => {\n              console.log(\n                chalk.gray(`  [${new Date().toISOString()}] ${event.type}`),\n                event.server ? chalk.cyan(`(${event.server})`) : '',\n                event.data ? JSON.stringify(event.data) : ''\n              );\n            });\n          }\n        }\n\n        // Start all enabled servers\n        await manager.startAll();\n\n        spinner.succeed('Servers started successfully');\n\n        // Display running servers info\n        console.log(chalk.cyan.bold('\\n  Running Servers:\\n'));\n\n        if (config.mcp.enabled) {\n          console.log(chalk.green('  [MCP]       '), chalk.gray('Running on stdio'));\n        }\n\n        if (config.graphql.enabled) {\n          console.log(\n            chalk.green('  [GraphQL]   '),\n            chalk.gray(`http://localhost:${config.graphql.port}/graphql`)\n          );\n        }\n\n        if (config.dashboard.enabled) {\n          console.log(\n            chalk.green('  [Dashboard] '),\n            chalk.gray(`http://localhost:${config.dashboard.port}`)\n          );\n        }\n\n        console.log();\n        console.log(chalk.gray('  Press Ctrl+C to stop all servers'));\n        console.log();\n\n        // If only MCP is running, it will handle the event loop via stdio\n        // If HTTP servers are running, they keep the process alive\n        // We need to keep the process alive if only MCP is running\n        if (config.mcp.enabled && !config.graphql.enabled && !config.dashboard.enabled) {\n          // MCP server takes over stdio, so the process stays alive naturally\n          // No additional keep-alive needed\n        }\n      } catch (error) {\n        spinner.fail('Failed to start servers');\n        console.error(chalk.red(`\\n  Error: ${String(error)}`));\n\n        if (options.verbose && error instanceof Error && error.stack) {\n          console.error(chalk.gray('\\n  Stack trace:'));\n          console.error(chalk.gray(`  ${error.stack.split('\\n').join('\\n  ')}`));\n        }\n\n        process.exit(1);\n      }\n    });\n\n  // Add status subcommand\n  serve\n    .command('status')\n    .description('Show status of running servers')\n    .action(async () => {\n      console.log(chalk.cyan.bold('\\n  Server Status\\n'));\n      console.log(chalk.gray('  Status check requires a running server instance.'));\n      console.log(chalk.gray('  When servers are running, use the Dashboard API:'));\n      console.log();\n      console.log(chalk.white('    Dashboard:'), chalk.gray('http://localhost:3000/api/status'));\n      console.log(chalk.white('    Health:   '), chalk.gray('http://localhost:3000/api/health'));\n      console.log();\n    });\n\n  return serve;\n}\n\n// ============================================================================\n// Re-exports\n// ============================================================================\n\nexport {\n  ServerManager,\n  createServerManager,\n  SharedServices,\n  createSharedServices,\n} from '../../server/index.js';\n"],"names":[],"mappings":"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"}