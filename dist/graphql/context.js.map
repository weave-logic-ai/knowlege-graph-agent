{"version":3,"file":"context.js","sources":["../../src/graphql/context.ts"],"sourcesContent":["/**\n * GraphQL Request Context\n *\n * Provides request-scoped context for GraphQL resolvers including\n * database access, caching, service management, and authentication.\n *\n * @module graphql/context\n */\n\nimport type { IncomingMessage } from 'http';\nimport type { KnowledgeGraphDatabase } from '../core/database.js';\nimport type { AdvancedCache } from '../caching/lru-cache.js';\nimport type { ServiceManager } from '../services/index.js';\nimport { createLogger } from '../utils/index.js';\n\nconst logger = createLogger('graphql-context');\n\n// ============================================================================\n// Types\n// ============================================================================\n\n/**\n * Authentication result from API key validation\n */\nexport interface AuthResult {\n  /** Whether authentication succeeded */\n  authenticated: boolean;\n  /** User or service identifier */\n  userId?: string;\n  /** Permission scopes granted */\n  scopes: string[];\n  /** Error message if authentication failed */\n  error?: string;\n}\n\n/**\n * Request metadata extracted from HTTP request\n */\nexport interface RequestMeta {\n  /** Request ID for tracing */\n  requestId: string;\n  /** Request start timestamp */\n  startTime: number;\n  /** Client IP address */\n  clientIp: string;\n  /** User agent string */\n  userAgent: string;\n  /** Request path */\n  path: string;\n}\n\n/**\n * Request-scoped utilities\n */\nexport interface RequestUtils {\n  /**\n   * Generate a unique ID\n   */\n  generateId(): string;\n\n  /**\n   * Log with request context\n   */\n  log(level: 'debug' | 'info' | 'warn' | 'error', message: string, data?: Record<string, unknown>): void;\n\n  /**\n   * Get elapsed time since request start\n   */\n  getElapsedMs(): number;\n\n  /**\n   * Create a cache key with request-scoped prefix\n   */\n  cacheKey(key: string): string;\n}\n\n/**\n * Service layer interfaces for resolvers\n */\nexport interface Services {\n  /** Knowledge graph database */\n  database: KnowledgeGraphDatabase;\n  /** Request-scoped cache */\n  cache: AdvancedCache<unknown>;\n  /** Service manager for background services */\n  serviceManager: ServiceManager;\n}\n\n/**\n * GraphQL request context provided to all resolvers\n */\nexport interface GraphQLContext {\n  /** Authentication result */\n  auth: AuthResult;\n  /** Request metadata */\n  request: RequestMeta;\n  /** Service layer */\n  services: Services;\n  /** Request-scoped utilities */\n  utils: RequestUtils;\n}\n\n// ============================================================================\n// Context Factory Configuration\n// ============================================================================\n\n/**\n * Configuration for context factory\n */\nexport interface ContextFactoryConfig {\n  /** Knowledge graph database instance */\n  database: KnowledgeGraphDatabase;\n  /** Cache instance */\n  cache: AdvancedCache<unknown>;\n  /** Service manager instance */\n  serviceManager: ServiceManager;\n  /** API key for authentication (optional) */\n  apiKey?: string;\n  /** Whether to require authentication */\n  requireAuth?: boolean;\n  /** Custom authentication function */\n  authenticate?: (token: string | undefined) => AuthResult | Promise<AuthResult>;\n}\n\n// ============================================================================\n// Context Factory\n// ============================================================================\n\n/**\n * Create a context factory function for graphql-yoga\n *\n * @param config - Context factory configuration\n * @returns Function that creates request-scoped context\n *\n * @example\n * ```typescript\n * const contextFactory = createContextFactory({\n *   database,\n *   cache,\n *   serviceManager,\n *   apiKey: process.env.API_KEY,\n *   requireAuth: true,\n * });\n *\n * const yoga = createYoga({\n *   context: contextFactory,\n *   // ... other config\n * });\n * ```\n */\nexport function createContextFactory(\n  config: ContextFactoryConfig\n): (request: { request: Request }) => Promise<GraphQLContext> {\n  const {\n    database,\n    cache,\n    serviceManager,\n    apiKey,\n    requireAuth = false,\n    authenticate,\n  } = config;\n\n  return async ({ request }: { request: Request }): Promise<GraphQLContext> => {\n    const startTime = Date.now();\n    const requestId = generateRequestId();\n\n    // Extract request metadata\n    const requestMeta: RequestMeta = {\n      requestId,\n      startTime,\n      clientIp: extractClientIp(request),\n      userAgent: request.headers.get('user-agent') ?? 'unknown',\n      path: new URL(request.url).pathname,\n    };\n\n    // Authenticate request\n    const authHeader = request.headers.get('authorization');\n    const token = extractBearerToken(authHeader);\n\n    let auth: AuthResult;\n\n    if (authenticate) {\n      // Use custom authentication function\n      auth = await authenticate(token);\n    } else if (apiKey) {\n      // Use simple API key authentication\n      auth = validateApiKey(token, apiKey);\n    } else {\n      // No authentication configured\n      auth = {\n        authenticated: true,\n        scopes: ['read', 'write'],\n      };\n    }\n\n    // Check if authentication is required\n    if (requireAuth && !auth.authenticated) {\n      logger.warn('Unauthenticated request rejected', {\n        requestId,\n        path: requestMeta.path,\n        error: auth.error,\n      });\n    }\n\n    // Create request-scoped utilities\n    const utils: RequestUtils = {\n      generateId: () => generateRequestId(),\n      log: (level, message, data) => {\n        const logData = { ...data, requestId };\n        switch (level) {\n          case 'debug':\n            logger.debug(message, logData);\n            break;\n          case 'info':\n            logger.info(message, logData);\n            break;\n          case 'warn':\n            logger.warn(message, logData);\n            break;\n          case 'error':\n            logger.error(message, undefined, logData);\n            break;\n        }\n      },\n      getElapsedMs: () => Date.now() - startTime,\n      cacheKey: (key) => `req:${requestId}:${key}`,\n    };\n\n    // Create services reference\n    const services: Services = {\n      database,\n      cache,\n      serviceManager,\n    };\n\n    logger.debug('GraphQL context created', {\n      requestId,\n      authenticated: auth.authenticated,\n      scopes: auth.scopes,\n    });\n\n    return {\n      auth,\n      request: requestMeta,\n      services,\n      utils,\n    };\n  };\n}\n\n// ============================================================================\n// Authentication Helpers\n// ============================================================================\n\n/**\n * Extract Bearer token from Authorization header\n */\nfunction extractBearerToken(header: string | null): string | undefined {\n  if (!header) {\n    return undefined;\n  }\n\n  const parts = header.split(' ');\n  if (parts.length !== 2 || parts[0].toLowerCase() !== 'bearer') {\n    return undefined;\n  }\n\n  return parts[1];\n}\n\n/**\n * Validate API key (simple comparison)\n */\nfunction validateApiKey(token: string | undefined, apiKey: string): AuthResult {\n  if (!token) {\n    return {\n      authenticated: false,\n      scopes: [],\n      error: 'No authentication token provided',\n    };\n  }\n\n  // Constant-time comparison to prevent timing attacks\n  if (!constantTimeEqual(token, apiKey)) {\n    return {\n      authenticated: false,\n      scopes: [],\n      error: 'Invalid API key',\n    };\n  }\n\n  return {\n    authenticated: true,\n    userId: 'api-key-user',\n    scopes: ['read', 'write', 'admin'],\n  };\n}\n\n/**\n * Constant-time string comparison to prevent timing attacks\n */\nfunction constantTimeEqual(a: string, b: string): boolean {\n  if (a.length !== b.length) {\n    return false;\n  }\n\n  let result = 0;\n  for (let i = 0; i < a.length; i++) {\n    result |= a.charCodeAt(i) ^ b.charCodeAt(i);\n  }\n\n  return result === 0;\n}\n\n// ============================================================================\n// Request Utilities\n// ============================================================================\n\n/**\n * Generate a unique request ID\n */\nfunction generateRequestId(): string {\n  const timestamp = Date.now().toString(36);\n  const random = Math.random().toString(36).substring(2, 10);\n  return `${timestamp}-${random}`;\n}\n\n/**\n * Extract client IP from request headers\n */\nfunction extractClientIp(request: Request): string {\n  // Check forwarded headers (reverse proxy)\n  const forwarded = request.headers.get('x-forwarded-for');\n  if (forwarded) {\n    const ips = forwarded.split(',').map((ip) => ip.trim());\n    return ips[0] || 'unknown';\n  }\n\n  const realIp = request.headers.get('x-real-ip');\n  if (realIp) {\n    return realIp;\n  }\n\n  return 'unknown';\n}\n\n// ============================================================================\n// Authorization Helpers\n// ============================================================================\n\n/**\n * Check if context has a specific permission scope\n *\n * @param context - GraphQL context\n * @param scope - Required permission scope\n * @returns True if scope is present\n */\nexport function hasScope(context: GraphQLContext, scope: string): boolean {\n  return context.auth.scopes.includes(scope);\n}\n\n/**\n * Require authentication, throwing if not authenticated\n *\n * @param context - GraphQL context\n * @throws Error if not authenticated\n */\nexport function requireAuth(context: GraphQLContext): void {\n  if (!context.auth.authenticated) {\n    throw new Error(context.auth.error ?? 'Authentication required');\n  }\n}\n\n/**\n * Require a specific permission scope, throwing if not present\n *\n * @param context - GraphQL context\n * @param scope - Required permission scope\n * @throws Error if scope is not present\n */\nexport function requireScope(context: GraphQLContext, scope: string): void {\n  requireAuth(context);\n  if (!hasScope(context, scope)) {\n    throw new Error(`Permission denied: requires '${scope}' scope`);\n  }\n}\n\n// ============================================================================\n// Type Guards\n// ============================================================================\n\n/**\n * Type guard to check if value is a valid GraphQL context\n */\nexport function isGraphQLContext(value: unknown): value is GraphQLContext {\n  if (typeof value !== 'object' || value === null) {\n    return false;\n  }\n\n  const obj = value as Record<string, unknown>;\n  return (\n    typeof obj.auth === 'object' &&\n    typeof obj.request === 'object' &&\n    typeof obj.services === 'object' &&\n    typeof obj.utils === 'object'\n  );\n}\n"],"names":["requireAuth"],"mappings":"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"}