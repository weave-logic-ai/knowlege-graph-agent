{"version":3,"file":"server.js","sources":["../../src/mcp-server/server.ts"],"sourcesContent":["/**\n * Knowledge Graph MCP Server\n *\n * Main MCP server implementation for exposing knowledge graph functionality\n * to Claude Desktop and other MCP clients.\n *\n * @module mcp-server/server\n */\n\nimport { Server } from '@modelcontextprotocol/sdk/server/index.js';\nimport { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';\nimport {\n  CallToolRequestSchema,\n  ListToolsRequestSchema,\n  ErrorCode,\n  McpError,\n} from '@modelcontextprotocol/sdk/types.js';\nimport { createLogger } from '../utils/index.js';\nimport { getToolDefinitions, initializeTools, getToolCount } from './tools/registry.js';\nimport { handleToolCall } from './handlers/index.js';\nimport type { MCPServerConfig, ServerHealth } from './types/index.js';\nimport type { KnowledgeGraphDatabase } from '../core/database.js';\nimport type { ShadowCache } from '../core/cache.js';\n\nconst logger = createLogger('mcp-server');\n\n/**\n * Generate a unique error reference ID for log correlation\n * @returns A unique error reference ID\n */\nfunction generateErrorRefId(): string {\n  const timestamp = Date.now().toString(36);\n  const random = Math.random().toString(36).substring(2, 8);\n  return `ERR-${timestamp}-${random}`.toUpperCase();\n}\n\n/**\n * Default server configuration\n */\nconst DEFAULT_CONFIG: MCPServerConfig = {\n  name: 'knowledge-graph-mcp-server',\n  version: '0.3.0',\n  capabilities: {\n    tools: {},\n  },\n};\n\n/**\n * Knowledge Graph MCP Server\n *\n * Provides MCP protocol implementation for knowledge graph operations.\n * Supports tool listing and execution over stdio transport.\n *\n * @example\n * ```typescript\n * const server = new KnowledgeGraphMCPServer();\n * await server.run();\n * ```\n */\nexport class KnowledgeGraphMCPServer {\n  private server: Server;\n  private isRunning: boolean = false;\n  private startTime: number = 0;\n  private requestCount: number = 0;\n  private config: MCPServerConfig;\n\n  // Rate limiting - tracks request counts per minute\n  private requestCounts: Map<number, number> = new Map();\n  private readonly MAX_REQUESTS_PER_MINUTE = 100;\n\n  private database?: KnowledgeGraphDatabase;\n  private cache?: ShadowCache;\n  private projectRoot?: string;\n\n  /**\n   * Create new MCP server instance\n   *\n   * @param config - Server configuration\n   * @param database - Knowledge graph database instance\n   * @param cache - Shadow cache instance\n   * @param projectRoot - Project root path\n   */\n  constructor(\n    config?: Partial<MCPServerConfig>,\n    database?: KnowledgeGraphDatabase,\n    cache?: ShadowCache,\n    projectRoot?: string\n  ) {\n    this.database = database;\n    this.cache = cache;\n    this.projectRoot = projectRoot;\n\n    // Merge with default config\n    this.config = {\n      name: config?.name || DEFAULT_CONFIG.name,\n      version: config?.version || DEFAULT_CONFIG.version,\n      capabilities: {\n        ...DEFAULT_CONFIG.capabilities,\n        ...config?.capabilities,\n      },\n    };\n\n    // Create MCP server instance\n    this.server = new Server(\n      {\n        name: this.config.name,\n        version: this.config.version,\n      },\n      {\n        capabilities: this.config.capabilities,\n      }\n    );\n\n    // Setup request handlers\n    this.setupHandlers();\n\n    logger.info('KnowledgeGraphMCPServer initialized', {\n      name: this.config.name,\n      version: this.config.version,\n    });\n  }\n\n  /**\n   * Check rate limit and throw if exceeded\n   *\n   * Implements a fixed-window rate limit of MAX_REQUESTS_PER_MINUTE per minute.\n   * Cleans up old entries to prevent memory leaks.\n   *\n   * @throws McpError if rate limit is exceeded\n   */\n  private checkRateLimit(): void {\n    const now = Math.floor(Date.now() / 60000); // Current minute\n    const count = (this.requestCounts.get(now) || 0) + 1;\n\n    // Clean old entries to prevent memory leaks\n    for (const key of this.requestCounts.keys()) {\n      if (key < now - 1) this.requestCounts.delete(key);\n    }\n\n    if (count > this.MAX_REQUESTS_PER_MINUTE) {\n      logger.warn('Rate limit exceeded', { requestsThisMinute: count - 1 });\n      throw new McpError(\n        ErrorCode.InvalidRequest,\n        'Rate limit exceeded. Please slow down.'\n      );\n    }\n\n    this.requestCounts.set(now, count);\n  }\n\n  /**\n   * Setup MCP request handlers\n   */\n  private setupHandlers(): void {\n    // Handle ListTools requests\n    this.server.setRequestHandler(ListToolsRequestSchema, async () => {\n      try {\n        const tools = getToolDefinitions();\n        logger.debug(`Listing ${tools.length} tools`);\n        return { tools };\n      } catch (error) {\n        const errorRefId = generateErrorRefId();\n        logger.error(\n          'Failed to list tools',\n          error instanceof Error ? error : new Error(String(error)),\n          { errorRefId }\n        );\n        throw new McpError(\n          ErrorCode.InternalError,\n          `An internal error occurred [${errorRefId}]`\n        );\n      }\n    });\n\n    // Handle CallTool requests\n    this.server.setRequestHandler(CallToolRequestSchema, async (request) => {\n      // Check rate limit before processing\n      this.checkRateLimit();\n\n      this.requestCount++;\n      const toolName = request.params.name;\n\n      try {\n        logger.debug(`Handling tool call: ${toolName}`);\n        return await handleToolCall(request);\n      } catch (error) {\n        // Re-throw MCP errors as they are already sanitized\n        if (error instanceof McpError) {\n          throw error;\n        }\n\n        // Generate error reference for log correlation\n        const errorRefId = generateErrorRefId();\n        logger.error(\n          'Tool execution failed',\n          error instanceof Error ? error : new Error(String(error)),\n          { errorRefId, toolName }\n        );\n\n        // Return sanitized error message with reference ID\n        throw new McpError(\n          ErrorCode.InternalError,\n          `An internal error occurred [${errorRefId}]`\n        );\n      }\n    });\n\n    logger.debug('Request handlers configured');\n  }\n\n  /**\n   * Start the MCP server\n   *\n   * @throws Error if server is already running\n   */\n  async run(): Promise<void> {\n    if (this.isRunning) {\n      throw new Error('Server is already running');\n    }\n\n    try {\n      // Initialize tools with dependencies\n      await initializeTools(this.database, this.cache, this.projectRoot);\n\n      // Create stdio transport\n      const transport = new StdioServerTransport();\n\n      // Connect server to transport\n      await this.server.connect(transport);\n\n      this.isRunning = true;\n      this.startTime = Date.now();\n\n      logger.info('KnowledgeGraphMCPServer running on stdio transport');\n      logger.info('Ready to accept tool requests from MCP clients');\n    } catch (error) {\n      logger.error(\n        'Failed to start MCP server',\n        error instanceof Error ? error : undefined\n      );\n      throw error;\n    }\n  }\n\n  /**\n   * Shutdown the MCP server gracefully\n   */\n  async shutdown(): Promise<void> {\n    if (!this.isRunning) {\n      logger.warn('Server is not running, shutdown skipped');\n      return;\n    }\n\n    try {\n      // Close server connection\n      await this.server.close();\n\n      this.isRunning = false;\n\n      const uptime = Date.now() - this.startTime;\n      logger.info('KnowledgeGraphMCPServer shutdown complete', {\n        uptime: `${(uptime / 1000).toFixed(2)}s`,\n        requestsHandled: this.requestCount,\n      });\n    } catch (error) {\n      logger.error(\n        'Error during shutdown',\n        error instanceof Error ? error : undefined\n      );\n      throw error;\n    }\n  }\n\n  /**\n   * Get server health status\n   *\n   * @returns Health status object\n   */\n  getHealth(): ServerHealth {\n    return {\n      status: this.isRunning ? 'healthy' : 'unhealthy',\n      components: {\n        database: !!this.database,\n        cache: !!this.cache,\n        agents: true, // Agents are always available\n      },\n      uptime: this.isRunning ? Date.now() - this.startTime : 0,\n      requestCount: this.requestCount,\n      toolCount: getToolCount(),\n    };\n  }\n\n  /**\n   * Check if server is currently running\n   *\n   * @returns true if server is running\n   */\n  isServerRunning(): boolean {\n    return this.isRunning;\n  }\n\n  /**\n   * Get server configuration\n   *\n   * @returns Server configuration\n   */\n  getConfig(): MCPServerConfig {\n    return { ...this.config };\n  }\n\n  /**\n   * Get request count\n   *\n   * @returns Number of requests handled\n   */\n  getRequestCount(): number {\n    return this.requestCount;\n  }\n\n  /**\n   * Get server uptime in milliseconds\n   *\n   * @returns Uptime in milliseconds, 0 if not running\n   */\n  getUptime(): number {\n    return this.isRunning ? Date.now() - this.startTime : 0;\n  }\n}\n\n/**\n * Create and start an MCP server\n *\n * Convenience function for creating and running an MCP server in one call.\n *\n * @param config - Server configuration\n * @param database - Knowledge graph database instance\n * @param cache - Shadow cache instance\n * @param projectRoot - Project root path\n * @returns Running MCP server instance\n *\n * @example\n * ```typescript\n * const server = await createMCPServer(\n *   { name: 'my-kg-server' },\n *   database,\n *   cache,\n *   '/my/project'\n * );\n * ```\n */\nexport async function createMCPServer(\n  config?: Partial<MCPServerConfig>,\n  database?: KnowledgeGraphDatabase,\n  cache?: ShadowCache,\n  projectRoot?: string\n): Promise<KnowledgeGraphMCPServer> {\n  const server = new KnowledgeGraphMCPServer(config, database, cache, projectRoot);\n  await server.run();\n  return server;\n}\n\n/**\n * Run MCP server as standalone process\n *\n * Entry point for running the MCP server from command line.\n *\n * @param options - Server options\n */\nexport async function runServer(options?: {\n  config?: Partial<MCPServerConfig>;\n  database?: KnowledgeGraphDatabase;\n  cache?: ShadowCache;\n  projectRoot?: string;\n}): Promise<void> {\n  const server = new KnowledgeGraphMCPServer(\n    options?.config,\n    options?.database,\n    options?.cache,\n    options?.projectRoot\n  );\n\n  // Handle graceful shutdown\n  process.on('SIGINT', async () => {\n    logger.info('Received SIGINT, shutting down...');\n    await server.shutdown();\n    process.exit(0);\n  });\n\n  process.on('SIGTERM', async () => {\n    logger.info('Received SIGTERM, shutting down...');\n    await server.shutdown();\n    process.exit(0);\n  });\n\n  // Handle uncaught errors\n  process.on('uncaughtException', async (error) => {\n    logger.error('Uncaught exception', error);\n    await server.shutdown();\n    process.exit(1);\n  });\n\n  process.on('unhandledRejection', async (reason) => {\n    logger.error(\n      'Unhandled rejection',\n      reason instanceof Error ? reason : undefined\n    );\n    await server.shutdown();\n    process.exit(1);\n  });\n\n  await server.run();\n}\n"],"names":[],"mappings":"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"}