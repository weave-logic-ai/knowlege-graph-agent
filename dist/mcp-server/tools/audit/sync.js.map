{"version":3,"file":"sync.js","sources":["../../../../src/mcp-server/tools/audit/sync.ts"],"sourcesContent":["/**\n * Sync Status Tool\n *\n * MCP tool for checking the syndication status of the audit chain\n * across peer environments.\n *\n * @module mcp-server/tools/audit/sync\n */\n\nimport type { Tool } from '@modelcontextprotocol/sdk/types.js';\nimport type { ToolHandler, ToolResult } from '../../types/index.js';\nimport type { SyndicationService, PeerInfo } from '../../../audit/services/syndication.js';\n\n/**\n * Sync status tool definition\n *\n * Provides visibility into peer synchronization status,\n * including connection state, sync history, and error tracking.\n */\nexport const syncStatusTool: Tool = {\n  name: 'kg_sync_status',\n  description: 'Check the syndication status of the audit chain across peer environments. Shows peer connections, sync history, and error states.',\n  inputSchema: {\n    type: 'object' as const,\n    properties: {\n      peerId: {\n        type: 'string',\n        description: 'Specific peer ID to check status for (optional, returns all peers if not specified)',\n      },\n      detailed: {\n        type: 'boolean',\n        description: 'Include detailed sync metrics and history (default: false)',\n        default: false,\n      },\n    },\n  },\n};\n\n/**\n * Parameters for the sync status tool\n */\nexport interface SyncStatusParams {\n  /** Specific peer ID to check */\n  peerId?: string;\n  /** Include detailed information */\n  detailed?: boolean;\n}\n\n/**\n * Formatted peer status for API response\n */\ninterface FormattedPeerStatus {\n  /** Peer identifier */\n  id: string;\n  /** Network endpoint */\n  endpoint: string;\n  /** Connection status */\n  status: string;\n  /** Last sync timestamp */\n  lastSyncTime: string | null;\n  /** Error count */\n  errorCount: number;\n  /** Last error message */\n  lastError: string | null;\n  /** Detailed metrics (when detailed=true) */\n  metrics?: {\n    eventsReceived: number;\n    eventsSent: number;\n    latency: number | null;\n    lastCheckpointHeight: number | null;\n  };\n}\n\n/**\n * Create sync status handler\n *\n * Factory function that creates a tool handler for checking sync status.\n *\n * @param syndicationService - The syndication service instance\n * @returns Tool handler function\n *\n * @example\n * ```typescript\n * const syndication = createSyndicationService({ auditChain, peers: [...] });\n * const handler = createSyncStatusHandler(syndication);\n *\n * // Get all peers status\n * const result = await handler({ detailed: true });\n *\n * // Get specific peer status\n * const result = await handler({ peerId: 'peer-abc123', detailed: true });\n * ```\n */\nexport function createSyncStatusHandler(syndicationService?: SyndicationService): ToolHandler {\n  return async (params: Record<string, unknown>): Promise<ToolResult> => {\n    const startTime = Date.now();\n    const { peerId, detailed = false } = params as SyncStatusParams;\n\n    try {\n      // Check syndication service availability\n      if (!syndicationService) {\n        return {\n          success: false,\n          error: 'Syndication service not initialized. Cross-environment sync is not available.',\n          metadata: { executionTime: Date.now() - startTime },\n        };\n      }\n\n      // Format peer info for response\n      const formatPeerInfo = (peer: PeerInfo): FormattedPeerStatus => {\n        const baseInfo: FormattedPeerStatus = {\n          id: peer.id,\n          endpoint: peer.endpoint,\n          status: peer.status,\n          lastSyncTime: peer.lastSyncTime?.toISOString() || null,\n          errorCount: peer.errors,\n          lastError: peer.lastError || null,\n        };\n\n        if (detailed) {\n          baseInfo.metrics = {\n            eventsReceived: peer.eventsReceived,\n            eventsSent: peer.eventsSent,\n            latency: peer.latency ?? null,\n            lastCheckpointHeight: peer.lastCheckpointHeight ?? null,\n          };\n        }\n\n        return baseInfo;\n      };\n\n      // Handle specific peer query\n      if (peerId && typeof peerId === 'string') {\n        const peer = syndicationService.getPeer(peerId);\n\n        if (!peer) {\n          return {\n            success: false,\n            error: `Peer not found: ${peerId}`,\n            metadata: { executionTime: Date.now() - startTime },\n          };\n        }\n\n        return {\n          success: true,\n          data: {\n            peer: formatPeerInfo(peer),\n            serviceStatus: {\n              running: syndicationService.isServiceRunning(),\n              syncing: syndicationService.isSyncing(),\n            },\n          },\n          metadata: {\n            executionTime: Date.now() - startTime,\n          },\n        };\n      }\n\n      // Get all peers status\n      const allPeers = syndicationService.getAllPeers();\n      const stats = syndicationService.getStats();\n\n      const formattedPeers = allPeers.map(formatPeerInfo);\n\n      // Group peers by status\n      const peersByStatus: Record<string, FormattedPeerStatus[]> = {\n        connected: formattedPeers.filter((p) => p.status === 'connected'),\n        syncing: formattedPeers.filter((p) => p.status === 'syncing'),\n        disconnected: formattedPeers.filter((p) => p.status === 'disconnected'),\n        error: formattedPeers.filter((p) => p.status === 'error'),\n      };\n\n      const responseData: Record<string, unknown> = {\n        peers: formattedPeers,\n        peersByStatus,\n        summary: {\n          totalPeers: stats.totalPeers,\n          connectedPeers: stats.connectedPeers,\n          syncingPeers: stats.syncingPeers,\n          errorPeers: stats.errorPeers,\n        },\n        serviceStatus: {\n          running: stats.isRunning,\n          autoSyncEnabled: stats.autoSyncEnabled,\n          syncInterval: stats.syncInterval,\n          syncing: syndicationService.isSyncing(),\n        },\n      };\n\n      // Include aggregate metrics if detailed\n      if (detailed) {\n        responseData.aggregateMetrics = {\n          totalEventsReceived: stats.totalEventsReceived,\n          totalEventsSent: stats.totalEventsSent,\n          totalErrors: stats.totalErrors,\n        };\n      }\n\n      return {\n        success: true,\n        data: responseData,\n        metadata: {\n          executionTime: Date.now() - startTime,\n          itemCount: formattedPeers.length,\n        },\n      };\n    } catch (error) {\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : String(error),\n        metadata: { executionTime: Date.now() - startTime },\n      };\n    }\n  };\n}\n\n/**\n * Trigger a manual sync with all peers\n *\n * Utility function to force an immediate sync operation.\n *\n * @param syndicationService - The syndication service instance\n * @returns Array of sync results\n */\nexport async function triggerManualSync(syndicationService: SyndicationService) {\n  return syndicationService.forceSyncNow();\n}\n"],"names":[],"mappings":"AAmBO,MAAM,iBAAuB;AAAA,EAClC,MAAM;AAAA,EACN,aAAa;AAAA,EACb,aAAa;AAAA,IACX,MAAM;AAAA,IACN,YAAY;AAAA,MACV,QAAQ;AAAA,QACN,MAAM;AAAA,QACN,aAAa;AAAA,MAAA;AAAA,MAEf,UAAU;AAAA,QACR,MAAM;AAAA,QACN,aAAa;AAAA,QACb,SAAS;AAAA,MAAA;AAAA,IACX;AAAA,EACF;AAEJ;AAyDO,SAAS,wBAAwB,oBAAsD;AAC5F,SAAO,OAAO,WAAyD;AACrE,UAAM,YAAY,KAAK,IAAA;AACvB,UAAM,EAAE,QAAQ,WAAW,MAAA,IAAU;AAErC,QAAI;AAEF,UAAI,CAAC,oBAAoB;AACvB,eAAO;AAAA,UACL,SAAS;AAAA,UACT,OAAO;AAAA,UACP,UAAU,EAAE,eAAe,KAAK,IAAA,IAAQ,UAAA;AAAA,QAAU;AAAA,MAEtD;AAGA,YAAM,iBAAiB,CAAC,SAAwC;AAC9D,cAAM,WAAgC;AAAA,UACpC,IAAI,KAAK;AAAA,UACT,UAAU,KAAK;AAAA,UACf,QAAQ,KAAK;AAAA,UACb,cAAc,KAAK,cAAc,YAAA,KAAiB;AAAA,UAClD,YAAY,KAAK;AAAA,UACjB,WAAW,KAAK,aAAa;AAAA,QAAA;AAG/B,YAAI,UAAU;AACZ,mBAAS,UAAU;AAAA,YACjB,gBAAgB,KAAK;AAAA,YACrB,YAAY,KAAK;AAAA,YACjB,SAAS,KAAK,WAAW;AAAA,YACzB,sBAAsB,KAAK,wBAAwB;AAAA,UAAA;AAAA,QAEvD;AAEA,eAAO;AAAA,MACT;AAGA,UAAI,UAAU,OAAO,WAAW,UAAU;AACxC,cAAM,OAAO,mBAAmB,QAAQ,MAAM;AAE9C,YAAI,CAAC,MAAM;AACT,iBAAO;AAAA,YACL,SAAS;AAAA,YACT,OAAO,mBAAmB,MAAM;AAAA,YAChC,UAAU,EAAE,eAAe,KAAK,IAAA,IAAQ,UAAA;AAAA,UAAU;AAAA,QAEtD;AAEA,eAAO;AAAA,UACL,SAAS;AAAA,UACT,MAAM;AAAA,YACJ,MAAM,eAAe,IAAI;AAAA,YACzB,eAAe;AAAA,cACb,SAAS,mBAAmB,iBAAA;AAAA,cAC5B,SAAS,mBAAmB,UAAA;AAAA,YAAU;AAAA,UACxC;AAAA,UAEF,UAAU;AAAA,YACR,eAAe,KAAK,QAAQ;AAAA,UAAA;AAAA,QAC9B;AAAA,MAEJ;AAGA,YAAM,WAAW,mBAAmB,YAAA;AACpC,YAAM,QAAQ,mBAAmB,SAAA;AAEjC,YAAM,iBAAiB,SAAS,IAAI,cAAc;AAGlD,YAAM,gBAAuD;AAAA,QAC3D,WAAW,eAAe,OAAO,CAAC,MAAM,EAAE,WAAW,WAAW;AAAA,QAChE,SAAS,eAAe,OAAO,CAAC,MAAM,EAAE,WAAW,SAAS;AAAA,QAC5D,cAAc,eAAe,OAAO,CAAC,MAAM,EAAE,WAAW,cAAc;AAAA,QACtE,OAAO,eAAe,OAAO,CAAC,MAAM,EAAE,WAAW,OAAO;AAAA,MAAA;AAG1D,YAAM,eAAwC;AAAA,QAC5C,OAAO;AAAA,QACP;AAAA,QACA,SAAS;AAAA,UACP,YAAY,MAAM;AAAA,UAClB,gBAAgB,MAAM;AAAA,UACtB,cAAc,MAAM;AAAA,UACpB,YAAY,MAAM;AAAA,QAAA;AAAA,QAEpB,eAAe;AAAA,UACb,SAAS,MAAM;AAAA,UACf,iBAAiB,MAAM;AAAA,UACvB,cAAc,MAAM;AAAA,UACpB,SAAS,mBAAmB,UAAA;AAAA,QAAU;AAAA,MACxC;AAIF,UAAI,UAAU;AACZ,qBAAa,mBAAmB;AAAA,UAC9B,qBAAqB,MAAM;AAAA,UAC3B,iBAAiB,MAAM;AAAA,UACvB,aAAa,MAAM;AAAA,QAAA;AAAA,MAEvB;AAEA,aAAO;AAAA,QACL,SAAS;AAAA,QACT,MAAM;AAAA,QACN,UAAU;AAAA,UACR,eAAe,KAAK,IAAA,IAAQ;AAAA,UAC5B,WAAW,eAAe;AAAA,QAAA;AAAA,MAC5B;AAAA,IAEJ,SAAS,OAAO;AACd,aAAO;AAAA,QACL,SAAS;AAAA,QACT,OAAO,iBAAiB,QAAQ,MAAM,UAAU,OAAO,KAAK;AAAA,QAC5D,UAAU,EAAE,eAAe,KAAK,IAAA,IAAQ,UAAA;AAAA,MAAU;AAAA,IAEtD;AAAA,EACF;AACF;"}