{"version":3,"file":"list.js","sources":["../../../../src/mcp-server/tools/workflow/list.ts"],"sourcesContent":["/**\n * Workflow List Tool\n *\n * MCP tool for listing all active workflows with filtering\n * and sorting capabilities.\n *\n * @module mcp-server/tools/workflow/list\n */\n\nimport type { Tool } from '@modelcontextprotocol/sdk/types.js';\nimport type { ToolHandler, ToolResult } from '../../types/index.js';\nimport {\n  createWorkflowService,\n  type WorkflowService,\n  type WorkflowRunMetadata,\n} from '../../../workflow/index.js';\n\n/** Singleton workflow service instance */\nlet workflowServiceInstance: WorkflowService | undefined;\n\n/**\n * Get or create the workflow service instance\n *\n * @returns WorkflowService instance\n */\nfunction getWorkflowService(): WorkflowService {\n  if (!workflowServiceInstance) {\n    workflowServiceInstance = createWorkflowService();\n  }\n  return workflowServiceInstance;\n}\n\n/**\n * Workflow list tool definition\n *\n * Defines the MCP tool interface for listing workflows.\n * Supports filtering by status and type with pagination.\n */\nexport const workflowListTool: Tool = {\n  name: 'kg_workflow_list',\n  description: 'List all active workflows with optional filtering',\n  inputSchema: {\n    type: 'object' as const,\n    properties: {\n      status: {\n        type: 'string',\n        description: 'Filter by workflow status',\n        enum: ['running', 'completed', 'failed', 'suspended', 'all'],\n      },\n      type: {\n        type: 'string',\n        description: 'Filter by workflow type',\n        enum: ['realtime-collab', 'analysis', 'sync', 'custom', 'all'],\n      },\n      limit: {\n        type: 'number',\n        description: 'Maximum number of workflows to return',\n        default: 50,\n      },\n      offset: {\n        type: 'number',\n        description: 'Number of workflows to skip (for pagination)',\n        default: 0,\n      },\n      sortBy: {\n        type: 'string',\n        description: 'Field to sort by',\n        enum: ['startedAt', 'lastEventAt', 'status', 'type'],\n        default: 'startedAt',\n      },\n      sortOrder: {\n        type: 'string',\n        description: 'Sort order',\n        enum: ['asc', 'desc'],\n        default: 'desc',\n      },\n    },\n  },\n};\n\n/**\n * Workflow filter options\n */\ninterface WorkflowFilterOptions {\n  status?: string;\n  type?: string;\n  limit?: number;\n  offset?: number;\n  sortBy?: string;\n  sortOrder?: 'asc' | 'desc';\n}\n\n/**\n * Extended workflow info with computed fields\n */\ninterface WorkflowInfo {\n  /** Unique run identifier */\n  id: string;\n  /** Type of workflow being executed */\n  type: string;\n  /** Timestamp when the workflow started */\n  startedAt: Date;\n  /** Current status of the workflow */\n  status: 'running' | 'completed' | 'failed' | 'suspended';\n  /** ID of the currently executing step */\n  currentStep?: string;\n  /** Timestamp of the last event in this workflow */\n  lastEventAt?: Date;\n  /** Computed duration in milliseconds */\n  duration?: number;\n  /** Whether workflow is currently active */\n  isActive: boolean;\n}\n\n/**\n * Filter workflows based on provided options\n *\n * @param workflows - Array of workflow metadata\n * @param options - Filter options\n * @returns Filtered array of workflows\n */\nfunction filterWorkflows(\n  workflows: WorkflowRunMetadata[],\n  options: WorkflowFilterOptions\n): WorkflowInfo[] {\n  let filtered: WorkflowInfo[] = workflows.map(w => ({\n    id: w.id,\n    type: w.type,\n    startedAt: w.startedAt,\n    status: w.status,\n    currentStep: w.currentStep,\n    lastEventAt: w.lastEventAt,\n    duration: w.lastEventAt\n      ? w.lastEventAt.getTime() - w.startedAt.getTime()\n      : Date.now() - w.startedAt.getTime(),\n    isActive: w.status === 'running' || w.status === 'suspended',\n  }));\n\n  // Filter by status\n  if (options.status && options.status !== 'all') {\n    filtered = filtered.filter(w => w.status === options.status);\n  }\n\n  // Filter by type\n  if (options.type && options.type !== 'all') {\n    filtered = filtered.filter(w => w.type === options.type);\n  }\n\n  // Sort\n  const sortBy = options.sortBy || 'startedAt';\n  const sortOrder = options.sortOrder || 'desc';\n  const multiplier = sortOrder === 'desc' ? -1 : 1;\n\n  filtered.sort((a, b) => {\n    let aVal: string | number | Date;\n    let bVal: string | number | Date;\n\n    switch (sortBy) {\n      case 'startedAt':\n        aVal = a.startedAt.getTime();\n        bVal = b.startedAt.getTime();\n        break;\n      case 'lastEventAt':\n        aVal = a.lastEventAt?.getTime() || 0;\n        bVal = b.lastEventAt?.getTime() || 0;\n        break;\n      case 'status':\n        aVal = a.status;\n        bVal = b.status;\n        break;\n      case 'type':\n        aVal = a.type;\n        bVal = b.type;\n        break;\n      default:\n        aVal = a.startedAt.getTime();\n        bVal = b.startedAt.getTime();\n    }\n\n    if (aVal < bVal) return -1 * multiplier;\n    if (aVal > bVal) return 1 * multiplier;\n    return 0;\n  });\n\n  return filtered;\n}\n\n/**\n * Create handler for workflow list tool\n *\n * Creates an async handler that lists all workflows with\n * optional filtering, sorting, and pagination.\n *\n * @returns ToolHandler function for listing workflows\n *\n * @example\n * ```typescript\n * const handler = createWorkflowListHandler();\n *\n * // List all running workflows\n * const running = await handler({ status: 'running' });\n *\n * // List with pagination\n * const page2 = await handler({ limit: 10, offset: 10 });\n *\n * // List sorted by type\n * const byType = await handler({ sortBy: 'type', sortOrder: 'asc' });\n * ```\n */\nexport function createWorkflowListHandler(): ToolHandler {\n  return async (params): Promise<ToolResult> => {\n    const startTime = Date.now();\n    const {\n      status = 'all',\n      type = 'all',\n      limit = 50,\n      offset = 0,\n      sortBy = 'startedAt',\n      sortOrder = 'desc',\n    } = params || {};\n\n    try {\n      const service = getWorkflowService();\n      const serviceStatus = service.getStatus();\n\n      // Get all active workflows\n      const allWorkflows = serviceStatus.activeWorkflows;\n\n      // Apply filters\n      const filteredWorkflows = filterWorkflows(allWorkflows, {\n        status: status as string,\n        type: type as string,\n        sortBy: sortBy as string,\n        sortOrder: sortOrder as 'asc' | 'desc',\n      });\n\n      // Apply pagination\n      const numLimit = typeof limit === 'number' ? limit : 50;\n      const numOffset = typeof offset === 'number' ? offset : 0;\n      const paginatedWorkflows = filteredWorkflows.slice(\n        numOffset,\n        numOffset + numLimit\n      );\n\n      // Compute summary statistics\n      const summary = {\n        total: allWorkflows.length,\n        filtered: filteredWorkflows.length,\n        returned: paginatedWorkflows.length,\n        byStatus: {\n          running: allWorkflows.filter(w => w.status === 'running').length,\n          completed: allWorkflows.filter(w => w.status === 'completed').length,\n          failed: allWorkflows.filter(w => w.status === 'failed').length,\n          suspended: allWorkflows.filter(w => w.status === 'suspended').length,\n        },\n        byType: allWorkflows.reduce((acc, w) => {\n          acc[w.type] = (acc[w.type] || 0) + 1;\n          return acc;\n        }, {} as Record<string, number>),\n      };\n\n      // Format workflow data for response\n      const workflows = paginatedWorkflows.map(w => ({\n        id: w.id,\n        type: w.type,\n        status: w.status,\n        currentStep: w.currentStep,\n        startedAt: w.startedAt.toISOString(),\n        lastEventAt: w.lastEventAt?.toISOString(),\n        duration: w.duration,\n        isActive: w.isActive,\n      }));\n\n      return {\n        success: true,\n        data: {\n          workflows,\n          summary,\n          pagination: {\n            limit: numLimit,\n            offset: numOffset,\n            hasMore: numOffset + numLimit < filteredWorkflows.length,\n            nextOffset: numOffset + numLimit < filteredWorkflows.length\n              ? numOffset + numLimit\n              : null,\n          },\n          serviceStatus: {\n            isRunning: serviceStatus.isRunning,\n            watchedPaths: serviceStatus.watchedPaths.length,\n            lastActivity: serviceStatus.lastActivity?.toISOString(),\n          },\n        },\n        metadata: {\n          executionTime: Date.now() - startTime,\n          filters: {\n            status: status || 'all',\n            type: type || 'all',\n            sortBy: sortBy || 'startedAt',\n            sortOrder: sortOrder || 'desc',\n          },\n          itemCount: workflows.length,\n        },\n      };\n    } catch (error) {\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : String(error),\n        metadata: { executionTime: Date.now() - startTime },\n      };\n    }\n  };\n}\n"],"names":[],"mappings":"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"}