{"version":3,"file":"analyzer.js","sources":["../../../../src/plugins/analyzers/dependency-health/analyzer.ts"],"sourcesContent":["/**\n * Dependency Health Analyzer\n *\n * Core analyzer that combines vulnerability checking, outdated package detection,\n * and npm registry metadata to calculate comprehensive health scores.\n *\n * @module plugins/analyzers/dependency-health/analyzer\n */\n\nimport { exec } from 'child_process';\nimport { promisify } from 'util';\nimport { readFile } from 'fs/promises';\nimport { existsSync } from 'fs';\nimport { join } from 'path';\nimport { createLogger } from '../../../utils/logger.js';\nimport { NpmClient, createNpmClient } from './npm-client.js';\nimport {\n  VulnerabilityChecker,\n  createVulnerabilityChecker,\n  getMaxSeverity,\n} from './vulnerability.js';\nimport type { DependencyInfo } from '../../../cultivation/types.js';\nimport type {\n  DependencyHealthConfig,\n  DependencyHealthScore,\n  DependencyHealthAnalysis,\n  OutdatedPackage,\n  UpdateUrgency,\n  HealthStatus,\n  HealthIssue,\n  VulnerabilityInfo,\n  DEFAULT_CONFIG,\n} from './types.js';\n\nconst execAsync = promisify(exec);\nconst logger = createLogger('dependency-health-analyzer');\n\n/**\n * Parse semver versions for comparison\n */\nfunction parseVersion(version: string): { major: number; minor: number; patch: number } | null {\n  const match = version.match(/^(\\d+)\\.(\\d+)\\.(\\d+)/);\n  if (!match) return null;\n  return {\n    major: parseInt(match[1], 10),\n    minor: parseInt(match[2], 10),\n    patch: parseInt(match[3], 10),\n  };\n}\n\n/**\n * Determine update urgency based on version differences\n */\nfunction calculateUpdateUrgency(current: string, latest: string): UpdateUrgency {\n  const currentV = parseVersion(current);\n  const latestV = parseVersion(latest);\n\n  if (!currentV || !latestV) return 'none';\n\n  if (currentV.major < latestV.major) return 'major';\n  if (currentV.minor < latestV.minor) return 'minor';\n  if (currentV.patch < latestV.patch) return 'patch';\n  return 'none';\n}\n\n/**\n * DependencyHealthAnalyzer class\n */\nexport class DependencyHealthAnalyzer {\n  private projectRoot: string;\n  private config: Required<DependencyHealthConfig>;\n  private npmClient: NpmClient;\n  private vulnChecker: VulnerabilityChecker;\n\n  constructor(projectRoot: string, config: Partial<DependencyHealthConfig> = {}) {\n    this.projectRoot = projectRoot;\n    this.config = {\n      minHealthScore: config.minHealthScore ?? 50,\n      includeDev: config.includeDev ?? true,\n      includePeer: config.includePeer ?? false,\n      includeOptional: config.includeOptional ?? false,\n      skipPackages: config.skipPackages ?? [],\n      vulnerabilitySeverityThreshold: config.vulnerabilitySeverityThreshold ?? 'low',\n      fetchRegistryMetadata: config.fetchRegistryMetadata ?? true,\n      registryUrl: config.registryUrl ?? 'https://registry.npmjs.org',\n      timeout: config.timeout ?? 30000,\n      cacheTtl: config.cacheTtl ?? 3600000,\n      storeInDatabase: config.storeInDatabase ?? true,\n    };\n\n    this.npmClient = createNpmClient(this.config);\n    this.vulnChecker = createVulnerabilityChecker(projectRoot, this.config);\n  }\n\n  /**\n   * Run full dependency health analysis\n   */\n  async analyze(): Promise<DependencyHealthAnalysis> {\n    const startTime = Date.now();\n    const result: DependencyHealthAnalysis = {\n      analyzedAt: new Date().toISOString(),\n      projectRoot: this.projectRoot,\n      packageManager: 'npm',\n      totalDependencies: 0,\n      summary: {\n        vulnerabilities: {\n          critical: 0,\n          high: 0,\n          moderate: 0,\n          low: 0,\n          info: 0,\n          total: 0,\n        },\n        outdated: {\n          major: 0,\n          minor: 0,\n          patch: 0,\n          total: 0,\n        },\n        healthScores: {\n          healthy: 0,\n          warning: 0,\n          critical: 0,\n          unknown: 0,\n        },\n        averageHealthScore: 0,\n      },\n      dependencies: [],\n      nodes: [],\n      edges: [],\n      warnings: [],\n      errors: [],\n      duration: 0,\n    };\n\n    try {\n      logger.info('Starting dependency health analysis', { projectRoot: this.projectRoot });\n\n      // Step 1: Read package.json to get dependencies\n      const dependencies = await this.readDependencies();\n      if (!dependencies) {\n        result.errors.push('Failed to read package.json');\n        result.duration = Date.now() - startTime;\n        return result;\n      }\n\n      result.totalDependencies = dependencies.length;\n      logger.info('Found dependencies', { count: dependencies.length });\n\n      // Step 2: Run vulnerability check\n      const vulnResult = await this.vulnChecker.checkVulnerabilities();\n      if (vulnResult.success) {\n        result.summary.vulnerabilities = vulnResult.summary;\n      } else if (vulnResult.error) {\n        result.warnings.push(`Vulnerability check: ${vulnResult.error}`);\n      }\n\n      // Step 3: Check for outdated packages\n      const outdatedResult = await this.checkOutdated();\n      result.summary.outdated = {\n        major: outdatedResult.filter(p => p.urgency === 'major').length,\n        minor: outdatedResult.filter(p => p.urgency === 'minor').length,\n        patch: outdatedResult.filter(p => p.urgency === 'patch').length,\n        total: outdatedResult.length,\n      };\n\n      // Step 4: Calculate health scores for each dependency\n      const outdatedMap = new Map(outdatedResult.map(p => [p.name, p]));\n\n      for (const dep of dependencies) {\n        // Skip if in skip list\n        if (this.config.skipPackages.includes(dep.name)) {\n          continue;\n        }\n\n        const healthScore = await this.calculateHealthScore(\n          dep,\n          vulnResult.vulnerabilities.get(dep.name) ?? [],\n          outdatedMap.get(dep.name)\n        );\n\n        result.dependencies.push(healthScore);\n\n        // Update health score distribution\n        switch (healthScore.status) {\n          case 'healthy':\n            result.summary.healthScores.healthy++;\n            break;\n          case 'warning':\n            result.summary.healthScores.warning++;\n            break;\n          case 'critical':\n            result.summary.healthScores.critical++;\n            break;\n          default:\n            result.summary.healthScores.unknown++;\n        }\n      }\n\n      // Calculate average health score\n      if (result.dependencies.length > 0) {\n        const totalScore = result.dependencies.reduce((sum, d) => sum + d.overallScore, 0);\n        result.summary.averageHealthScore = Math.round(totalScore / result.dependencies.length);\n      }\n\n      logger.info('Dependency health analysis complete', {\n        dependencies: result.totalDependencies,\n        averageScore: result.summary.averageHealthScore,\n        vulnerable: result.summary.vulnerabilities.total,\n        outdated: result.summary.outdated.total,\n      });\n\n    } catch (error) {\n      logger.error('Analysis failed', error instanceof Error ? error : undefined);\n      result.errors.push(error instanceof Error ? error.message : String(error));\n    }\n\n    result.duration = Date.now() - startTime;\n    return result;\n  }\n\n  /**\n   * Read dependencies from package.json\n   */\n  private async readDependencies(): Promise<DependencyInfo[] | null> {\n    const packageJsonPath = join(this.projectRoot, 'package.json');\n\n    if (!existsSync(packageJsonPath)) {\n      logger.error('package.json not found', undefined, { path: packageJsonPath });\n      return null;\n    }\n\n    try {\n      const content = await readFile(packageJsonPath, 'utf-8');\n      const pkg = JSON.parse(content);\n      const dependencies: DependencyInfo[] = [];\n\n      // Process regular dependencies\n      if (pkg.dependencies) {\n        for (const [name, version] of Object.entries(pkg.dependencies)) {\n          dependencies.push(this.createDependencyInfo(name, version as string, false));\n        }\n      }\n\n      // Process dev dependencies if configured\n      if (this.config.includeDev && pkg.devDependencies) {\n        for (const [name, version] of Object.entries(pkg.devDependencies)) {\n          dependencies.push(this.createDependencyInfo(name, version as string, true));\n        }\n      }\n\n      // Process peer dependencies if configured\n      if (this.config.includePeer && pkg.peerDependencies) {\n        for (const [name, version] of Object.entries(pkg.peerDependencies)) {\n          dependencies.push(this.createDependencyInfo(name, version as string, false));\n        }\n      }\n\n      // Process optional dependencies if configured\n      if (this.config.includeOptional && pkg.optionalDependencies) {\n        for (const [name, version] of Object.entries(pkg.optionalDependencies)) {\n          dependencies.push(this.createDependencyInfo(name, version as string, false));\n        }\n      }\n\n      return dependencies;\n    } catch (error) {\n      logger.error('Failed to read package.json', error instanceof Error ? error : undefined);\n      return null;\n    }\n  }\n\n  /**\n   * Create a DependencyInfo object\n   */\n  private createDependencyInfo(name: string, version: string, isDev: boolean): DependencyInfo {\n    return {\n      name,\n      version: version.replace(/^[\\^~>=<]/, ''),\n      type: 'library',\n      category: 'dependencies',\n      ecosystem: 'nodejs',\n      usedBy: [],\n      relatedTo: [],\n      isDev,\n    };\n  }\n\n  /**\n   * Check for outdated packages using npm outdated\n   */\n  private async checkOutdated(): Promise<OutdatedPackage[]> {\n    const outdated: OutdatedPackage[] = [];\n\n    try {\n      logger.debug('Running npm outdated');\n\n      const { stdout } = await execAsync(\n        'npm outdated --json 2>/dev/null || true',\n        {\n          cwd: this.projectRoot,\n          timeout: this.config.timeout,\n          maxBuffer: 10 * 1024 * 1024,\n        }\n      );\n\n      if (!stdout.trim()) {\n        return outdated;\n      }\n\n      const data = JSON.parse(stdout);\n\n      for (const [name, info] of Object.entries(data)) {\n        const pkgInfo = info as {\n          current?: string;\n          wanted?: string;\n          latest?: string;\n          dependent?: string;\n          type?: string;\n        };\n\n        if (pkgInfo.current && pkgInfo.latest) {\n          const urgency = calculateUpdateUrgency(pkgInfo.current, pkgInfo.latest);\n\n          if (urgency !== 'none') {\n            outdated.push({\n              name,\n              current: pkgInfo.current,\n              wanted: pkgInfo.wanted ?? pkgInfo.current,\n              latest: pkgInfo.latest,\n              isDev: pkgInfo.type === 'devDependencies',\n              dependentType: (pkgInfo.type ?? 'dependencies') as OutdatedPackage['dependentType'],\n              urgency,\n            });\n          }\n        }\n      }\n\n      logger.debug('Outdated check complete', { count: outdated.length });\n    } catch (error) {\n      logger.warn('npm outdated failed', { error: String(error) });\n    }\n\n    return outdated;\n  }\n\n  /**\n   * Calculate health score for a dependency\n   */\n  private async calculateHealthScore(\n    dependency: DependencyInfo,\n    vulnerabilities: VulnerabilityInfo[],\n    outdated?: OutdatedPackage\n  ): Promise<DependencyHealthScore> {\n    const issues: HealthIssue[] = [];\n    const recommendations: string[] = [];\n\n    // Security score based on vulnerabilities\n    let securityScore = 100;\n    if (vulnerabilities.length > 0) {\n      securityScore = this.vulnChecker.calculateSecurityScore(vulnerabilities);\n      const maxSeverity = getMaxSeverity(vulnerabilities.map(v => v.severity));\n\n      issues.push({\n        type: 'vulnerability',\n        severity: maxSeverity === 'critical' || maxSeverity === 'high' ? 'critical' :\n                 maxSeverity === 'moderate' ? 'medium' : 'low',\n        message: `${vulnerabilities.length} security ${vulnerabilities.length === 1 ? 'vulnerability' : 'vulnerabilities'} found`,\n        data: { count: vulnerabilities.length, maxSeverity },\n      });\n\n      recommendations.push('Run npm audit fix to resolve security issues');\n    }\n\n    // Freshness score based on how current the version is\n    let freshnessScore = 100;\n    if (outdated) {\n      switch (outdated.urgency) {\n        case 'major':\n          freshnessScore = 30;\n          issues.push({\n            type: 'outdated',\n            severity: 'high',\n            message: `Major version update available: ${outdated.current} -> ${outdated.latest}`,\n          });\n          recommendations.push(`Update to ${outdated.latest} (breaking changes possible)`);\n          break;\n        case 'minor':\n          freshnessScore = 60;\n          issues.push({\n            type: 'outdated',\n            severity: 'medium',\n            message: `Minor version update available: ${outdated.current} -> ${outdated.latest}`,\n          });\n          recommendations.push(`Update to ${outdated.latest}`);\n          break;\n        case 'patch':\n          freshnessScore = 85;\n          issues.push({\n            type: 'outdated',\n            severity: 'low',\n            message: `Patch update available: ${outdated.current} -> ${outdated.latest}`,\n          });\n          break;\n      }\n    }\n\n    // Maintenance and popularity scores from registry\n    let maintenanceScore = 50;\n    let popularityScore = 50;\n\n    if (this.config.fetchRegistryMetadata) {\n      const quality = await this.npmClient.getQualityMetrics(dependency.name);\n      if (quality) {\n        maintenanceScore = Math.round(quality.maintenance * 100);\n        popularityScore = Math.round(quality.popularity * 100);\n      }\n\n      // Check for deprecation\n      const metadata = await this.npmClient.getPackageMetadata(dependency.name);\n      if (metadata?.deprecated) {\n        maintenanceScore = Math.max(0, maintenanceScore - 40);\n        issues.push({\n          type: 'deprecated',\n          severity: 'high',\n          message: `Package is deprecated: ${metadata.deprecated}`,\n        });\n        recommendations.push('Find an alternative package');\n      }\n    }\n\n    // Calculate overall score (weighted average)\n    const overallScore = Math.round(\n      (securityScore * 0.4) +\n      (freshnessScore * 0.25) +\n      (maintenanceScore * 0.2) +\n      (popularityScore * 0.15)\n    );\n\n    // Determine status\n    let status: HealthStatus = 'healthy';\n    if (overallScore < 30) {\n      status = 'critical';\n    } else if (overallScore < 60) {\n      status = 'warning';\n    } else if (overallScore >= 60) {\n      status = 'healthy';\n    }\n\n    return {\n      name: dependency.name,\n      version: dependency.version,\n      overallScore,\n      status,\n      components: {\n        security: securityScore,\n        freshness: freshnessScore,\n        maintenance: maintenanceScore,\n        popularity: popularityScore,\n      },\n      issues,\n      recommendations,\n    };\n  }\n\n  /**\n   * Get health score for a specific package\n   */\n  async getPackageHealth(packageName: string): Promise<DependencyHealthScore | null> {\n    const dependencies = await this.readDependencies();\n    if (!dependencies) return null;\n\n    const dep = dependencies.find(d => d.name === packageName);\n    if (!dep) return null;\n\n    const vulnResult = await this.vulnChecker.checkVulnerabilities();\n    const outdated = await this.checkOutdated();\n    const outdatedPkg = outdated.find(p => p.name === packageName);\n\n    return this.calculateHealthScore(\n      dep,\n      vulnResult.vulnerabilities.get(packageName) ?? [],\n      outdatedPkg\n    );\n  }\n\n  /**\n   * Get packages below minimum health score threshold\n   */\n  async getUnhealthyPackages(): Promise<DependencyHealthScore[]> {\n    const analysis = await this.analyze();\n    return analysis.dependencies.filter(\n      d => d.overallScore < this.config.minHealthScore\n    );\n  }\n\n  /**\n   * Clear internal caches\n   */\n  clearCache(): void {\n    this.npmClient.clearCache();\n  }\n}\n\n/**\n * Create a dependency health analyzer instance\n */\nexport function createDependencyHealthAnalyzer(\n  projectRoot: string,\n  config?: Partial<DependencyHealthConfig>\n): DependencyHealthAnalyzer {\n  return new DependencyHealthAnalyzer(projectRoot, config);\n}\n"],"names":[],"mappings":"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"}