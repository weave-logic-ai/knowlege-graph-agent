{"version":3,"file":"vulnerability.js","sources":["../../../../src/plugins/analyzers/dependency-health/vulnerability.ts"],"sourcesContent":["/**\n * Vulnerability Checker\n *\n * Checks npm dependencies for known security vulnerabilities\n * by parsing npm audit output and analyzing CVE data.\n *\n * @module plugins/analyzers/dependency-health/vulnerability\n */\n\nimport { exec } from 'child_process';\nimport { promisify } from 'util';\nimport { existsSync } from 'fs';\nimport { join } from 'path';\nimport { createLogger } from '../../../utils/logger.js';\nimport type {\n  AuditReport,\n  AuditFinding,\n  VulnerabilityInfo,\n  VulnerabilitySeverity,\n  DependencyHealthConfig,\n} from './types.js';\n\nconst execAsync = promisify(exec);\nconst logger = createLogger('vulnerability-checker');\n\n/**\n * Result of vulnerability check\n */\nexport interface VulnerabilityCheckResult {\n  /** Whether the check succeeded */\n  success: boolean;\n  /** Raw audit report */\n  report: AuditReport | null;\n  /** Parsed vulnerabilities by package */\n  vulnerabilities: Map<string, VulnerabilityInfo[]>;\n  /** Summary counts */\n  summary: {\n    critical: number;\n    high: number;\n    moderate: number;\n    low: number;\n    info: number;\n    total: number;\n  };\n  /** Error message if check failed */\n  error?: string;\n}\n\n/**\n * Severity order for comparison\n */\nconst SEVERITY_ORDER: Record<VulnerabilitySeverity, number> = {\n  info: 0,\n  low: 1,\n  moderate: 2,\n  high: 3,\n  critical: 4,\n};\n\n/**\n * Check if severity meets threshold\n */\nexport function meetsThreshold(\n  severity: VulnerabilitySeverity,\n  threshold: VulnerabilitySeverity\n): boolean {\n  return SEVERITY_ORDER[severity] >= SEVERITY_ORDER[threshold];\n}\n\n/**\n * Get maximum severity from a list\n */\nexport function getMaxSeverity(\n  severities: VulnerabilitySeverity[]\n): VulnerabilitySeverity {\n  if (severities.length === 0) return 'info';\n\n  let max: VulnerabilitySeverity = 'info';\n  for (const severity of severities) {\n    if (SEVERITY_ORDER[severity] > SEVERITY_ORDER[max]) {\n      max = severity;\n    }\n  }\n  return max;\n}\n\n/**\n * VulnerabilityChecker class\n */\nexport class VulnerabilityChecker {\n  private projectRoot: string;\n  private config: DependencyHealthConfig;\n\n  constructor(projectRoot: string, config: Partial<DependencyHealthConfig> = {}) {\n    this.projectRoot = projectRoot;\n    this.config = {\n      vulnerabilitySeverityThreshold: config.vulnerabilitySeverityThreshold ?? 'low',\n      timeout: config.timeout ?? 60000,\n      ...config,\n    } as DependencyHealthConfig;\n  }\n\n  /**\n   * Run npm audit and parse results\n   */\n  async checkVulnerabilities(): Promise<VulnerabilityCheckResult> {\n    const result: VulnerabilityCheckResult = {\n      success: false,\n      report: null,\n      vulnerabilities: new Map(),\n      summary: {\n        critical: 0,\n        high: 0,\n        moderate: 0,\n        low: 0,\n        info: 0,\n        total: 0,\n      },\n    };\n\n    // Check if package-lock.json exists\n    const lockFilePath = join(this.projectRoot, 'package-lock.json');\n    if (!existsSync(lockFilePath)) {\n      logger.warn('No package-lock.json found, skipping vulnerability check');\n      result.error = 'No package-lock.json found';\n      return result;\n    }\n\n    try {\n      logger.info('Running npm audit', { projectRoot: this.projectRoot });\n\n      // Run npm audit with JSON output\n      // We use --json flag and don't throw on non-zero exit (audit exits non-zero if vulnerabilities found)\n      const { stdout, stderr } = await execAsync(\n        'npm audit --json 2>/dev/null || true',\n        {\n          cwd: this.projectRoot,\n          timeout: this.config.timeout,\n          maxBuffer: 10 * 1024 * 1024, // 10MB buffer for large audits\n        }\n      );\n\n      if (!stdout.trim()) {\n        logger.info('npm audit returned empty result (no vulnerabilities or error)');\n        result.success = true;\n        return result;\n      }\n\n      // Parse the JSON output\n      let auditData: AuditReport;\n      try {\n        auditData = JSON.parse(stdout);\n      } catch (parseError) {\n        logger.error('Failed to parse npm audit output', parseError instanceof Error ? parseError : undefined);\n        result.error = 'Failed to parse npm audit output';\n        return result;\n      }\n\n      result.report = auditData;\n      result.success = true;\n\n      // Extract vulnerability counts from metadata\n      if (auditData.metadata?.vulnerabilities) {\n        result.summary = {\n          critical: auditData.metadata.vulnerabilities.critical ?? 0,\n          high: auditData.metadata.vulnerabilities.high ?? 0,\n          moderate: auditData.metadata.vulnerabilities.moderate ?? 0,\n          low: auditData.metadata.vulnerabilities.low ?? 0,\n          info: auditData.metadata.vulnerabilities.info ?? 0,\n          total: auditData.metadata.vulnerabilities.total ?? 0,\n        };\n      }\n\n      // Parse vulnerabilities by package\n      if (auditData.vulnerabilities) {\n        for (const [packageName, finding] of Object.entries(auditData.vulnerabilities)) {\n          const vulnInfo = this.parseAuditFinding(packageName, finding);\n          if (vulnInfo.length > 0) {\n            result.vulnerabilities.set(packageName, vulnInfo);\n          }\n        }\n      }\n\n      logger.info('Vulnerability check complete', {\n        total: result.summary.total,\n        critical: result.summary.critical,\n        high: result.summary.high,\n        moderate: result.summary.moderate,\n      });\n\n    } catch (error) {\n      logger.error('npm audit failed', error instanceof Error ? error : undefined);\n      result.error = error instanceof Error ? error.message : String(error);\n    }\n\n    return result;\n  }\n\n  /**\n   * Parse an audit finding into vulnerability info\n   */\n  private parseAuditFinding(packageName: string, finding: AuditFinding): VulnerabilityInfo[] {\n    const vulnerabilities: VulnerabilityInfo[] = [];\n\n    // Create a vulnerability entry from the finding\n    const vuln: VulnerabilityInfo = {\n      id: `npm-audit-${packageName}`,\n      title: `Vulnerability in ${packageName}`,\n      severity: finding.severity,\n      vulnerableVersions: finding.range,\n      patchedVersions: this.extractPatchedVersion(finding.fixAvailable),\n      recommendation: this.generateRecommendation(finding),\n      references: [],\n    };\n\n    // Filter by threshold\n    if (meetsThreshold(vuln.severity, this.config.vulnerabilitySeverityThreshold!)) {\n      vulnerabilities.push(vuln);\n    }\n\n    return vulnerabilities;\n  }\n\n  /**\n   * Extract patched version from fix info\n   */\n  private extractPatchedVersion(\n    fixAvailable: boolean | { name: string; version: string; isSemVerMajor: boolean }\n  ): string | null {\n    if (typeof fixAvailable === 'boolean') {\n      return fixAvailable ? 'Fix available' : null;\n    }\n    return `${fixAvailable.name}@${fixAvailable.version}`;\n  }\n\n  /**\n   * Generate recommendation text\n   */\n  private generateRecommendation(finding: AuditFinding): string {\n    if (typeof finding.fixAvailable === 'boolean') {\n      if (finding.fixAvailable) {\n        return `Run 'npm audit fix' to resolve this vulnerability`;\n      }\n      return 'No automatic fix available. Manual intervention required.';\n    }\n\n    const fix = finding.fixAvailable;\n    if (fix.isSemVerMajor) {\n      return `Update to ${fix.name}@${fix.version} (breaking change)`;\n    }\n    return `Update to ${fix.name}@${fix.version}`;\n  }\n\n  /**\n   * Get vulnerabilities for a specific package\n   */\n  async getPackageVulnerabilities(packageName: string): Promise<VulnerabilityInfo[]> {\n    const result = await this.checkVulnerabilities();\n    return result.vulnerabilities.get(packageName) ?? [];\n  }\n\n  /**\n   * Check if a package has critical vulnerabilities\n   */\n  async hasCriticalVulnerabilities(packageName: string): Promise<boolean> {\n    const vulns = await this.getPackageVulnerabilities(packageName);\n    return vulns.some(v => v.severity === 'critical' || v.severity === 'high');\n  }\n\n  /**\n   * Get security score based on vulnerabilities (100 = no vulns, 0 = critical vulns)\n   */\n  calculateSecurityScore(vulnerabilities: VulnerabilityInfo[]): number {\n    if (vulnerabilities.length === 0) {\n      return 100;\n    }\n\n    let score = 100;\n\n    for (const vuln of vulnerabilities) {\n      switch (vuln.severity) {\n        case 'critical':\n          score -= 40;\n          break;\n        case 'high':\n          score -= 25;\n          break;\n        case 'moderate':\n          score -= 10;\n          break;\n        case 'low':\n          score -= 5;\n          break;\n        case 'info':\n          score -= 1;\n          break;\n      }\n    }\n\n    return Math.max(0, score);\n  }\n}\n\n/**\n * Create a vulnerability checker instance\n */\nexport function createVulnerabilityChecker(\n  projectRoot: string,\n  config?: Partial<DependencyHealthConfig>\n): VulnerabilityChecker {\n  return new VulnerabilityChecker(projectRoot, config);\n}\n"],"names":[],"mappings":"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"}