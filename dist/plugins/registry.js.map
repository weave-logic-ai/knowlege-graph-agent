{"version":3,"file":"registry.js","sources":["../../src/plugins/registry.ts"],"sourcesContent":["/**\n * Plugin Registry\n *\n * Manages plugin registration, lifecycle, and hook execution.\n * Provides a centralized store for all loaded plugins with event-based notifications.\n *\n * @module plugins/registry\n */\n\nimport { EventEmitter } from 'events';\nimport { createLogger } from '../utils/index.js';\nimport type {\n  KGPlugin,\n  KGPluginManifest,\n  PluginType,\n  PluginHook,\n  PluginMetadata,\n  PluginStatus,\n  PluginRegistry as IPluginRegistry,\n  PluginRegistryEvents,\n  AnalyzerPlugin,\n} from './types.js';\nimport { isAnalyzerPlugin, createDefaultPluginMetadata } from './types.js';\n\nconst logger = createLogger('plugin-registry');\n\n/**\n * Registered plugin entry\n */\ninterface PluginEntry {\n  /** Plugin instance */\n  plugin: KGPlugin;\n  /** Plugin manifest */\n  manifest: KGPluginManifest;\n  /** Plugin metadata */\n  metadata: PluginMetadata;\n  /** Registration timestamp */\n  registeredAt: number;\n}\n\n/**\n * Plugin compatibility validation result\n */\nexport interface CompatibilityResult {\n  /** Whether the plugin is compatible */\n  compatible: boolean;\n  /** Compatibility issues */\n  issues: string[];\n  /** Missing dependencies */\n  missingDependencies: string[];\n}\n\n/**\n * Plugin Registry implementation\n *\n * Stores and manages registered plugins, handles plugin dependencies,\n * and provides lifecycle hook execution.\n *\n * @example\n * ```typescript\n * const registry = new PluginRegistryImpl({ version: '0.4.0' });\n *\n * // Register a plugin\n * registry.register(myPlugin, manifest);\n *\n * // Execute hooks on all plugins\n * await registry.executeHook('onGraphLoad', graph);\n *\n * // Get plugins by type\n * const analyzers = registry.getByType('analyzer');\n * ```\n */\nexport class AdvancedPluginRegistry implements IPluginRegistry {\n  private plugins: Map<string, PluginEntry> = new Map();\n  private hookSubscribers: Map<PluginHook, Set<string>> = new Map();\n  private eventEmitter: EventEmitter = new EventEmitter();\n  private readonly agentVersion: string;\n\n  constructor(options: { version: string }) {\n    this.agentVersion = options.version;\n  }\n\n  /**\n   * Register a plugin\n   */\n  register(plugin: KGPlugin, manifest: KGPluginManifest): void {\n    const { name, version, type } = plugin;\n\n    // Validate plugin name matches manifest\n    if (name !== manifest.name) {\n      throw new Error(\n        `Plugin name mismatch: plugin reports \"${name}\" but manifest has \"${manifest.name}\"`\n      );\n    }\n\n    // Check for existing registration\n    if (this.plugins.has(name)) {\n      logger.warn('Plugin already registered, replacing', { name });\n      this.unregister(name);\n    }\n\n    // Validate compatibility\n    const compatibility = this.validateCompatibility(manifest);\n    if (!compatibility.compatible) {\n      throw new Error(\n        `Plugin \"${name}\" is not compatible: ${compatibility.issues.join(', ')}`\n      );\n    }\n\n    // Check dependencies\n    if (compatibility.missingDependencies.length > 0) {\n      throw new Error(\n        `Plugin \"${name}\" has missing dependencies: ${compatibility.missingDependencies.join(', ')}`\n      );\n    }\n\n    // Create metadata\n    const metadata: PluginMetadata = {\n      ...createDefaultPluginMetadata(name, version, type),\n      status: 'initialized',\n      hooks: manifest['kg-plugin'].hooks || [],\n      capabilities: (manifest['kg-plugin'].capabilities || []).map(c => c.name),\n    };\n\n    // Register hook subscriptions\n    for (const hook of metadata.hooks) {\n      if (!this.hookSubscribers.has(hook)) {\n        this.hookSubscribers.set(hook, new Set());\n      }\n      this.hookSubscribers.get(hook)!.add(name);\n    }\n\n    // Store the plugin\n    const entry: PluginEntry = {\n      plugin,\n      manifest,\n      metadata,\n      registeredAt: Date.now(),\n    };\n    this.plugins.set(name, entry);\n\n    logger.info('Plugin registered', {\n      name,\n      version,\n      type,\n      hooks: metadata.hooks.length,\n    });\n\n    // Emit registration event\n    this.eventEmitter.emit('registered', { plugin, metadata });\n  }\n\n  /**\n   * Unregister a plugin\n   */\n  unregister(name: string): boolean {\n    const entry = this.plugins.get(name);\n    if (!entry) {\n      return false;\n    }\n\n    // Remove hook subscriptions\n    for (const hook of entry.metadata.hooks) {\n      this.hookSubscribers.get(hook)?.delete(name);\n    }\n\n    // Remove from registry\n    this.plugins.delete(name);\n\n    logger.info('Plugin unregistered', { name });\n\n    // Emit unregistration event\n    this.eventEmitter.emit('unregistered', { name });\n\n    return true;\n  }\n\n  /**\n   * Get a plugin by name\n   */\n  get<T extends KGPlugin = KGPlugin>(name: string): T | undefined {\n    return this.plugins.get(name)?.plugin as T | undefined;\n  }\n\n  /**\n   * Get all registered plugins\n   */\n  getAll(): KGPlugin[] {\n    return Array.from(this.plugins.values()).map(e => e.plugin);\n  }\n\n  /**\n   * Get plugins by type\n   */\n  getByType<T extends KGPlugin = KGPlugin>(type: PluginType): T[] {\n    return Array.from(this.plugins.values())\n      .filter(e => e.plugin.type === type)\n      .map(e => e.plugin as T);\n  }\n\n  /**\n   * Get all analyzer plugins\n   */\n  getAnalyzers(): AnalyzerPlugin[] {\n    return this.getByType<AnalyzerPlugin>('analyzer').filter(isAnalyzerPlugin);\n  }\n\n  /**\n   * Check if a plugin is registered\n   */\n  has(name: string): boolean {\n    return this.plugins.has(name);\n  }\n\n  /**\n   * Get plugin metadata\n   */\n  getMetadata(name: string): PluginMetadata | undefined {\n    return this.plugins.get(name)?.metadata;\n  }\n\n  /**\n   * Enable a plugin\n   */\n  async enable(name: string): Promise<boolean> {\n    const entry = this.plugins.get(name);\n    if (!entry) {\n      logger.warn('Cannot enable unknown plugin', { name });\n      return false;\n    }\n\n    if (entry.metadata.status === 'active') {\n      logger.debug('Plugin already active', { name });\n      return true;\n    }\n\n    entry.metadata.status = 'active';\n    logger.info('Plugin enabled', { name });\n\n    this.eventEmitter.emit('enabled', { name });\n    return true;\n  }\n\n  /**\n   * Disable a plugin\n   */\n  async disable(name: string): Promise<boolean> {\n    const entry = this.plugins.get(name);\n    if (!entry) {\n      logger.warn('Cannot disable unknown plugin', { name });\n      return false;\n    }\n\n    if (entry.metadata.status === 'disabled') {\n      logger.debug('Plugin already disabled', { name });\n      return true;\n    }\n\n    entry.metadata.status = 'disabled';\n    logger.info('Plugin disabled', { name });\n\n    this.eventEmitter.emit('disabled', { name });\n    return true;\n  }\n\n  /**\n   * Execute a lifecycle hook on all applicable plugins\n   */\n  async executeHook<T = void>(\n    hook: PluginHook,\n    ...args: unknown[]\n  ): Promise<Map<string, T | Error>> {\n    const results = new Map<string, T | Error>();\n    const subscribers = this.hookSubscribers.get(hook);\n\n    if (!subscribers || subscribers.size === 0) {\n      return results;\n    }\n\n    const startTime = Date.now();\n    const executedPlugins: string[] = [];\n\n    // Sort by priority (lower = earlier)\n    const sortedSubscribers = Array.from(subscribers)\n      .map(name => {\n        const entry = this.plugins.get(name);\n        return {\n          name,\n          priority: entry?.manifest['kg-plugin'].priority ?? 100,\n        };\n      })\n      .sort((a, b) => a.priority - b.priority);\n\n    for (const { name } of sortedSubscribers) {\n      const entry = this.plugins.get(name);\n      if (!entry) continue;\n\n      // Skip disabled plugins\n      if (entry.metadata.status === 'disabled') {\n        continue;\n      }\n\n      const hookFn = entry.plugin[hook];\n      if (typeof hookFn !== 'function') {\n        continue;\n      }\n\n      try {\n        // Call the hook\n        const result = await (hookFn as (...args: unknown[]) => Promise<T>).call(\n          entry.plugin,\n          ...args\n        );\n        results.set(name, result);\n        executedPlugins.push(name);\n      } catch (error) {\n        const err = error instanceof Error ? error : new Error(String(error));\n        results.set(name, err);\n        entry.metadata.lastError = err.message;\n        entry.metadata.status = 'error';\n\n        logger.error(`Hook execution failed for plugin \"${name}\"`, err, {\n          hook,\n          plugin: name,\n        });\n\n        this.eventEmitter.emit('error', { name, error: err });\n      }\n    }\n\n    const duration = Date.now() - startTime;\n    logger.debug('Hook executed', {\n      hook,\n      plugins: executedPlugins.length,\n      duration,\n    });\n\n    this.eventEmitter.emit('hookExecuted', {\n      hook,\n      plugins: executedPlugins,\n      duration,\n    });\n\n    return results;\n  }\n\n  /**\n   * Get plugins that subscribe to a specific hook\n   */\n  getHookSubscribers(hook: PluginHook): string[] {\n    return Array.from(this.hookSubscribers.get(hook) || []);\n  }\n\n  /**\n   * Get registry statistics\n   */\n  getStats(): {\n    totalPlugins: number;\n    activePlugins: number;\n    disabledPlugins: number;\n    errorPlugins: number;\n    pluginsByType: Record<PluginType, number>;\n    hookSubscriptions: Record<PluginHook, number>;\n  } {\n    const pluginsByType: Partial<Record<PluginType, number>> = {};\n    const hookSubscriptions: Partial<Record<PluginHook, number>> = {};\n\n    let activePlugins = 0;\n    let disabledPlugins = 0;\n    let errorPlugins = 0;\n\n    const pluginEntries = Array.from(this.plugins.values());\n    for (const entry of pluginEntries) {\n      // Count by type\n      const type = entry.plugin.type;\n      pluginsByType[type] = (pluginsByType[type] || 0) + 1;\n\n      // Count by status\n      switch (entry.metadata.status) {\n        case 'active':\n          activePlugins++;\n          break;\n        case 'disabled':\n          disabledPlugins++;\n          break;\n        case 'error':\n          errorPlugins++;\n          break;\n      }\n    }\n\n    // Count hook subscriptions\n    const hookEntries = Array.from(this.hookSubscribers.entries());\n    for (const [hook, subscribers] of hookEntries) {\n      hookSubscriptions[hook] = subscribers.size;\n    }\n\n    return {\n      totalPlugins: this.plugins.size,\n      activePlugins,\n      disabledPlugins,\n      errorPlugins,\n      pluginsByType: pluginsByType as Record<PluginType, number>,\n      hookSubscriptions: hookSubscriptions as Record<PluginHook, number>,\n    };\n  }\n\n  /**\n   * Subscribe to registry events\n   */\n  on<K extends keyof PluginRegistryEvents>(\n    event: K,\n    listener: (data: PluginRegistryEvents[K]) => void\n  ): void {\n    this.eventEmitter.on(event, listener);\n  }\n\n  /**\n   * Unsubscribe from registry events\n   */\n  off<K extends keyof PluginRegistryEvents>(\n    event: K,\n    listener: (data: PluginRegistryEvents[K]) => void\n  ): void {\n    this.eventEmitter.off(event, listener);\n  }\n\n  /**\n   * Clear all registered plugins\n   */\n  async clear(): Promise<void> {\n    // Destroy all plugins\n    const pluginEntries = Array.from(this.plugins.entries());\n    for (const [name, entry] of pluginEntries) {\n      try {\n        if (typeof entry.plugin.destroy === 'function') {\n          await entry.plugin.destroy();\n        }\n      } catch (error) {\n        logger.error(`Failed to destroy plugin \"${name}\"`, error instanceof Error ? error : new Error(String(error)));\n      }\n    }\n\n    this.plugins.clear();\n    this.hookSubscribers.clear();\n\n    logger.info('Registry cleared');\n  }\n\n  /**\n   * Validate plugin compatibility with the current agent version\n   */\n  validateCompatibility(manifest: KGPluginManifest): CompatibilityResult {\n    const issues: string[] = [];\n    const missingDependencies: string[] = [];\n    const kgPlugin = manifest['kg-plugin'];\n\n    // Check minimum version requirement\n    if (kgPlugin.minVersion) {\n      if (!this.satisfiesVersion(this.agentVersion, `>=${kgPlugin.minVersion}`)) {\n        issues.push(\n          `Requires minimum version ${kgPlugin.minVersion}, current: ${this.agentVersion}`\n        );\n      }\n    }\n\n    // Check maximum version requirement\n    if (kgPlugin.maxVersion) {\n      if (!this.satisfiesVersion(this.agentVersion, `<=${kgPlugin.maxVersion}`)) {\n        issues.push(\n          `Requires maximum version ${kgPlugin.maxVersion}, current: ${this.agentVersion}`\n        );\n      }\n    }\n\n    // Check plugin dependencies\n    if (kgPlugin.pluginDependencies) {\n      for (const dep of kgPlugin.pluginDependencies) {\n        if (!this.has(dep.name)) {\n          if (!dep.optional) {\n            missingDependencies.push(dep.name);\n          }\n        } else {\n          // Check version compatibility\n          const depPlugin = this.plugins.get(dep.name);\n          if (depPlugin && !this.satisfiesVersion(depPlugin.plugin.version, dep.version)) {\n            issues.push(\n              `Dependency \"${dep.name}\" version ${depPlugin.plugin.version} does not satisfy ${dep.version}`\n            );\n          }\n        }\n      }\n    }\n\n    return {\n      compatible: issues.length === 0 && missingDependencies.length === 0,\n      issues,\n      missingDependencies,\n    };\n  }\n\n  /**\n   * Check if a plugin has a specific capability\n   */\n  hasCapability(capabilityName: string): boolean {\n    const entries = Array.from(this.plugins.values());\n    for (const entry of entries) {\n      if (entry.metadata.capabilities.includes(capabilityName)) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  /**\n   * Get plugins that provide a specific capability\n   */\n  getByCapability(capabilityName: string): KGPlugin[] {\n    return Array.from(this.plugins.values())\n      .filter(e => e.metadata.capabilities.includes(capabilityName))\n      .map(e => e.plugin);\n  }\n\n  /**\n   * Get the dependency graph for all plugins\n   */\n  getDependencyGraph(): Map<string, string[]> {\n    const graph = new Map<string, string[]>();\n    const pluginEntries = Array.from(this.plugins.entries());\n\n    for (const [name, entry] of pluginEntries) {\n      const deps = entry.manifest['kg-plugin'].pluginDependencies || [];\n      graph.set(\n        name,\n        deps.filter(d => !d.optional).map(d => d.name)\n      );\n    }\n\n    return graph;\n  }\n\n  /**\n   * Check if plugins can be safely unregistered (no dependents)\n   */\n  canUnregister(name: string): { canUnregister: boolean; dependents: string[] } {\n    const dependents: string[] = [];\n    const pluginEntries = Array.from(this.plugins.entries());\n\n    for (const [pluginName, entry] of pluginEntries) {\n      if (pluginName === name) continue;\n\n      const deps = entry.manifest['kg-plugin'].pluginDependencies || [];\n      const hasDep = deps.some(d => d.name === name && !d.optional);\n      if (hasDep) {\n        dependents.push(pluginName);\n      }\n    }\n\n    return {\n      canUnregister: dependents.length === 0,\n      dependents,\n    };\n  }\n\n  /**\n   * Update plugin status\n   */\n  setPluginStatus(name: string, status: PluginStatus): void {\n    const entry = this.plugins.get(name);\n    if (entry) {\n      entry.metadata.status = status;\n    }\n  }\n\n  /**\n   * Simple version comparison\n   * Supports basic semver-like comparisons\n   */\n  private satisfiesVersion(version: string, requirement: string): boolean {\n    // Parse version\n    const parseVersion = (v: string): number[] => {\n      return v.replace(/[^0-9.]/g, '').split('.').map(n => parseInt(n, 10) || 0);\n    };\n\n    const current = parseVersion(version);\n\n    // Handle range requirements\n    if (requirement.startsWith('>=')) {\n      const required = parseVersion(requirement.slice(2));\n      return this.compareVersions(current, required) >= 0;\n    }\n\n    if (requirement.startsWith('<=')) {\n      const required = parseVersion(requirement.slice(2));\n      return this.compareVersions(current, required) <= 0;\n    }\n\n    if (requirement.startsWith('>')) {\n      const required = parseVersion(requirement.slice(1));\n      return this.compareVersions(current, required) > 0;\n    }\n\n    if (requirement.startsWith('<')) {\n      const required = parseVersion(requirement.slice(1));\n      return this.compareVersions(current, required) < 0;\n    }\n\n    if (requirement.startsWith('^')) {\n      const required = parseVersion(requirement.slice(1));\n      // Caret allows changes that do not modify the left-most non-zero digit\n      return current[0] === required[0] && this.compareVersions(current, required) >= 0;\n    }\n\n    if (requirement.startsWith('~')) {\n      const required = parseVersion(requirement.slice(1));\n      // Tilde allows patch-level changes\n      return (\n        current[0] === required[0] &&\n        current[1] === required[1] &&\n        this.compareVersions(current, required) >= 0\n      );\n    }\n\n    // Exact match\n    const required = parseVersion(requirement);\n    return this.compareVersions(current, required) === 0;\n  }\n\n  /**\n   * Compare two version arrays\n   */\n  private compareVersions(a: number[], b: number[]): number {\n    const maxLen = Math.max(a.length, b.length);\n    for (let i = 0; i < maxLen; i++) {\n      const aVal = a[i] || 0;\n      const bVal = b[i] || 0;\n      if (aVal > bVal) return 1;\n      if (aVal < bVal) return -1;\n    }\n    return 0;\n  }\n}\n\n/**\n * Create a new advanced plugin registry\n */\nexport function createAdvancedPluginRegistry(options: { version: string }): AdvancedPluginRegistry {\n  return new AdvancedPluginRegistry(options);\n}\n"],"names":["required"],"mappings":"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"}