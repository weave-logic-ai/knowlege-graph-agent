{"version":3,"file":"manager.js","sources":["../../src/server/manager.ts"],"sourcesContent":["/**\n * Server Manager\n *\n * Orchestrates multiple server instances (MCP, GraphQL, Dashboard) in a single\n * Node.js process. Handles lifecycle management, health monitoring, and\n * graceful shutdown coordination.\n *\n * @module server/manager\n */\n\nimport { EventEmitter } from 'events';\nimport { createServer, Server as HTTPServer } from 'http';\nimport { createLogger } from '../utils/index.js';\nimport { KnowledgeGraphMCPServer } from '../mcp-server/server.js';\nimport { SharedServices, createSharedServices } from './shared-services.js';\nimport type {\n  ServerConfig,\n  IServerManager,\n  ServerManagerState,\n  ServerState,\n  ServerStatus,\n  HealthStatus,\n  ServerEventType,\n  ServerEventListener,\n  ServerEvent,\n  HTTPServerInstance,\n  MCPServerInstance,\n  DEFAULT_GRAPHQL_PORT,\n  DEFAULT_DASHBOARD_PORT,\n  SHUTDOWN_TIMEOUT,\n} from './types.js';\n\nconst logger = createLogger('server-manager');\n\n// ============================================================================\n// Constants\n// ============================================================================\n\nconst GRAPHQL_DEFAULT_PORT = 4000;\nconst DASHBOARD_DEFAULT_PORT = 3000;\nconst SHUTDOWN_TIMEOUT_MS = 10000;\n\n// ============================================================================\n// Server Manager Implementation\n// ============================================================================\n\n/**\n * ServerManager\n *\n * Manages the lifecycle of multiple server instances running concurrently\n * in a single Node.js process. Coordinates shared services and handles\n * graceful shutdown.\n *\n * @example\n * ```typescript\n * const manager = new ServerManager(config);\n * await manager.initialize();\n *\n * // Start servers\n * await manager.startAll();\n *\n * // Handle shutdown\n * process.on('SIGINT', () => manager.gracefulShutdown());\n * ```\n */\nexport class ServerManager implements IServerManager {\n  private config: ServerConfig;\n  private services: SharedServices | null = null;\n  private eventEmitter: EventEmitter;\n\n  // Server instances\n  private mcpServer: MCPServerInstance | null = null;\n  private graphqlServer: HTTPServerInstance | null = null;\n  private dashboardServer: HTTPServerInstance | null = null;\n\n  // State tracking\n  private state: ServerManagerState;\n  private shutdownInProgress: boolean = false;\n  private initPromise: Promise<void> | null = null;\n\n  constructor(config: ServerConfig) {\n    this.config = config;\n    this.eventEmitter = new EventEmitter();\n    this.eventEmitter.setMaxListeners(50);\n\n    // Initialize state\n    this.state = {\n      mcp: this.createInitialServerState(),\n      graphql: this.createInitialServerState(),\n      dashboard: this.createInitialServerState(),\n      overall: 'stopped',\n    };\n\n    logger.debug('ServerManager created', {\n      projectRoot: config.projectRoot,\n      mcpEnabled: config.mcp.enabled,\n      graphqlEnabled: config.graphql.enabled,\n      dashboardEnabled: config.dashboard.enabled,\n    });\n  }\n\n  private createInitialServerState(): ServerState {\n    return {\n      status: 'stopped',\n      requestCount: 0,\n    };\n  }\n\n  // ============================================================================\n  // Initialization\n  // ============================================================================\n\n  /**\n   * Initialize shared services\n   */\n  async initialize(): Promise<void> {\n    if (this.initPromise) {\n      return this.initPromise;\n    }\n\n    if (this.services?.isInitialized()) {\n      return;\n    }\n\n    this.initPromise = this._doInitialize();\n\n    try {\n      await this.initPromise;\n    } finally {\n      this.initPromise = null;\n    }\n  }\n\n  private async _doInitialize(): Promise<void> {\n    logger.info('Initializing ServerManager...');\n\n    try {\n      this.services = await createSharedServices(this.config);\n      this.state.initializedAt = new Date();\n\n      // Forward service events\n      this.services.eventBus.on('service:initialized', (data) => {\n        this.emitEvent({\n          type: 'server:starting',\n          timestamp: new Date(),\n          data,\n        });\n      });\n\n      logger.info('ServerManager initialized');\n    } catch (error) {\n      logger.error(\n        'Failed to initialize ServerManager',\n        error instanceof Error ? error : new Error(String(error))\n      );\n      throw error;\n    }\n  }\n\n  // ============================================================================\n  // MCP Server Management\n  // ============================================================================\n\n  /**\n   * Start the MCP server (stdio transport)\n   */\n  async startMCP(): Promise<void> {\n    if (!this.services) {\n      await this.initialize();\n    }\n\n    if (this.mcpServer) {\n      logger.warn('MCP server already running');\n      return;\n    }\n\n    this.updateServerState('mcp', { status: 'starting' });\n    this.emitEvent({\n      type: 'server:starting',\n      server: 'mcp',\n      timestamp: new Date(),\n    });\n\n    try {\n      logger.info('Starting MCP server...');\n\n      const mcpServer = new KnowledgeGraphMCPServer(\n        {\n          name: this.config.mcp.name,\n          version: this.config.mcp.version,\n        },\n        this.services!.database,\n        this.services!.cache,\n        this.services!.projectRoot\n      );\n\n      await mcpServer.run();\n\n      this.mcpServer = {\n        server: mcpServer,\n        startedAt: new Date(),\n      };\n\n      this.updateServerState('mcp', {\n        status: 'running',\n        startedAt: new Date(),\n      });\n\n      this.emitEvent({\n        type: 'server:started',\n        server: 'mcp',\n        timestamp: new Date(),\n        data: { transport: 'stdio' },\n      });\n\n      logger.info('MCP server started on stdio');\n    } catch (error) {\n      this.updateServerState('mcp', {\n        status: 'error',\n        error: error instanceof Error ? error.message : String(error),\n      });\n\n      this.emitEvent({\n        type: 'server:error',\n        server: 'mcp',\n        timestamp: new Date(),\n        error: error instanceof Error ? error : new Error(String(error)),\n      });\n\n      throw error;\n    }\n\n    this.updateOverallState();\n  }\n\n  /**\n   * Stop the MCP server\n   */\n  async stopMCP(): Promise<void> {\n    if (!this.mcpServer) {\n      logger.debug('MCP server not running');\n      return;\n    }\n\n    this.updateServerState('mcp', { status: 'stopping' });\n    this.emitEvent({\n      type: 'server:stopping',\n      server: 'mcp',\n      timestamp: new Date(),\n    });\n\n    try {\n      await this.mcpServer.server.shutdown();\n      this.mcpServer = null;\n\n      this.updateServerState('mcp', {\n        status: 'stopped',\n        startedAt: undefined,\n      });\n\n      this.emitEvent({\n        type: 'server:stopped',\n        server: 'mcp',\n        timestamp: new Date(),\n      });\n\n      logger.info('MCP server stopped');\n    } catch (error) {\n      logger.error('Error stopping MCP server', error as Error);\n      throw error;\n    }\n\n    this.updateOverallState();\n  }\n\n  // ============================================================================\n  // GraphQL Server Management\n  // ============================================================================\n\n  /**\n   * Start the GraphQL server\n   */\n  async startGraphQL(port?: number): Promise<void> {\n    if (!this.services) {\n      await this.initialize();\n    }\n\n    if (this.graphqlServer) {\n      logger.warn('GraphQL server already running');\n      return;\n    }\n\n    const serverPort = port ?? this.config.graphql.port ?? GRAPHQL_DEFAULT_PORT;\n\n    this.updateServerState('graphql', { status: 'starting' });\n    this.emitEvent({\n      type: 'server:starting',\n      server: 'graphql',\n      timestamp: new Date(),\n      data: { port: serverPort },\n    });\n\n    try {\n      logger.info(`Starting GraphQL server on port ${serverPort}...`);\n\n      const httpServer = await this.createGraphQLServer(serverPort);\n\n      this.graphqlServer = {\n        server: httpServer,\n        port: serverPort,\n        type: 'graphql',\n        startedAt: new Date(),\n      };\n\n      this.updateServerState('graphql', {\n        status: 'running',\n        startedAt: new Date(),\n        port: serverPort,\n      });\n\n      this.emitEvent({\n        type: 'server:started',\n        server: 'graphql',\n        timestamp: new Date(),\n        data: { port: serverPort },\n      });\n\n      logger.info(`GraphQL server started on http://localhost:${serverPort}/graphql`);\n    } catch (error) {\n      this.updateServerState('graphql', {\n        status: 'error',\n        error: error instanceof Error ? error.message : String(error),\n      });\n\n      this.emitEvent({\n        type: 'server:error',\n        server: 'graphql',\n        timestamp: new Date(),\n        error: error instanceof Error ? error : new Error(String(error)),\n      });\n\n      throw error;\n    }\n\n    this.updateOverallState();\n  }\n\n  /**\n   * Create the GraphQL HTTP server\n   * Note: This is a placeholder - actual GraphQL schema would be implemented separately\n   */\n  private async createGraphQLServer(port: number): Promise<HTTPServer> {\n    return new Promise((resolve, reject) => {\n      const server = createServer((req, res) => {\n        // Track requests\n        this.state.graphql.requestCount++;\n\n        // CORS headers\n        res.setHeader('Access-Control-Allow-Origin', '*');\n        res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');\n        res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');\n\n        if (req.method === 'OPTIONS') {\n          res.writeHead(204);\n          res.end();\n          return;\n        }\n\n        // Health check endpoint\n        if (req.url === '/health') {\n          res.writeHead(200, { 'Content-Type': 'application/json' });\n          res.end(JSON.stringify({ status: 'ok', server: 'graphql' }));\n          return;\n        }\n\n        // GraphQL endpoint placeholder\n        if (req.url === '/graphql' || req.url?.startsWith('/graphql?')) {\n          // Note: In production, this would integrate with a GraphQL library\n          // like Apollo Server or graphql-yoga\n          res.writeHead(200, { 'Content-Type': 'application/json' });\n          res.end(\n            JSON.stringify({\n              data: null,\n              errors: [\n                {\n                  message: 'GraphQL server is running. Schema not yet implemented.',\n                  extensions: {\n                    code: 'NOT_IMPLEMENTED',\n                    hint: 'The GraphQL schema will be implemented in a future update.',\n                  },\n                },\n              ],\n            })\n          );\n          return;\n        }\n\n        // 404 for other routes\n        res.writeHead(404, { 'Content-Type': 'application/json' });\n        res.end(JSON.stringify({ error: 'Not found' }));\n      });\n\n      server.on('error', (error: NodeJS.ErrnoException) => {\n        if (error.code === 'EADDRINUSE') {\n          reject(new Error(`Port ${port} is already in use`));\n        } else {\n          reject(error);\n        }\n      });\n\n      server.listen(port, () => {\n        resolve(server);\n      });\n    });\n  }\n\n  /**\n   * Stop the GraphQL server\n   */\n  async stopGraphQL(): Promise<void> {\n    if (!this.graphqlServer) {\n      logger.debug('GraphQL server not running');\n      return;\n    }\n\n    this.updateServerState('graphql', { status: 'stopping' });\n    this.emitEvent({\n      type: 'server:stopping',\n      server: 'graphql',\n      timestamp: new Date(),\n    });\n\n    try {\n      await this.closeHTTPServer(this.graphqlServer.server);\n      this.graphqlServer = null;\n\n      this.updateServerState('graphql', {\n        status: 'stopped',\n        startedAt: undefined,\n        port: undefined,\n      });\n\n      this.emitEvent({\n        type: 'server:stopped',\n        server: 'graphql',\n        timestamp: new Date(),\n      });\n\n      logger.info('GraphQL server stopped');\n    } catch (error) {\n      logger.error('Error stopping GraphQL server', error as Error);\n      throw error;\n    }\n\n    this.updateOverallState();\n  }\n\n  // ============================================================================\n  // Dashboard Server Management\n  // ============================================================================\n\n  /**\n   * Start the Dashboard server\n   */\n  async startDashboard(port?: number): Promise<void> {\n    if (!this.services) {\n      await this.initialize();\n    }\n\n    if (this.dashboardServer) {\n      logger.warn('Dashboard server already running');\n      return;\n    }\n\n    const serverPort = port ?? this.config.dashboard.port ?? DASHBOARD_DEFAULT_PORT;\n\n    this.updateServerState('dashboard', { status: 'starting' });\n    this.emitEvent({\n      type: 'server:starting',\n      server: 'dashboard',\n      timestamp: new Date(),\n      data: { port: serverPort },\n    });\n\n    try {\n      logger.info(`Starting Dashboard server on port ${serverPort}...`);\n\n      const httpServer = await this.createDashboardServer(serverPort);\n\n      this.dashboardServer = {\n        server: httpServer,\n        port: serverPort,\n        type: 'dashboard',\n        startedAt: new Date(),\n      };\n\n      this.updateServerState('dashboard', {\n        status: 'running',\n        startedAt: new Date(),\n        port: serverPort,\n      });\n\n      this.emitEvent({\n        type: 'server:started',\n        server: 'dashboard',\n        timestamp: new Date(),\n        data: { port: serverPort },\n      });\n\n      logger.info(`Dashboard server started on http://localhost:${serverPort}`);\n    } catch (error) {\n      this.updateServerState('dashboard', {\n        status: 'error',\n        error: error instanceof Error ? error.message : String(error),\n      });\n\n      this.emitEvent({\n        type: 'server:error',\n        server: 'dashboard',\n        timestamp: new Date(),\n        error: error instanceof Error ? error : new Error(String(error)),\n      });\n\n      throw error;\n    }\n\n    this.updateOverallState();\n  }\n\n  /**\n   * Create the Dashboard HTTP server\n   * Note: This is a placeholder - actual dashboard would be implemented separately\n   */\n  private async createDashboardServer(port: number): Promise<HTTPServer> {\n    return new Promise((resolve, reject) => {\n      const server = createServer((req, res) => {\n        // Track requests\n        this.state.dashboard.requestCount++;\n\n        // Health check\n        if (req.url === '/api/health') {\n          const health = this.getHealth();\n          res.writeHead(200, { 'Content-Type': 'application/json' });\n          res.end(JSON.stringify(health));\n          return;\n        }\n\n        // Server status API\n        if (req.url === '/api/status') {\n          res.writeHead(200, { 'Content-Type': 'application/json' });\n          res.end(JSON.stringify(this.getState()));\n          return;\n        }\n\n        // Dashboard placeholder\n        res.writeHead(200, { 'Content-Type': 'text/html' });\n        res.end(`\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Knowledge Graph Dashboard</title>\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body {\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);\n      color: #e0e0e0;\n      min-height: 100vh;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n    }\n    .container { text-align: center; padding: 2rem; }\n    h1 { font-size: 2.5rem; margin-bottom: 1rem; color: #00d4ff; }\n    p { font-size: 1.2rem; margin-bottom: 2rem; opacity: 0.8; }\n    .status {\n      display: flex;\n      gap: 1rem;\n      justify-content: center;\n      flex-wrap: wrap;\n      margin-top: 2rem;\n    }\n    .card {\n      background: rgba(255,255,255,0.05);\n      border: 1px solid rgba(255,255,255,0.1);\n      border-radius: 12px;\n      padding: 1.5rem;\n      min-width: 150px;\n    }\n    .card h3 { color: #00d4ff; font-size: 0.9rem; margin-bottom: 0.5rem; }\n    .card .value { font-size: 1.5rem; font-weight: bold; }\n    .healthy { color: #00ff88; }\n    .running { color: #00ff88; }\n    .stopped { color: #ff6b6b; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <h1>Knowledge Graph Dashboard</h1>\n    <p>The full dashboard UI is coming soon.</p>\n    <div class=\"status\" id=\"status\">Loading...</div>\n  </div>\n  <script>\n    async function fetchStatus() {\n      try {\n        const res = await fetch('/api/status');\n        const data = await res.json();\n        const container = document.getElementById('status');\n        container.innerHTML = \\`\n          <div class=\"card\">\n            <h3>MCP Server</h3>\n            <div class=\"value \\${data.mcp.status}\">\\${data.mcp.status}</div>\n          </div>\n          <div class=\"card\">\n            <h3>GraphQL Server</h3>\n            <div class=\"value \\${data.graphql.status}\">\\${data.graphql.status}</div>\n          </div>\n          <div class=\"card\">\n            <h3>Dashboard</h3>\n            <div class=\"value \\${data.dashboard.status}\">\\${data.dashboard.status}</div>\n          </div>\n        \\`;\n      } catch (e) {\n        document.getElementById('status').innerHTML = 'Error loading status';\n      }\n    }\n    fetchStatus();\n    setInterval(fetchStatus, 5000);\n  </script>\n</body>\n</html>\n        `);\n      });\n\n      server.on('error', (error: NodeJS.ErrnoException) => {\n        if (error.code === 'EADDRINUSE') {\n          reject(new Error(`Port ${port} is already in use`));\n        } else {\n          reject(error);\n        }\n      });\n\n      server.listen(port, () => {\n        resolve(server);\n      });\n    });\n  }\n\n  /**\n   * Stop the Dashboard server\n   */\n  async stopDashboard(): Promise<void> {\n    if (!this.dashboardServer) {\n      logger.debug('Dashboard server not running');\n      return;\n    }\n\n    this.updateServerState('dashboard', { status: 'stopping' });\n    this.emitEvent({\n      type: 'server:stopping',\n      server: 'dashboard',\n      timestamp: new Date(),\n    });\n\n    try {\n      await this.closeHTTPServer(this.dashboardServer.server);\n      this.dashboardServer = null;\n\n      this.updateServerState('dashboard', {\n        status: 'stopped',\n        startedAt: undefined,\n        port: undefined,\n      });\n\n      this.emitEvent({\n        type: 'server:stopped',\n        server: 'dashboard',\n        timestamp: new Date(),\n      });\n\n      logger.info('Dashboard server stopped');\n    } catch (error) {\n      logger.error('Error stopping Dashboard server', error as Error);\n      throw error;\n    }\n\n    this.updateOverallState();\n  }\n\n  // ============================================================================\n  // Aggregate Operations\n  // ============================================================================\n\n  /**\n   * Start all enabled servers\n   */\n  async startAll(): Promise<void> {\n    await this.initialize();\n\n    logger.info('Starting all enabled servers...');\n\n    const startPromises: Promise<void>[] = [];\n\n    if (this.config.mcp.enabled) {\n      startPromises.push(this.startMCP());\n    }\n\n    if (this.config.graphql.enabled) {\n      startPromises.push(this.startGraphQL());\n    }\n\n    if (this.config.dashboard.enabled) {\n      startPromises.push(this.startDashboard());\n    }\n\n    if (startPromises.length === 0) {\n      logger.warn('No servers enabled in configuration');\n      return;\n    }\n\n    // Note: MCP uses stdio, so it blocks the main thread in a specific way.\n    // HTTP servers (GraphQL, Dashboard) can run alongside each other.\n    // We need to be careful about starting MCP with HTTP servers.\n    //\n    // If MCP is enabled with HTTP servers:\n    // - Start HTTP servers first (they're non-blocking)\n    // - Start MCP last (it consumes stdio)\n\n    if (this.config.mcp.enabled && (this.config.graphql.enabled || this.config.dashboard.enabled)) {\n      // Start HTTP servers first\n      if (this.config.graphql.enabled) {\n        await this.startGraphQL();\n      }\n      if (this.config.dashboard.enabled) {\n        await this.startDashboard();\n      }\n      // Then start MCP (which will consume stdio)\n      await this.startMCP();\n    } else {\n      // No special ordering needed\n      await Promise.all(startPromises);\n    }\n\n    logger.info('All enabled servers started');\n  }\n\n  /**\n   * Stop a specific server\n   */\n  async stop(server: 'mcp' | 'graphql' | 'dashboard'): Promise<void> {\n    switch (server) {\n      case 'mcp':\n        await this.stopMCP();\n        break;\n      case 'graphql':\n        await this.stopGraphQL();\n        break;\n      case 'dashboard':\n        await this.stopDashboard();\n        break;\n    }\n  }\n\n  /**\n   * Graceful shutdown of all servers and services\n   */\n  async gracefulShutdown(): Promise<void> {\n    if (this.shutdownInProgress) {\n      logger.warn('Shutdown already in progress');\n      return;\n    }\n\n    this.shutdownInProgress = true;\n    logger.info('Starting graceful shutdown...');\n\n    // Create a timeout promise\n    const timeoutPromise = new Promise<void>((_, reject) => {\n      setTimeout(() => {\n        reject(new Error(`Shutdown timed out after ${SHUTDOWN_TIMEOUT_MS}ms`));\n      }, SHUTDOWN_TIMEOUT_MS);\n    });\n\n    try {\n      await Promise.race([this._performShutdown(), timeoutPromise]);\n      logger.info('Graceful shutdown complete');\n    } catch (error) {\n      logger.error('Shutdown error or timeout', error as Error);\n      // Force exit on timeout\n      process.exit(1);\n    }\n  }\n\n  private async _performShutdown(): Promise<void> {\n    // Stop servers in reverse order of startup\n    const stopPromises: Promise<void>[] = [];\n\n    if (this.mcpServer) {\n      stopPromises.push(this.stopMCP());\n    }\n\n    if (this.graphqlServer) {\n      stopPromises.push(this.stopGraphQL());\n    }\n\n    if (this.dashboardServer) {\n      stopPromises.push(this.stopDashboard());\n    }\n\n    // Wait for all servers to stop\n    await Promise.allSettled(stopPromises);\n\n    // Shutdown shared services\n    if (this.services) {\n      await this.services.shutdown();\n      this.services = null;\n    }\n\n    this.state.overall = 'stopped';\n  }\n\n  // ============================================================================\n  // State & Health\n  // ============================================================================\n\n  /**\n   * Get current server manager state\n   */\n  getState(): ServerManagerState {\n    return { ...this.state };\n  }\n\n  /**\n   * Get comprehensive health status\n   */\n  getHealth(): HealthStatus {\n    if (!this.services) {\n      return {\n        healthy: false,\n        status: 'unhealthy',\n        components: [],\n        uptime: 0,\n        totalRequests: 0,\n        memory: process.memoryUsage() as HealthStatus['memory'],\n      };\n    }\n\n    const serviceHealth = this.services.getHealth();\n\n    // Add server-specific components\n    serviceHealth.components.push({\n      name: 'mcp-server',\n      healthy: !this.config.mcp.enabled || this.state.mcp.status === 'running',\n      message: this.state.mcp.status,\n      lastCheck: new Date(),\n    });\n\n    serviceHealth.components.push({\n      name: 'graphql-server',\n      healthy: !this.config.graphql.enabled || this.state.graphql.status === 'running',\n      message: `${this.state.graphql.status}${this.state.graphql.port ? ` on port ${this.state.graphql.port}` : ''}`,\n      lastCheck: new Date(),\n    });\n\n    serviceHealth.components.push({\n      name: 'dashboard-server',\n      healthy: !this.config.dashboard.enabled || this.state.dashboard.status === 'running',\n      message: `${this.state.dashboard.status}${this.state.dashboard.port ? ` on port ${this.state.dashboard.port}` : ''}`,\n      lastCheck: new Date(),\n    });\n\n    // Update total requests\n    serviceHealth.totalRequests =\n      this.state.mcp.requestCount +\n      this.state.graphql.requestCount +\n      this.state.dashboard.requestCount;\n\n    return serviceHealth;\n  }\n\n  // ============================================================================\n  // Event Management\n  // ============================================================================\n\n  /**\n   * Subscribe to server events\n   */\n  on(event: ServerEventType, listener: ServerEventListener): void {\n    this.eventEmitter.on(event, listener);\n  }\n\n  /**\n   * Unsubscribe from server events\n   */\n  off(event: ServerEventType, listener: ServerEventListener): void {\n    this.eventEmitter.off(event, listener);\n  }\n\n  /**\n   * Subscribe to an event once\n   */\n  once(event: ServerEventType, listener: ServerEventListener): void {\n    this.eventEmitter.once(event, listener);\n  }\n\n  private emitEvent(event: ServerEvent): void {\n    this.eventEmitter.emit(event.type, event);\n    // Also emit to services event bus for cross-service communication\n    if (this.services) {\n      this.services.eventBus.emit(`server:${event.type}`, event);\n    }\n  }\n\n  // ============================================================================\n  // Helper Methods\n  // ============================================================================\n\n  private updateServerState(\n    server: 'mcp' | 'graphql' | 'dashboard',\n    updates: Partial<ServerState>\n  ): void {\n    this.state[server] = {\n      ...this.state[server],\n      ...updates,\n    };\n  }\n\n  private updateOverallState(): void {\n    const states = [this.state.mcp.status, this.state.graphql.status, this.state.dashboard.status];\n\n    if (states.some((s) => s === 'error')) {\n      this.state.overall = 'error';\n    } else if (states.some((s) => s === 'running')) {\n      this.state.overall = 'running';\n    } else if (states.some((s) => s === 'starting')) {\n      this.state.overall = 'starting';\n    } else if (states.some((s) => s === 'stopping')) {\n      this.state.overall = 'stopping';\n    } else {\n      this.state.overall = 'stopped';\n    }\n  }\n\n  private async closeHTTPServer(server: HTTPServer): Promise<void> {\n    return new Promise((resolve, reject) => {\n      server.close((err) => {\n        if (err) {\n          reject(err);\n        } else {\n          resolve();\n        }\n      });\n    });\n  }\n}\n\n// ============================================================================\n// Factory Function\n// ============================================================================\n\n/**\n * Create and optionally initialize a server manager\n */\nexport async function createServerManager(\n  config: ServerConfig,\n  autoInitialize: boolean = true\n): Promise<ServerManager> {\n  const manager = new ServerManager(config);\n\n  if (autoInitialize) {\n    await manager.initialize();\n  }\n\n  return manager;\n}\n"],"names":[],"mappings":"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"}