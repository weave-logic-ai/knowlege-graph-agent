{"version":3,"file":"shared-services.js","sources":["../../src/server/shared-services.ts"],"sourcesContent":["/**\n * Shared Services Layer\n *\n * Singleton service layer that provides shared resources to all server\n * components (MCP, GraphQL, Dashboard). Ensures consistent state and\n * proper resource lifecycle management.\n *\n * @module server/shared-services\n */\n\nimport { EventEmitter } from 'events';\nimport { join } from 'path';\nimport { existsSync, mkdirSync } from 'fs';\nimport { KnowledgeGraphDatabase, createDatabase } from '../core/database.js';\nimport { ShadowCache, createShadowCache } from '../core/cache.js';\nimport { AgentRegistry, createRegistry } from '../agents/registry.js';\nimport { WorkflowRegistry, createWorkflowRegistry } from '../workflows/registry.js';\nimport { createLogger } from '../utils/index.js';\nimport type {\n  ServerConfig,\n  ISharedServices,\n  HealthStatus,\n  ComponentHealth,\n} from './types.js';\n\nconst logger = createLogger('shared-services');\n\n// ============================================================================\n// Default Configuration\n// ============================================================================\n\n/**\n * Create default server configuration\n */\nexport function createDefaultConfig(projectRoot: string): ServerConfig {\n  return {\n    projectRoot,\n    mcp: {\n      enabled: false,\n      name: 'knowledge-graph-mcp-server',\n      version: '0.4.0',\n    },\n    graphql: {\n      enabled: false,\n      port: 4000,\n      playground: true,\n      introspection: true,\n    },\n    dashboard: {\n      enabled: false,\n      port: 3000,\n      hotReload: process.env.NODE_ENV !== 'production',\n    },\n    database: {\n      path: join(projectRoot, '.kg', 'knowledge.db'),\n      wal: true,\n      busyTimeout: 5000,\n    },\n    cache: {\n      enabled: true,\n      defaultTTL: 3600000, // 1 hour\n      maxEntries: 10000,\n    },\n    verbose: false,\n  };\n}\n\n// ============================================================================\n// Shared Services Implementation\n// ============================================================================\n\n/**\n * SharedServices\n *\n * Singleton class that manages shared resources across all server components.\n * Provides database, cache, registries, and event bus for cross-service\n * communication.\n *\n * @example\n * ```typescript\n * const services = SharedServices.getInstance(config);\n * await services.initialize();\n *\n * // Access shared resources\n * const db = services.database;\n * const cache = services.cache;\n *\n * // Listen to events\n * services.eventBus.on('graph:updated', handleUpdate);\n *\n * // Cleanup\n * await services.shutdown();\n * ```\n */\nexport class SharedServices implements ISharedServices {\n  private static instance: SharedServices | null = null;\n\n  private _database: KnowledgeGraphDatabase | null = null;\n  private _cache: ShadowCache | null = null;\n  private _agentRegistry: AgentRegistry | null = null;\n  private _workflowRegistry: WorkflowRegistry | null = null;\n  private _eventBus: EventEmitter;\n  private _config: ServerConfig;\n  private _projectRoot: string;\n  private _initialized: boolean = false;\n  private _initPromise: Promise<void> | null = null;\n  private _startTime: number = 0;\n\n  /**\n   * Private constructor - use getInstance() instead\n   */\n  private constructor(config: ServerConfig) {\n    this._config = config;\n    this._projectRoot = config.projectRoot;\n    this._eventBus = new EventEmitter();\n\n    // Increase max listeners for busy systems\n    this._eventBus.setMaxListeners(100);\n\n    logger.debug('SharedServices instance created', {\n      projectRoot: this._projectRoot,\n    });\n  }\n\n  /**\n   * Get or create the singleton instance\n   */\n  static getInstance(config: ServerConfig): SharedServices {\n    if (!SharedServices.instance) {\n      SharedServices.instance = new SharedServices(config);\n    } else {\n      // Update config if instance exists\n      SharedServices.instance._config = config;\n      SharedServices.instance._projectRoot = config.projectRoot;\n    }\n    return SharedServices.instance;\n  }\n\n  /**\n   * Check if instance exists\n   */\n  static hasInstance(): boolean {\n    return SharedServices.instance !== null;\n  }\n\n  /**\n   * Reset the singleton instance (for testing)\n   */\n  static async resetInstance(): Promise<void> {\n    if (SharedServices.instance) {\n      await SharedServices.instance.shutdown();\n      SharedServices.instance = null;\n    }\n  }\n\n  // ============================================================================\n  // Property Accessors\n  // ============================================================================\n\n  get database(): KnowledgeGraphDatabase {\n    if (!this._database) {\n      throw new Error('SharedServices not initialized. Call initialize() first.');\n    }\n    return this._database;\n  }\n\n  get cache(): ShadowCache {\n    if (!this._cache) {\n      throw new Error('SharedServices not initialized. Call initialize() first.');\n    }\n    return this._cache;\n  }\n\n  get agentRegistry(): AgentRegistry {\n    if (!this._agentRegistry) {\n      throw new Error('SharedServices not initialized. Call initialize() first.');\n    }\n    return this._agentRegistry;\n  }\n\n  get workflowRegistry(): WorkflowRegistry {\n    if (!this._workflowRegistry) {\n      throw new Error('SharedServices not initialized. Call initialize() first.');\n    }\n    return this._workflowRegistry;\n  }\n\n  get eventBus(): EventEmitter {\n    return this._eventBus;\n  }\n\n  get projectRoot(): string {\n    return this._projectRoot;\n  }\n\n  get config(): ServerConfig {\n    return this._config;\n  }\n\n  // ============================================================================\n  // Lifecycle Methods\n  // ============================================================================\n\n  /**\n   * Initialize all shared services\n   */\n  async initialize(): Promise<void> {\n    // Return existing promise if already initializing\n    if (this._initPromise) {\n      return this._initPromise;\n    }\n\n    // Return immediately if already initialized\n    if (this._initialized) {\n      logger.debug('SharedServices already initialized');\n      return;\n    }\n\n    this._initPromise = this._doInitialize();\n\n    try {\n      await this._initPromise;\n    } finally {\n      this._initPromise = null;\n    }\n  }\n\n  /**\n   * Internal initialization logic\n   */\n  private async _doInitialize(): Promise<void> {\n    logger.info('Initializing SharedServices...');\n    this._startTime = Date.now();\n\n    try {\n      // Ensure .kg directory exists\n      const kgDir = join(this._projectRoot, '.kg');\n      if (!existsSync(kgDir)) {\n        mkdirSync(kgDir, { recursive: true });\n        logger.debug('Created .kg directory');\n      }\n\n      // Initialize database\n      logger.debug('Initializing database...');\n      this._database = createDatabase(this._config.database.path);\n      this._eventBus.emit('service:initialized', { service: 'database' });\n\n      // Initialize cache\n      if (this._config.cache.enabled) {\n        logger.debug('Initializing cache...');\n        this._cache = createShadowCache({\n          projectRoot: this._projectRoot,\n          defaultTTL: this._config.cache.defaultTTL,\n          maxEntries: this._config.cache.maxEntries,\n        });\n        this._eventBus.emit('service:initialized', { service: 'cache' });\n      } else {\n        // Create minimal cache even if disabled\n        this._cache = createShadowCache({\n          projectRoot: this._projectRoot,\n          persist: false,\n        });\n      }\n\n      // Initialize agent registry\n      logger.debug('Initializing agent registry...');\n      this._agentRegistry = createRegistry({\n        enableHealthMonitoring: true,\n        healthCheckInterval: 30000,\n      });\n      this._eventBus.emit('service:initialized', { service: 'agentRegistry' });\n\n      // Initialize workflow registry\n      logger.debug('Initializing workflow registry...');\n      this._workflowRegistry = createWorkflowRegistry({\n        maxConcurrentExecutions: 10,\n        persistHistory: true,\n        maxHistoryEntries: 1000,\n      });\n      this._eventBus.emit('service:initialized', { service: 'workflowRegistry' });\n\n      this._initialized = true;\n\n      const initTime = Date.now() - this._startTime;\n      logger.info('SharedServices initialized successfully', {\n        initTimeMs: initTime,\n        databasePath: this._config.database.path,\n      });\n\n      this._eventBus.emit('services:ready', {\n        initTimeMs: initTime,\n      });\n    } catch (error) {\n      logger.error(\n        'Failed to initialize SharedServices',\n        error instanceof Error ? error : new Error(String(error))\n      );\n\n      // Cleanup partial initialization\n      await this._cleanup();\n\n      throw error;\n    }\n  }\n\n  /**\n   * Shutdown all shared services\n   */\n  async shutdown(): Promise<void> {\n    if (!this._initialized) {\n      logger.debug('SharedServices not initialized, nothing to shutdown');\n      return;\n    }\n\n    logger.info('Shutting down SharedServices...');\n    this._eventBus.emit('services:stopping');\n\n    await this._cleanup();\n\n    this._initialized = false;\n    logger.info('SharedServices shutdown complete');\n\n    this._eventBus.emit('services:stopped');\n  }\n\n  /**\n   * Internal cleanup logic\n   */\n  private async _cleanup(): Promise<void> {\n    // Shutdown workflow registry\n    if (this._workflowRegistry) {\n      try {\n        // Clear any active workflows\n        this._workflowRegistry.clear();\n        this._workflowRegistry = null;\n        logger.debug('Workflow registry shutdown complete');\n      } catch (error) {\n        logger.error('Error shutting down workflow registry', error as Error);\n      }\n    }\n\n    // Shutdown agent registry\n    if (this._agentRegistry) {\n      try {\n        await this._agentRegistry.dispose();\n        this._agentRegistry = null;\n        logger.debug('Agent registry shutdown complete');\n      } catch (error) {\n        logger.error('Error shutting down agent registry', error as Error);\n      }\n    }\n\n    // Shutdown cache\n    if (this._cache) {\n      try {\n        // Save cache to disk if persistence enabled\n        this._cache.save();\n        this._cache = null;\n        logger.debug('Cache shutdown complete');\n      } catch (error) {\n        logger.error('Error shutting down cache', error as Error);\n      }\n    }\n\n    // Shutdown database (last to ensure other services can write final state)\n    if (this._database) {\n      try {\n        this._database.close();\n        this._database = null;\n        logger.debug('Database shutdown complete');\n      } catch (error) {\n        logger.error('Error shutting down database', error as Error);\n      }\n    }\n  }\n\n  /**\n   * Check if services are initialized\n   */\n  isInitialized(): boolean {\n    return this._initialized;\n  }\n\n  // ============================================================================\n  // Health Check Methods\n  // ============================================================================\n\n  /**\n   * Get comprehensive health status\n   */\n  getHealth(): HealthStatus {\n    const components: ComponentHealth[] = [];\n    const now = new Date();\n\n    // Database health\n    components.push(this._checkDatabaseHealth(now));\n\n    // Cache health\n    components.push(this._checkCacheHealth(now));\n\n    // Agent registry health\n    components.push(this._checkAgentRegistryHealth(now));\n\n    // Workflow registry health\n    components.push(this._checkWorkflowRegistryHealth(now));\n\n    // Calculate overall health\n    const unhealthyCount = components.filter((c) => !c.healthy).length;\n    const overallHealthy = unhealthyCount === 0;\n    const status: HealthStatus['status'] =\n      unhealthyCount === 0 ? 'healthy' : unhealthyCount < 2 ? 'degraded' : 'unhealthy';\n\n    // Memory usage\n    const memUsage = process.memoryUsage();\n\n    return {\n      healthy: overallHealthy,\n      status,\n      components,\n      uptime: this._initialized ? Date.now() - this._startTime : 0,\n      totalRequests: 0, // Updated by server manager\n      memory: {\n        heapUsed: memUsage.heapUsed,\n        heapTotal: memUsage.heapTotal,\n        external: memUsage.external,\n        rss: memUsage.rss,\n      },\n    };\n  }\n\n  private _checkDatabaseHealth(now: Date): ComponentHealth {\n    if (!this._database) {\n      return {\n        name: 'database',\n        healthy: false,\n        message: 'Not initialized',\n        lastCheck: now,\n      };\n    }\n\n    try {\n      // Simple health check query\n      const stats = this._database.getStats();\n      return {\n        name: 'database',\n        healthy: true,\n        message: 'Connected',\n        metrics: {\n          nodes: stats.totalNodes,\n          edges: stats.totalEdges,\n        },\n        lastCheck: now,\n      };\n    } catch (error) {\n      return {\n        name: 'database',\n        healthy: false,\n        message: `Error: ${error instanceof Error ? error.message : String(error)}`,\n        lastCheck: now,\n      };\n    }\n  }\n\n  private _checkCacheHealth(now: Date): ComponentHealth {\n    if (!this._cache) {\n      return {\n        name: 'cache',\n        healthy: !this._config.cache.enabled, // Healthy if disabled\n        message: this._config.cache.enabled ? 'Not initialized' : 'Disabled',\n        lastCheck: now,\n      };\n    }\n\n    try {\n      const stats = this._cache.getStats();\n      return {\n        name: 'cache',\n        healthy: true,\n        message: 'Operational',\n        metrics: {\n          entries: stats.totalEntries,\n          hitRate: Math.round(stats.hitRate * 100),\n          size: stats.sizeBytes,\n        },\n        lastCheck: now,\n      };\n    } catch (error) {\n      return {\n        name: 'cache',\n        healthy: false,\n        message: `Error: ${error instanceof Error ? error.message : String(error)}`,\n        lastCheck: now,\n      };\n    }\n  }\n\n  private _checkAgentRegistryHealth(now: Date): ComponentHealth {\n    if (!this._agentRegistry) {\n      return {\n        name: 'agentRegistry',\n        healthy: false,\n        message: 'Not initialized',\n        lastCheck: now,\n      };\n    }\n\n    try {\n      const stats = this._agentRegistry.getStats();\n      return {\n        name: 'agentRegistry',\n        healthy: true,\n        message: 'Operational',\n        metrics: {\n          registeredTypes: stats.registeredTypes,\n          activeInstances: stats.totalInstances,\n        },\n        lastCheck: now,\n      };\n    } catch (error) {\n      return {\n        name: 'agentRegistry',\n        healthy: false,\n        message: `Error: ${error instanceof Error ? error.message : String(error)}`,\n        lastCheck: now,\n      };\n    }\n  }\n\n  private _checkWorkflowRegistryHealth(now: Date): ComponentHealth {\n    if (!this._workflowRegistry) {\n      return {\n        name: 'workflowRegistry',\n        healthy: false,\n        message: 'Not initialized',\n        lastCheck: now,\n      };\n    }\n\n    try {\n      // Get basic stats from registry\n      const workflows = this._workflowRegistry.list();\n      const history = this._workflowRegistry.getHistory({ limit: 100 });\n      const completedCount = history.filter(e => e.status === 'completed').length;\n\n      return {\n        name: 'workflowRegistry',\n        healthy: true,\n        message: 'Operational',\n        metrics: {\n          registeredWorkflows: workflows.length,\n          historyEntries: history.length,\n          completedExecutions: completedCount,\n        },\n        lastCheck: now,\n      };\n    } catch (error) {\n      return {\n        name: 'workflowRegistry',\n        healthy: false,\n        message: `Error: ${error instanceof Error ? error.message : String(error)}`,\n        lastCheck: now,\n      };\n    }\n  }\n\n  // ============================================================================\n  // Event Helpers\n  // ============================================================================\n\n  /**\n   * Emit a typed event\n   */\n  emit(event: string, data?: Record<string, unknown>): void {\n    this._eventBus.emit(event, {\n      timestamp: new Date(),\n      ...data,\n    });\n  }\n\n  /**\n   * Subscribe to events\n   */\n  on(event: string, listener: (...args: unknown[]) => void): void {\n    this._eventBus.on(event, listener);\n  }\n\n  /**\n   * Unsubscribe from events\n   */\n  off(event: string, listener: (...args: unknown[]) => void): void {\n    this._eventBus.off(event, listener);\n  }\n}\n\n// ============================================================================\n// Factory Functions\n// ============================================================================\n\n/**\n * Create and initialize shared services\n */\nexport async function createSharedServices(\n  config: Partial<ServerConfig> & { projectRoot: string }\n): Promise<SharedServices> {\n  const fullConfig: ServerConfig = {\n    ...createDefaultConfig(config.projectRoot),\n    ...config,\n  };\n\n  const services = SharedServices.getInstance(fullConfig);\n  await services.initialize();\n\n  return services;\n}\n\n/**\n * Get existing shared services instance\n * @throws Error if not initialized\n */\nexport function getSharedServices(): SharedServices {\n  if (!SharedServices.hasInstance()) {\n    throw new Error('SharedServices not initialized. Call createSharedServices() first.');\n  }\n  return SharedServices.getInstance({} as ServerConfig);\n}\n"],"names":[],"mappings":"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"}