{"version":3,"file":"error-taxonomy.js","sources":["../../src/utils/error-taxonomy.ts"],"sourcesContent":["/**\n * Error Taxonomy System\n *\n * Provides structured error classification for intelligent retry strategies\n * and graceful degradation. Based on weaver error handling patterns.\n *\n * @module utils/error-taxonomy\n */\n\n/**\n * Error categories for classification and recovery strategy selection\n */\nexport enum ErrorCategory {\n  /** Transient errors that may succeed on retry (network hiccups, temporary failures) */\n  TRANSIENT = 'transient',\n\n  /** Permanent errors that won't succeed on retry (invalid input, missing resources) */\n  PERMANENT = 'permanent',\n\n  /** Rate limit errors requiring backoff (429 responses) */\n  RATE_LIMIT = 'rate_limit',\n\n  /** Network connectivity errors (DNS, connection refused) */\n  NETWORK = 'network',\n\n  /** Input validation errors (schema violations, type mismatches) */\n  VALIDATION = 'validation',\n\n  /** Resource errors (file not found, permissions) */\n  RESOURCE = 'resource',\n\n  /** Configuration errors (missing config, invalid settings) */\n  CONFIGURATION = 'configuration',\n\n  /** Timeout errors (operation exceeded time limit) */\n  TIMEOUT = 'timeout',\n\n  /** Unknown errors that couldn't be classified */\n  UNKNOWN = 'unknown',\n}\n\n/**\n * Error severity levels\n */\nexport enum ErrorSeverity {\n  /** Informational - operation can continue */\n  INFO = 'info',\n\n  /** Warning - operation continues with degraded functionality */\n  WARNING = 'warning',\n\n  /** Error - operation failed but system stable */\n  ERROR = 'error',\n\n  /** Critical - operation failed, may affect system stability */\n  CRITICAL = 'critical',\n\n  /** Fatal - system cannot continue */\n  FATAL = 'fatal',\n}\n\n/**\n * Classified error with metadata\n */\nexport interface ClassifiedError {\n  /** Original error */\n  original: Error | unknown;\n\n  /** Classified category */\n  category: ErrorCategory;\n\n  /** Error severity */\n  severity: ErrorSeverity;\n\n  /** Whether retry is recommended */\n  retryable: boolean;\n\n  /** Suggested delay before retry (milliseconds) */\n  suggestedDelay: number;\n\n  /** Error message */\n  message: string;\n\n  /** Error code if available */\n  code?: string;\n\n  /** HTTP status code if applicable */\n  statusCode?: number;\n\n  /** Additional context */\n  context?: Record<string, unknown>;\n}\n\n/**\n * Network error codes that indicate transient failures\n */\nconst TRANSIENT_NETWORK_CODES = new Set([\n  'ECONNRESET',\n  'ENOTFOUND',\n  'ECONNREFUSED',\n  'EPIPE',\n  'EAI_AGAIN',\n  'EHOSTUNREACH',\n  'ENETUNREACH',\n]);\n\n/**\n * Timeout error codes\n */\nconst TIMEOUT_CODES = new Set([\n  'ETIMEDOUT',\n  'ABORT_ERR',\n  'ERR_TIMEOUT',\n]);\n\n/**\n * HTTP status codes that indicate transient failures\n */\nconst TRANSIENT_STATUS_CODES = new Set([\n  408, // Request Timeout\n  500, // Internal Server Error\n  502, // Bad Gateway\n  503, // Service Unavailable\n  504, // Gateway Timeout\n  520, // Cloudflare Web Server Error\n  522, // Cloudflare Connection Timed Out\n  524, // Cloudflare Timeout\n]);\n\n/**\n * HTTP status codes that indicate rate limiting\n */\nconst RATE_LIMIT_STATUS_CODES = new Set([\n  429, // Too Many Requests\n]);\n\n/**\n * HTTP status codes that indicate permanent failures\n */\nconst PERMANENT_STATUS_CODES = new Set([\n  400, // Bad Request\n  401, // Unauthorized\n  403, // Forbidden\n  404, // Not Found\n  405, // Method Not Allowed\n  406, // Not Acceptable\n  410, // Gone\n  415, // Unsupported Media Type\n  422, // Unprocessable Entity\n  451, // Unavailable For Legal Reasons\n]);\n\n/**\n * Extract HTTP status code from error\n */\nfunction extractStatusCode(error: unknown): number | undefined {\n  if (error === null || error === undefined) return undefined;\n\n  if (typeof error === 'object') {\n    const obj = error as Record<string, unknown>;\n\n    // Direct status property\n    if (typeof obj.status === 'number') return obj.status;\n    if (typeof obj.statusCode === 'number') return obj.statusCode;\n\n    // Nested response object\n    if (obj.response && typeof obj.response === 'object') {\n      const response = obj.response as Record<string, unknown>;\n      if (typeof response.status === 'number') return response.status;\n      if (typeof response.statusCode === 'number') return response.statusCode;\n    }\n  }\n\n  return undefined;\n}\n\n/**\n * Extract error code from error\n */\nfunction extractErrorCode(error: unknown): string | undefined {\n  if (error === null || error === undefined) return undefined;\n\n  if (typeof error === 'object') {\n    const obj = error as Record<string, unknown>;\n    if (typeof obj.code === 'string') return obj.code;\n    if (typeof obj.errno === 'string') return obj.errno;\n  }\n\n  return undefined;\n}\n\n/**\n * Extract error message from error\n */\nfunction extractMessage(error: unknown): string {\n  if (error === null) return 'Null error';\n  if (error === undefined) return 'Undefined error';\n\n  if (error instanceof Error) return error.message;\n\n  if (typeof error === 'object') {\n    const obj = error as Record<string, unknown>;\n    if (typeof obj.message === 'string') return obj.message;\n    if (typeof obj.error === 'string') return obj.error;\n  }\n\n  if (typeof error === 'string') return error;\n\n  return 'Unknown error';\n}\n\n/**\n * Check if error message indicates timeout\n */\nfunction isTimeoutMessage(message: string): boolean {\n  const lowerMessage = message.toLowerCase();\n  return (\n    lowerMessage.includes('timeout') ||\n    lowerMessage.includes('timed out') ||\n    lowerMessage.includes('deadline exceeded') ||\n    lowerMessage.includes('aborted')\n  );\n}\n\n/**\n * Check if error message indicates validation error\n */\nfunction isValidationMessage(message: string): boolean {\n  const lowerMessage = message.toLowerCase();\n  return (\n    lowerMessage.includes('validation') ||\n    lowerMessage.includes('invalid') ||\n    lowerMessage.includes('schema') ||\n    lowerMessage.includes('required') ||\n    lowerMessage.includes('must be')\n  );\n}\n\n/**\n * Check if error message indicates configuration error\n */\nfunction isConfigurationMessage(message: string): boolean {\n  const lowerMessage = message.toLowerCase();\n  return (\n    lowerMessage.includes('config') ||\n    lowerMessage.includes('setting') ||\n    lowerMessage.includes('environment') ||\n    lowerMessage.includes('missing key') ||\n    lowerMessage.includes('api key')\n  );\n}\n\n/**\n * Check if error message indicates resource error\n */\nfunction isResourceMessage(message: string): boolean {\n  const lowerMessage = message.toLowerCase();\n  return (\n    lowerMessage.includes('not found') ||\n    lowerMessage.includes('no such file') ||\n    lowerMessage.includes('permission denied') ||\n    lowerMessage.includes('access denied') ||\n    lowerMessage.includes('enoent')\n  );\n}\n\n/**\n * Classify an error into a category with recovery metadata\n *\n * @param error - The error to classify\n * @returns Classified error with recovery recommendations\n *\n * @example\n * ```typescript\n * try {\n *   await fetchData();\n * } catch (error) {\n *   const classified = classifyError(error);\n *   if (classified.retryable) {\n *     await delay(classified.suggestedDelay);\n *     return retry();\n *   }\n *   throw error;\n * }\n * ```\n */\nexport function classifyError(error: unknown): ClassifiedError {\n  const message = extractMessage(error);\n  const code = extractErrorCode(error);\n  const statusCode = extractStatusCode(error);\n\n  let category = ErrorCategory.UNKNOWN;\n  let severity = ErrorSeverity.ERROR;\n  let retryable = false;\n  let suggestedDelay = 1000;\n\n  // Check for rate limiting (highest priority)\n  if (statusCode && RATE_LIMIT_STATUS_CODES.has(statusCode)) {\n    category = ErrorCategory.RATE_LIMIT;\n    severity = ErrorSeverity.WARNING;\n    retryable = true;\n    suggestedDelay = 5000; // Start with 5 second delay for rate limits\n  }\n  // Check for transient HTTP errors\n  else if (statusCode && TRANSIENT_STATUS_CODES.has(statusCode)) {\n    category = ErrorCategory.TRANSIENT;\n    severity = ErrorSeverity.WARNING;\n    retryable = true;\n    suggestedDelay = 1000;\n  }\n  // Check for permanent HTTP errors\n  else if (statusCode && PERMANENT_STATUS_CODES.has(statusCode)) {\n    category = ErrorCategory.PERMANENT;\n    severity = ErrorSeverity.ERROR;\n    retryable = false;\n    suggestedDelay = 0;\n  }\n  // Check for timeout by code or message (before network to catch ETIMEDOUT)\n  else if ((code && TIMEOUT_CODES.has(code)) || isTimeoutMessage(message)) {\n    category = ErrorCategory.TIMEOUT;\n    severity = ErrorSeverity.WARNING;\n    retryable = true;\n    suggestedDelay = 5000;\n  }\n  // Check for network errors by code\n  else if (code && TRANSIENT_NETWORK_CODES.has(code)) {\n    category = ErrorCategory.NETWORK;\n    severity = ErrorSeverity.WARNING;\n    retryable = true;\n    suggestedDelay = 2000;\n  }\n  // Check for validation errors\n  else if (isValidationMessage(message)) {\n    category = ErrorCategory.VALIDATION;\n    severity = ErrorSeverity.ERROR;\n    retryable = false;\n    suggestedDelay = 0;\n  }\n  // Check for configuration errors\n  else if (isConfigurationMessage(message)) {\n    category = ErrorCategory.CONFIGURATION;\n    severity = ErrorSeverity.CRITICAL;\n    retryable = false;\n    suggestedDelay = 0;\n  }\n  // Check for resource errors\n  else if (code === 'ENOENT' || code === 'EACCES' || isResourceMessage(message)) {\n    category = ErrorCategory.RESOURCE;\n    severity = ErrorSeverity.ERROR;\n    retryable = false;\n    suggestedDelay = 0;\n  }\n\n  return {\n    original: error,\n    category,\n    severity,\n    retryable,\n    suggestedDelay,\n    message,\n    code,\n    statusCode,\n  };\n}\n\n/**\n * Check if an error is retryable\n *\n * @param error - The error to check\n * @returns Whether the error is retryable\n */\nexport function isRetryableError(error: unknown): boolean {\n  return classifyError(error).retryable;\n}\n\n/**\n * Check if an error is transient (temporary failure)\n *\n * @param error - The error to check\n * @returns Whether the error is transient\n */\nexport function isTransientError(error: unknown): boolean {\n  const classified = classifyError(error);\n  return (\n    classified.category === ErrorCategory.TRANSIENT ||\n    classified.category === ErrorCategory.NETWORK ||\n    classified.category === ErrorCategory.TIMEOUT\n  );\n}\n\n/**\n * Check if an error is a rate limit error\n *\n * @param error - The error to check\n * @returns Whether the error is a rate limit error\n */\nexport function isRateLimitError(error: unknown): boolean {\n  return classifyError(error).category === ErrorCategory.RATE_LIMIT;\n}\n\n/**\n * Check if an error is permanent (won't succeed on retry)\n *\n * @param error - The error to check\n * @returns Whether the error is permanent\n */\nexport function isPermanentError(error: unknown): boolean {\n  const classified = classifyError(error);\n  return (\n    classified.category === ErrorCategory.PERMANENT ||\n    classified.category === ErrorCategory.VALIDATION ||\n    classified.category === ErrorCategory.CONFIGURATION ||\n    classified.category === ErrorCategory.RESOURCE\n  );\n}\n\n/**\n * Custom error class for knowledge graph operations\n */\nexport class KnowledgeGraphError extends Error {\n  public readonly category: ErrorCategory;\n  public readonly severity: ErrorSeverity;\n  public readonly retryable: boolean;\n  public readonly code?: string;\n  public readonly context?: Record<string, unknown>;\n\n  constructor(\n    message: string,\n    options: {\n      category?: ErrorCategory;\n      severity?: ErrorSeverity;\n      retryable?: boolean;\n      code?: string;\n      context?: Record<string, unknown>;\n      cause?: Error;\n    } = {}\n  ) {\n    super(message, { cause: options.cause });\n    this.name = 'KnowledgeGraphError';\n    this.category = options.category ?? ErrorCategory.UNKNOWN;\n    this.severity = options.severity ?? ErrorSeverity.ERROR;\n    this.retryable = options.retryable ?? false;\n    this.code = options.code;\n    this.context = options.context;\n  }\n}\n\n/**\n * Create a validation error\n */\nexport function createValidationError(\n  message: string,\n  context?: Record<string, unknown>\n): KnowledgeGraphError {\n  return new KnowledgeGraphError(message, {\n    category: ErrorCategory.VALIDATION,\n    severity: ErrorSeverity.ERROR,\n    retryable: false,\n    code: 'VALIDATION_ERROR',\n    context,\n  });\n}\n\n/**\n * Create a configuration error\n */\nexport function createConfigurationError(\n  message: string,\n  context?: Record<string, unknown>\n): KnowledgeGraphError {\n  return new KnowledgeGraphError(message, {\n    category: ErrorCategory.CONFIGURATION,\n    severity: ErrorSeverity.CRITICAL,\n    retryable: false,\n    code: 'CONFIGURATION_ERROR',\n    context,\n  });\n}\n\n/**\n * Create a resource error\n */\nexport function createResourceError(\n  message: string,\n  context?: Record<string, unknown>\n): KnowledgeGraphError {\n  return new KnowledgeGraphError(message, {\n    category: ErrorCategory.RESOURCE,\n    severity: ErrorSeverity.ERROR,\n    retryable: false,\n    code: 'RESOURCE_ERROR',\n    context,\n  });\n}\n"],"names":["ErrorCategory","ErrorSeverity"],"mappings":"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"}