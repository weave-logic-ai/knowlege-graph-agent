{"version":3,"file":"config.js","sources":["../../src/vector/config.ts"],"sourcesContent":["/**\n * Vector Configuration\n *\n * Configuration types and defaults for RuVector-compatible vector storage.\n * Supports multiple backends (memory, postgres, standalone) with HNSW indexing.\n *\n * @module vector/config\n */\n\nimport type { DistanceMetric, IndexType, VectorIndexConfig } from './types.js';\n\n/**\n * Backend storage type for vectors\n */\nexport type VectorBackend = 'memory' | 'postgres' | 'standalone' | 'sqlite' | 'cloud';\n\n/**\n * HNSW (Hierarchical Navigable Small World) index configuration\n *\n * HNSW provides fast approximate nearest neighbor search with\n * configurable accuracy/speed tradeoffs.\n */\nexport interface HNSWConfig {\n  /**\n   * Maximum number of connections per layer\n   * Higher values improve recall but increase memory usage\n   * @default 16\n   */\n  m: number;\n\n  /**\n   * Size of dynamic candidate list for construction\n   * Higher values improve index quality but slow down construction\n   * @default 200\n   */\n  efConstruction: number;\n\n  /**\n   * Size of dynamic candidate list for search\n   * Higher values improve recall but slow down search\n   * @default 100\n   */\n  efSearch: number;\n}\n\n/**\n * Re-export VectorIndexConfig from types for convenience\n */\nexport type { VectorIndexConfig } from './types.js';\n\n/**\n * PostgreSQL backend configuration\n */\nexport interface PostgresBackendConfig {\n  /**\n   * PostgreSQL connection string\n   * @example 'postgres://user:pass@localhost:5432/dbname'\n   */\n  connectionString: string;\n\n  /**\n   * Database schema for vector tables\n   * @default 'ruvector'\n   */\n  schema: string;\n}\n\n/**\n * Cloud backend configuration\n */\nexport interface CloudBackendConfig {\n  /**\n   * Cloud vector database endpoint URL\n   */\n  url: string;\n\n  /**\n   * API key for authentication\n   */\n  apiKey?: string;\n}\n\n/**\n * Standalone backend configuration\n */\nexport interface StandaloneBackendConfig {\n  /**\n   * Directory for vector data storage\n   * @default '.ruvector'\n   */\n  dataDir: string;\n}\n\n/**\n * RuVector configuration\n *\n * Main configuration interface for the vector database system.\n */\nexport interface RuVectorConfig {\n  /**\n   * Storage backend type\n   */\n  backend: VectorBackend;\n\n  /**\n   * Vector index configuration\n   */\n  index: VectorIndexConfig;\n\n  /**\n   * PostgreSQL connection configuration\n   * Required when backend is 'postgres'\n   */\n  postgres?: PostgresBackendConfig;\n\n  /**\n   * Cloud endpoint configuration\n   * Required when backend is 'cloud'\n   */\n  cloud?: CloudBackendConfig;\n\n  /**\n   * Standalone file path configuration\n   * Required when backend is 'standalone'\n   */\n  standalone?: StandaloneBackendConfig;\n\n  /**\n   * Enable self-learning SONA (Self-Optimizing Neural Architecture) engine\n   * When enabled, the system learns from agent trajectories to improve performance\n   * @default false\n   */\n  enableSona?: boolean;\n\n  /**\n   * Enable trajectory tracking for agents\n   * Records agent actions for analysis and learning\n   * @default false\n   */\n  enableTrajectoryTracking?: boolean;\n\n  /**\n   * Cache configuration\n   */\n  cache?: {\n    /** Enable result caching */\n    enabled: boolean;\n    /** Maximum cache size in entries */\n    maxSize: number;\n    /** Cache TTL in seconds */\n    ttlSeconds: number;\n  };\n\n  /**\n   * Performance tuning\n   */\n  performance?: {\n    /** Batch size for bulk operations */\n    batchSize: number;\n    /** Enable parallel processing */\n    parallelProcessing: boolean;\n    /** Maximum concurrent operations */\n    maxConcurrency: number;\n    /** Memory limit in MB for index */\n    memoryLimitMb?: number;\n  };\n\n  /**\n   * Hybrid search configuration\n   */\n  hybrid?: {\n    /** Enable hybrid search */\n    enabled: boolean;\n    /** Default vector weight (0-1) */\n    defaultVectorWeight: number;\n    /** Graph database connection (for Cypher queries) */\n    graphConnection?: {\n      type: 'neo4j' | 'memgraph' | 'sqlite';\n      uri?: string;\n      database?: string;\n      auth?: {\n        user: string;\n        password: string;\n      };\n    };\n  };\n\n  /**\n   * Namespace configuration for multi-tenant support\n   */\n  namespace?: {\n    /** Default namespace */\n    defaultNamespace: string;\n    /** Namespace isolation level */\n    isolation: 'soft' | 'hard';\n  };\n}\n\n/**\n * Default HNSW configuration\n * Balanced settings for most use cases\n */\nexport const DEFAULT_HNSW_CONFIG: HNSWConfig = {\n  m: 16,\n  efConstruction: 200,\n  efSearch: 100,\n};\n\n/**\n * Default vector index configuration\n * Optimized for OpenAI/Claude embeddings (1536 dimensions)\n */\nexport const DEFAULT_INDEX_CONFIG: VectorIndexConfig = {\n  dimensions: 1536,\n  distanceMetric: 'cosine',\n  indexType: 'hnsw',\n  hnswConfig: DEFAULT_HNSW_CONFIG,\n};\n\n/**\n * Default cache configuration\n */\nexport const DEFAULT_CACHE_CONFIG = {\n  enabled: true,\n  maxSize: 1000,\n  ttlSeconds: 300, // 5 minutes\n} as const;\n\n/**\n * Default performance configuration\n */\nexport const DEFAULT_PERFORMANCE_CONFIG = {\n  batchSize: 100,\n  parallelProcessing: true,\n  maxConcurrency: 4,\n} as const;\n\n/**\n * Create RuVector configuration from environment variables\n *\n * Reads configuration from the following environment variables:\n * - RUVECTOR_BACKEND: Storage backend type (default: 'memory')\n * - RUVECTOR_DIMENSIONS: Vector dimensions (default: 384)\n * - RUVECTOR_ENABLE_SONA: Enable SONA learning (default: false)\n * - RUVECTOR_ENABLE_TRAJECTORY: Enable trajectory tracking (default: false)\n * - DATABASE_URL: PostgreSQL connection string (for postgres backend)\n * - RUVECTOR_SCHEMA: PostgreSQL schema (default: 'ruvector')\n * - RUVECTOR_CLOUD_URL: Cloud endpoint URL (for cloud backend)\n * - RUVECTOR_API_KEY: Cloud API key (for cloud backend)\n * - RUVECTOR_DATA_DIR: Data directory (for standalone backend)\n *\n * @returns RuVectorConfig configured from environment\n *\n * @example\n * ```typescript\n * // Set environment variables\n * process.env.RUVECTOR_BACKEND = 'postgres';\n * process.env.DATABASE_URL = 'postgres://localhost:5432/mydb';\n *\n * // Create configuration\n * const config = createRuVectorConfig();\n * ```\n */\nexport function createRuVectorConfig(): RuVectorConfig {\n  const backend = (process.env.RUVECTOR_BACKEND || 'memory') as VectorBackend;\n  const dimensions = parseInt(process.env.RUVECTOR_DIMENSIONS || '384', 10);\n\n  const baseConfig: RuVectorConfig = {\n    backend,\n    index: {\n      ...DEFAULT_INDEX_CONFIG,\n      dimensions,\n    },\n    enableSona: process.env.RUVECTOR_ENABLE_SONA === 'true',\n    enableTrajectoryTracking: process.env.RUVECTOR_ENABLE_TRAJECTORY === 'true',\n  };\n\n  switch (backend) {\n    case 'postgres':\n      return {\n        ...baseConfig,\n        postgres: {\n          connectionString:\n            process.env.DATABASE_URL || 'postgres://localhost:5432/kg_agent',\n          schema: process.env.RUVECTOR_SCHEMA || 'ruvector',\n        },\n      };\n    case 'cloud':\n      return {\n        ...baseConfig,\n        cloud: {\n          url: process.env.RUVECTOR_CLOUD_URL || '',\n          apiKey: process.env.RUVECTOR_API_KEY,\n        },\n      };\n    case 'standalone':\n      return {\n        ...baseConfig,\n        standalone: {\n          dataDir: process.env.RUVECTOR_DATA_DIR || '.ruvector',\n        },\n      };\n    default:\n      return baseConfig;\n  }\n}\n\n/**\n * Validation result for RuVector configuration\n */\nexport interface ConfigValidationResult {\n  /**\n   * Whether the configuration is valid\n   */\n  valid: boolean;\n\n  /**\n   * List of validation errors (empty if valid)\n   */\n  errors: string[];\n\n  /**\n   * List of validation warnings\n   */\n  warnings: string[];\n}\n\n/**\n * Legacy alias for backwards compatibility\n */\nexport type ValidationResult = ConfigValidationResult;\n\n/**\n * Validate RuVector configuration\n *\n * Checks that all required fields are present and valid based on\n * the selected backend type.\n *\n * @param config - Configuration to validate\n * @returns Validation result with errors if invalid\n *\n * @example\n * ```typescript\n * const config = createRuVectorConfig();\n * const result = validateRuVectorConfig(config);\n *\n * if (!result.valid) {\n *   console.error('Configuration errors:', result.errors);\n *   process.exit(1);\n * }\n * ```\n */\nexport function validateRuVectorConfig(config: RuVectorConfig): ConfigValidationResult {\n  const errors: string[] = [];\n  const warnings: string[] = [];\n\n  // Validate dimensions\n  if (config.index.dimensions < 1) {\n    errors.push('Dimensions must be at least 1');\n  }\n  if (config.index.dimensions > 4096) {\n    warnings.push('Dimensions > 4096 may impact performance');\n  }\n\n  if (!Number.isInteger(config.index.dimensions)) {\n    errors.push('Vector dimensions must be an integer');\n  }\n\n  // Validate backend-specific configuration\n  if (config.backend === 'postgres' && !config.postgres?.connectionString) {\n    errors.push('PostgreSQL connection string required for postgres backend');\n  }\n\n  if (config.backend === 'cloud' && !config.cloud?.url) {\n    errors.push('Cloud URL required for cloud backend');\n  }\n\n  if (config.backend === 'standalone' && !config.standalone?.dataDir) {\n    errors.push('Data directory required for standalone backend');\n  }\n\n  // Validate HNSW configuration\n  if (config.index.indexType === 'hnsw' && config.index.hnswConfig) {\n    const { m, efConstruction, efSearch } = config.index.hnswConfig;\n\n    if (m < 2 || m > 100) {\n      errors.push('HNSW m must be between 2 and 100');\n    }\n\n    if (efConstruction < m) {\n      warnings.push('efConstruction should be >= m for good index quality');\n    }\n\n    if (efSearch < 10) {\n      warnings.push('efSearch < 10 may result in poor recall');\n    }\n  }\n\n  // Validate cache config\n  if (config.cache?.enabled) {\n    if (config.cache.maxSize < 1) {\n      errors.push('Cache maxSize must be at least 1');\n    }\n    if (config.cache.ttlSeconds < 1) {\n      errors.push('Cache TTL must be at least 1 second');\n    }\n  }\n\n  // Validate performance config\n  if (config.performance) {\n    if (config.performance.batchSize < 1) {\n      errors.push('Batch size must be at least 1');\n    }\n    if (config.performance.maxConcurrency < 1) {\n      errors.push('Max concurrency must be at least 1');\n    }\n    if (config.performance.memoryLimitMb && config.performance.memoryLimitMb < 64) {\n      warnings.push('Memory limit < 64MB may cause issues');\n    }\n  }\n\n  // Validate hybrid config\n  if (config.hybrid?.enabled && !config.hybrid.graphConnection) {\n    warnings.push('Hybrid search enabled but no graph connection configured');\n  }\n\n  // Validate distance metric\n  const validMetrics: DistanceMetric[] = ['cosine', 'euclidean', 'dotProduct', 'manhattan'];\n  if (!validMetrics.includes(config.index.distanceMetric)) {\n    errors.push(`Invalid distance metric: ${config.index.distanceMetric}`);\n  }\n\n  // Validate index type\n  const validIndexTypes = ['hnsw', 'flat', 'ivf', 'pq'];\n  if (!validIndexTypes.includes(config.index.indexType)) {\n    errors.push(`Invalid index type: ${config.index.indexType}`);\n  }\n\n  return { valid: errors.length === 0, errors, warnings };\n}\n\n/**\n * Default configuration instance\n * Created from environment variables at module load time\n */\nexport const defaultConfig = createRuVectorConfig();\n\n/**\n * Create configuration for high-performance scenarios\n *\n * Optimized for large-scale deployments with many vectors\n */\nexport function createHighPerformanceConfig(\n  dimensions: number = 1536\n): RuVectorConfig {\n  return {\n    ...createRuVectorConfig(),\n    backend: 'memory',\n    index: {\n      dimensions,\n      indexType: 'hnsw',\n      distanceMetric: 'cosine',\n      hnswConfig: {\n        m: 32, // More connections for better recall\n        efConstruction: 400, // Higher quality index\n        efSearch: 200, // Better search accuracy\n      },\n    },\n    cache: {\n      enabled: true,\n      maxSize: 10000,\n      ttlSeconds: 600,\n    },\n    performance: {\n      batchSize: 500,\n      parallelProcessing: true,\n      maxConcurrency: 8,\n    },\n  };\n}\n\n/**\n * Create configuration for memory-constrained environments\n *\n * Optimized for minimal memory usage\n */\nexport function createLowMemoryConfig(\n  dimensions: number = 1536\n): RuVectorConfig {\n  return {\n    ...createRuVectorConfig(),\n    backend: 'memory',\n    index: {\n      dimensions,\n      indexType: 'hnsw',\n      distanceMetric: 'cosine',\n      hnswConfig: {\n        m: 8, // Fewer connections\n        efConstruction: 100, // Faster construction\n        efSearch: 50, // Faster search\n      },\n    },\n    cache: {\n      enabled: false,\n      maxSize: 100,\n      ttlSeconds: 60,\n    },\n    performance: {\n      batchSize: 50,\n      parallelProcessing: false,\n      maxConcurrency: 2,\n      memoryLimitMb: 256,\n    },\n  };\n}\n\n/**\n * Create configuration for hybrid search with graph integration\n */\nexport function createHybridSearchConfig(\n  dimensions: number = 1536,\n  graphType: 'neo4j' | 'memgraph' | 'sqlite' = 'sqlite'\n): RuVectorConfig {\n  return {\n    ...createRuVectorConfig(),\n    backend: 'memory',\n    index: {\n      dimensions,\n      indexType: 'hnsw',\n      distanceMetric: 'cosine',\n      hnswConfig: DEFAULT_HNSW_CONFIG,\n    },\n    hybrid: {\n      enabled: true,\n      defaultVectorWeight: 0.7,\n      graphConnection: {\n        type: graphType,\n      },\n    },\n  };\n}\n\n/**\n * Get recommended configuration based on vector count\n *\n * @param estimatedVectorCount - Estimated number of vectors to store\n * @param dimensions - Vector dimensions\n * @returns Recommended configuration\n */\nexport function getRecommendedConfig(\n  estimatedVectorCount: number,\n  dimensions: number = 1536\n): RuVectorConfig {\n  if (estimatedVectorCount < 1000) {\n    // Small scale - flat index is fine\n    return createLowMemoryConfig(dimensions);\n  } else if (estimatedVectorCount < 100000) {\n    // Medium scale - standard HNSW\n    return {\n      ...createRuVectorConfig(),\n      index: { ...DEFAULT_INDEX_CONFIG, dimensions },\n    };\n  } else {\n    // Large scale - optimized HNSW\n    return createHighPerformanceConfig(dimensions);\n  }\n}\n"],"names":[],"mappings":"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"}