{"version":3,"file":"config.js","sources":["../../src/audit/config.ts"],"sourcesContent":["/**\n * Exochain Audit Configuration\n *\n * Configuration for deterministic logging with DAG-BFT consensus.\n * Supports multiple backends: file, postgres, and memory.\n *\n * @module audit/config\n */\n\n/**\n * Storage backend types for audit chain.\n * - `file`: Local file-based storage with rotation support\n * - `postgres`: PostgreSQL database with schema isolation\n * - `memory`: In-memory storage for testing/development\n */\nexport type AuditBackend = 'file' | 'postgres' | 'memory';\n\n/**\n * Consensus mechanism types for achieving finality.\n * - `proof-of-learning`: Learning-based consensus for AI agents\n * - `byzantine`: Classical BFT consensus (2f+1 validators)\n * - `raft`: Leader-based consensus for simpler setups\n * - `gossip`: Epidemic-style eventual consistency\n * - `none`: No consensus, single-agent mode\n */\nexport type ConsensusType = 'proof-of-learning' | 'byzantine' | 'raft' | 'gossip' | 'none';\n\n/**\n * File backend configuration options.\n */\nexport interface FileBackendConfig {\n  /** Directory for storing audit chain data */\n  dataDir: string;\n  /** Maximum file size in bytes before rotation (default: 10MB) */\n  maxFileSize?: number;\n  /** Number of events before rotating to new file */\n  rotateAfterEvents?: number;\n}\n\n/**\n * PostgreSQL backend configuration options.\n */\nexport interface PostgresBackendConfig {\n  /** PostgreSQL connection string */\n  connectionString: string;\n  /** Database schema for audit tables */\n  schema: string;\n}\n\n/**\n * Audit chain configuration defining storage, consensus, and syndication settings.\n */\nexport interface AuditChainConfig {\n  /** Storage backend type */\n  backend: AuditBackend;\n  /** Agent's DID (Decentralized Identifier) for event signing */\n  agentDid: string;\n  /** Ed25519 private key for signing (64-byte hex string) */\n  privateKey?: string;\n  /** Enable consensus mechanism for finality */\n  enableConsensus: boolean;\n  /** Type of consensus mechanism to use */\n  consensusType: ConsensusType;\n  /** Number of events between checkpoints */\n  checkpointInterval: number;\n  /** File backend configuration (required if backend is 'file') */\n  file?: FileBackendConfig;\n  /** PostgreSQL backend configuration (required if backend is 'postgres') */\n  postgres?: PostgresBackendConfig;\n  /** Peer endpoints for event syndication */\n  peers?: string[];\n  /** Enable automatic peer syndication */\n  enableSyndication: boolean;\n  /** Interval between syndication attempts in milliseconds */\n  syndicationInterval?: number;\n}\n\n/**\n * Default checkpoint interval (every 100 events).\n */\nexport const DEFAULT_CHECKPOINT_INTERVAL = 100;\n\n/**\n * Default syndication interval (5 minutes).\n */\nexport const DEFAULT_SYNDICATION_INTERVAL = 5 * 60 * 1000;\n\n/**\n * Default maximum file size for file backend (10MB).\n */\nexport const DEFAULT_MAX_FILE_SIZE = 10 * 1024 * 1024;\n\n/**\n * Default number of events before file rotation.\n */\nexport const DEFAULT_ROTATE_AFTER_EVENTS = 10000;\n\n/**\n * Generate a default DID for the agent based on timestamp and random component.\n *\n * @returns A unique DID string in the format `did:exo:agent-{timestamp}{random}`\n *\n * @example\n * ```typescript\n * const did = generateDefaultDid();\n * // did:exo:agent-m1abc123xyz\n * ```\n */\nfunction generateDefaultDid(): string {\n  const timestamp = Date.now().toString(36);\n  const random = Math.random().toString(36).substring(2, 10);\n  return `did:exo:agent-${timestamp}${random}`;\n}\n\n/**\n * Create audit chain configuration from environment variables.\n *\n * Environment variables:\n * - `EXOCHAIN_BACKEND`: Storage backend (file|postgres|memory)\n * - `EXOCHAIN_AGENT_DID`: Agent's decentralized identifier\n * - `EXOCHAIN_PRIVATE_KEY`: Ed25519 private key for signing\n * - `EXOCHAIN_ENABLE_CONSENSUS`: Enable consensus (true|false)\n * - `EXOCHAIN_CONSENSUS_TYPE`: Consensus mechanism type\n * - `EXOCHAIN_CHECKPOINT_INTERVAL`: Events between checkpoints\n * - `EXOCHAIN_ENABLE_SYNDICATION`: Enable peer syndication\n * - `EXOCHAIN_SYNDICATION_INTERVAL`: Syndication interval in ms\n * - `EXOCHAIN_PEER_ENDPOINTS`: Comma-separated peer URLs\n * - `EXOCHAIN_DATA_DIR`: Data directory for file backend\n * - `EXOCHAIN_MAX_FILE_SIZE`: Max file size for file backend\n * - `EXOCHAIN_ROTATE_AFTER_EVENTS`: Events before file rotation\n * - `DATABASE_URL`: PostgreSQL connection string\n * - `EXOCHAIN_SCHEMA`: PostgreSQL schema name\n *\n * @returns Fully populated AuditChainConfig\n *\n * @example\n * ```typescript\n * // Set environment variables\n * process.env.EXOCHAIN_BACKEND = 'file';\n * process.env.EXOCHAIN_DATA_DIR = './audit-data';\n *\n * const config = createAuditChainConfig();\n * ```\n */\nexport function createAuditChainConfig(): AuditChainConfig {\n  const backend = (process.env.EXOCHAIN_BACKEND || 'memory') as AuditBackend;\n\n  const baseConfig: AuditChainConfig = {\n    backend,\n    agentDid: process.env.EXOCHAIN_AGENT_DID || generateDefaultDid(),\n    privateKey: process.env.EXOCHAIN_PRIVATE_KEY,\n    enableConsensus: process.env.EXOCHAIN_ENABLE_CONSENSUS === 'true',\n    consensusType: (process.env.EXOCHAIN_CONSENSUS_TYPE || 'none') as ConsensusType,\n    checkpointInterval: parseInt(\n      process.env.EXOCHAIN_CHECKPOINT_INTERVAL || String(DEFAULT_CHECKPOINT_INTERVAL),\n      10\n    ),\n    enableSyndication: process.env.EXOCHAIN_ENABLE_SYNDICATION === 'true',\n    syndicationInterval: parseInt(\n      process.env.EXOCHAIN_SYNDICATION_INTERVAL || String(DEFAULT_SYNDICATION_INTERVAL),\n      10\n    ),\n    peers: process.env.EXOCHAIN_PEER_ENDPOINTS?.split(',').filter(Boolean) || [],\n  };\n\n  switch (backend) {\n    case 'file':\n      return {\n        ...baseConfig,\n        file: {\n          dataDir: process.env.EXOCHAIN_DATA_DIR || '.exochain',\n          maxFileSize: parseInt(\n            process.env.EXOCHAIN_MAX_FILE_SIZE || String(DEFAULT_MAX_FILE_SIZE),\n            10\n          ),\n          rotateAfterEvents: parseInt(\n            process.env.EXOCHAIN_ROTATE_AFTER_EVENTS || String(DEFAULT_ROTATE_AFTER_EVENTS),\n            10\n          ),\n        },\n      };\n    case 'postgres':\n      return {\n        ...baseConfig,\n        postgres: {\n          connectionString: process.env.DATABASE_URL || 'postgres://localhost:5432/kg_agent',\n          schema: process.env.EXOCHAIN_SCHEMA || 'exochain',\n        },\n      };\n    default:\n      return baseConfig;\n  }\n}\n\n/**\n * Validation result for audit chain configuration.\n */\nexport interface ConfigValidationResult {\n  /** Whether the configuration is valid */\n  valid: boolean;\n  /** List of validation error messages */\n  errors: string[];\n}\n\n/**\n * Validate audit chain configuration for completeness and consistency.\n *\n * @param config - The configuration to validate\n * @returns Validation result with errors if invalid\n *\n * @example\n * ```typescript\n * const config = createAuditChainConfig();\n * const result = validateAuditChainConfig(config);\n *\n * if (!result.valid) {\n *   console.error('Configuration errors:', result.errors);\n * }\n * ```\n */\nexport function validateAuditChainConfig(config: AuditChainConfig): ConfigValidationResult {\n  const errors: string[] = [];\n\n  // Required field validation\n  if (!config.agentDid) {\n    errors.push('Agent DID is required');\n  } else if (!config.agentDid.startsWith('did:')) {\n    errors.push('Agent DID must be a valid DID (starting with \"did:\")');\n  }\n\n  // Backend-specific validation\n  if (config.backend === 'file') {\n    if (!config.file?.dataDir) {\n      errors.push('File data directory is required for file backend');\n    }\n    if (config.file?.maxFileSize !== undefined && config.file.maxFileSize <= 0) {\n      errors.push('Max file size must be positive');\n    }\n    if (config.file?.rotateAfterEvents !== undefined && config.file.rotateAfterEvents <= 0) {\n      errors.push('Rotate after events must be positive');\n    }\n  }\n\n  if (config.backend === 'postgres') {\n    if (!config.postgres?.connectionString) {\n      errors.push('PostgreSQL connection string is required for postgres backend');\n    }\n    if (!config.postgres?.schema) {\n      errors.push('PostgreSQL schema is required for postgres backend');\n    }\n  }\n\n  // Consensus validation\n  if (config.enableConsensus && config.consensusType === 'none') {\n    errors.push('Consensus type must be specified when consensus is enabled');\n  }\n\n  // Syndication validation\n  if (config.enableSyndication && (!config.peers || config.peers.length === 0)) {\n    errors.push('At least one peer is required for syndication');\n  }\n\n  // Interval validation\n  if (config.checkpointInterval <= 0) {\n    errors.push('Checkpoint interval must be positive');\n  }\n\n  if (config.syndicationInterval !== undefined && config.syndicationInterval <= 0) {\n    errors.push('Syndication interval must be positive');\n  }\n\n  // Private key validation (if provided)\n  if (config.privateKey !== undefined) {\n    if (!/^[0-9a-fA-F]{128}$/.test(config.privateKey)) {\n      errors.push('Private key must be a 64-byte hex string (128 characters)');\n    }\n  }\n\n  return { valid: errors.length === 0, errors };\n}\n\n/**\n * Default configuration created from environment variables.\n * This is a convenience export for simple use cases.\n */\nexport const defaultConfig = createAuditChainConfig();\n"],"names":[],"mappings":"AAgFO,MAAM,8BAA8B;AAKpC,MAAM,+BAA+B,IAAI,KAAK;AAK9C,MAAM,wBAAwB,KAAK,OAAO;AAK1C,MAAM,8BAA8B;AAa3C,SAAS,qBAA6B;AACpC,QAAM,YAAY,KAAK,IAAA,EAAM,SAAS,EAAE;AACxC,QAAM,SAAS,KAAK,SAAS,SAAS,EAAE,EAAE,UAAU,GAAG,EAAE;AACzD,SAAO,iBAAiB,SAAS,GAAG,MAAM;AAC5C;AAgCO,SAAS,yBAA2C;AACzD,QAAM,UAAW,QAAQ,IAAI,oBAAoB;AAEjD,QAAM,aAA+B;AAAA,IACnC;AAAA,IACA,UAAU,QAAQ,IAAI,sBAAsB,mBAAA;AAAA,IAC5C,YAAY,QAAQ,IAAI;AAAA,IACxB,iBAAiB,QAAQ,IAAI,8BAA8B;AAAA,IAC3D,eAAgB,QAAQ,IAAI,2BAA2B;AAAA,IACvD,oBAAoB;AAAA,MAClB,QAAQ,IAAI,gCAAgC,OAAO,2BAA2B;AAAA,MAC9E;AAAA,IAAA;AAAA,IAEF,mBAAmB,QAAQ,IAAI,gCAAgC;AAAA,IAC/D,qBAAqB;AAAA,MACnB,QAAQ,IAAI,iCAAiC,OAAO,4BAA4B;AAAA,MAChF;AAAA,IAAA;AAAA,IAEF,OAAO,QAAQ,IAAI,yBAAyB,MAAM,GAAG,EAAE,OAAO,OAAO,KAAK,CAAA;AAAA,EAAC;AAG7E,UAAQ,SAAA;AAAA,IACN,KAAK;AACH,aAAO;AAAA,QACL,GAAG;AAAA,QACH,MAAM;AAAA,UACJ,SAAS,QAAQ,IAAI,qBAAqB;AAAA,UAC1C,aAAa;AAAA,YACX,QAAQ,IAAI,0BAA0B,OAAO,qBAAqB;AAAA,YAClE;AAAA,UAAA;AAAA,UAEF,mBAAmB;AAAA,YACjB,QAAQ,IAAI,gCAAgC,OAAO,2BAA2B;AAAA,YAC9E;AAAA,UAAA;AAAA,QACF;AAAA,MACF;AAAA,IAEJ,KAAK;AACH,aAAO;AAAA,QACL,GAAG;AAAA,QACH,UAAU;AAAA,UACR,kBAAkB,QAAQ,IAAI,gBAAgB;AAAA,UAC9C,QAAQ,QAAQ,IAAI,mBAAmB;AAAA,QAAA;AAAA,MACzC;AAAA,IAEJ;AACE,aAAO;AAAA,EAAA;AAEb;AA4BO,SAAS,yBAAyB,QAAkD;AACzF,QAAM,SAAmB,CAAA;AAGzB,MAAI,CAAC,OAAO,UAAU;AACpB,WAAO,KAAK,uBAAuB;AAAA,EACrC,WAAW,CAAC,OAAO,SAAS,WAAW,MAAM,GAAG;AAC9C,WAAO,KAAK,sDAAsD;AAAA,EACpE;AAGA,MAAI,OAAO,YAAY,QAAQ;AAC7B,QAAI,CAAC,OAAO,MAAM,SAAS;AACzB,aAAO,KAAK,kDAAkD;AAAA,IAChE;AACA,QAAI,OAAO,MAAM,gBAAgB,UAAa,OAAO,KAAK,eAAe,GAAG;AAC1E,aAAO,KAAK,gCAAgC;AAAA,IAC9C;AACA,QAAI,OAAO,MAAM,sBAAsB,UAAa,OAAO,KAAK,qBAAqB,GAAG;AACtF,aAAO,KAAK,sCAAsC;AAAA,IACpD;AAAA,EACF;AAEA,MAAI,OAAO,YAAY,YAAY;AACjC,QAAI,CAAC,OAAO,UAAU,kBAAkB;AACtC,aAAO,KAAK,+DAA+D;AAAA,IAC7E;AACA,QAAI,CAAC,OAAO,UAAU,QAAQ;AAC5B,aAAO,KAAK,oDAAoD;AAAA,IAClE;AAAA,EACF;AAGA,MAAI,OAAO,mBAAmB,OAAO,kBAAkB,QAAQ;AAC7D,WAAO,KAAK,4DAA4D;AAAA,EAC1E;AAGA,MAAI,OAAO,sBAAsB,CAAC,OAAO,SAAS,OAAO,MAAM,WAAW,IAAI;AAC5E,WAAO,KAAK,+CAA+C;AAAA,EAC7D;AAGA,MAAI,OAAO,sBAAsB,GAAG;AAClC,WAAO,KAAK,sCAAsC;AAAA,EACpD;AAEA,MAAI,OAAO,wBAAwB,UAAa,OAAO,uBAAuB,GAAG;AAC/E,WAAO,KAAK,uCAAuC;AAAA,EACrD;AAGA,MAAI,OAAO,eAAe,QAAW;AACnC,QAAI,CAAC,qBAAqB,KAAK,OAAO,UAAU,GAAG;AACjD,aAAO,KAAK,2DAA2D;AAAA,IACzE;AAAA,EACF;AAEA,SAAO,EAAE,OAAO,OAAO,WAAW,GAAG,OAAA;AACvC;AAM6B,uBAAA;"}