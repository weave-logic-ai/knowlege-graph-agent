{"version":3,"file":"diagnostics.js","sources":["../../../src/cli/commands/diagnostics.ts"],"sourcesContent":["/**\n * Diagnostics Command\n *\n * System diagnostics and health monitoring for knowledge graph.\n */\n\nimport { Command } from 'commander';\nimport chalk from 'chalk';\nimport { join } from 'path';\nimport { existsSync } from 'fs';\nimport {\n  createHealthMonitor,\n  createDatabaseCheck,\n  createMemoryCheck,\n  createDiskCheck,\n} from '../../health/index.js';\nimport { createIntegrityChecker } from '../../recovery/index.js';\nimport type { SystemHealth, HealthStatus } from '../../health/index.js';\n\nexport function createDiagnosticsCommand(): Command {\n  const diagnostics = new Command('diagnostics')\n    .alias('diag')\n    .description('System diagnostics and health monitoring');\n\n  diagnostics\n    .command('health')\n    .description('Run health checks on all components')\n    .option('--json', 'Output as JSON')\n    .action(async (options) => {\n      try {\n        const cwd = process.cwd();\n        const dbPath = join(cwd, '.kg', 'knowledge.db');\n\n        const monitor = createHealthMonitor();\n\n        // Register health checks\n        monitor.register(createDatabaseCheck(dbPath));\n        monitor.register(createMemoryCheck(500));\n        monitor.register(createDiskCheck(cwd));\n\n        console.log(chalk.cyan('Running health checks...\\n'));\n\n        const health = await monitor.check();\n\n        if (options.json) {\n          console.log(JSON.stringify(health, null, 2));\n        } else {\n          printHealth(health);\n        }\n\n        if (health.status === 'unhealthy') {\n          process.exit(1);\n        }\n      } catch (error) {\n        console.error(chalk.red('Error running health checks:'), error);\n        process.exit(1);\n      }\n    });\n\n  diagnostics\n    .command('integrity')\n    .description('Check database integrity')\n    .option('--repair', 'Attempt to repair issues')\n    .action(async (options) => {\n      try {\n        const cwd = process.cwd();\n        const dbPath = join(cwd, '.kg', 'knowledge.db');\n\n        if (!existsSync(dbPath)) {\n          console.log(chalk.yellow('Database not found. Run \"kg init\" first.'));\n          process.exit(1);\n        }\n\n        console.log(chalk.cyan('Checking database integrity...\\n'));\n\n        const checker = createIntegrityChecker(dbPath);\n        const result = await checker.check();\n\n        if (result.valid) {\n          console.log(chalk.green('Database integrity: OK'));\n        } else {\n          console.log(chalk.red('Database integrity: FAILED'));\n          result.issues.forEach((issue: string) => {\n            console.log(chalk.yellow(`  - ${issue}`));\n          });\n\n          if (options.repair) {\n            console.log(chalk.cyan('\\nAttempting repairs...'));\n            const repairResult = await checker.repair();\n            if (repairResult.repaired) {\n              console.log(chalk.green('Repairs completed'));\n              repairResult.actions.forEach((action: string) => {\n                console.log(chalk.gray(`  - ${action}`));\n              });\n            } else {\n              console.log(chalk.red('Some repairs failed'));\n              process.exit(1);\n            }\n          }\n        }\n\n        console.log(chalk.gray(`\\nCheck completed in ${result.duration}ms`));\n      } catch (error) {\n        console.error(chalk.red('Error checking integrity:'), error);\n        process.exit(1);\n      }\n    });\n\n  diagnostics\n    .command('memory')\n    .description('Show memory usage statistics')\n    .action(() => {\n      const usage = process.memoryUsage();\n\n      console.log(chalk.cyan.bold('\\nMemory Usage:\\n'));\n      console.log(chalk.white(`  Heap Used:     ${formatBytes(usage.heapUsed)}`));\n      console.log(chalk.white(`  Heap Total:    ${formatBytes(usage.heapTotal)}`));\n      console.log(chalk.white(`  RSS:           ${formatBytes(usage.rss)}`));\n      console.log(chalk.white(`  External:      ${formatBytes(usage.external)}`));\n      console.log(chalk.white(`  Array Buffers: ${formatBytes(usage.arrayBuffers)}`));\n      console.log('');\n    });\n\n  diagnostics\n    .command('status')\n    .description('Show overall system status')\n    .action(async () => {\n      try {\n        const cwd = process.cwd();\n        const kgDir = join(cwd, '.kg');\n        const dbPath = join(kgDir, 'knowledge.db');\n\n        console.log(chalk.cyan.bold('\\nKnowledge Graph Status:\\n'));\n\n        // Check initialization\n        const initialized = existsSync(kgDir);\n        console.log(chalk.white('Initialized:'), initialized ? chalk.green('Yes') : chalk.red('No'));\n\n        // Check database\n        const dbExists = existsSync(dbPath);\n        console.log(chalk.white('Database:'), dbExists ? chalk.green('OK') : chalk.yellow('Not found'));\n\n        // Show paths\n        console.log(chalk.white('\\nPaths:'));\n        console.log(chalk.gray(`  Project: ${cwd}`));\n        console.log(chalk.gray(`  KG Dir:  ${kgDir}`));\n        console.log(chalk.gray(`  DB:      ${dbPath}`));\n\n        // Memory\n        const usage = process.memoryUsage();\n        console.log(chalk.white('\\nMemory:'));\n        console.log(chalk.gray(`  Heap: ${formatBytes(usage.heapUsed)} / ${formatBytes(usage.heapTotal)}`));\n\n        console.log('');\n      } catch (error) {\n        console.error(chalk.red('Error getting status:'), error);\n        process.exit(1);\n      }\n    });\n\n  return diagnostics;\n}\n\nfunction printHealth(health: SystemHealth): void {\n  const statusColor: Record<HealthStatus, typeof chalk.green> = {\n    healthy: chalk.green,\n    degraded: chalk.yellow,\n    unhealthy: chalk.red,\n    unknown: chalk.gray,\n  };\n\n  console.log(chalk.white('Overall Status:'), statusColor[health.status](health.status.toUpperCase()));\n  console.log(chalk.gray(`Uptime: ${Math.floor(health.uptime / 1000)}s`));\n  console.log('');\n\n  console.log(chalk.white('Components:'));\n  for (const component of health.components) {\n    const icon = component.status === 'healthy' ? '[OK]' : component.status === 'degraded' ? '[!]' : '[X]';\n    const colorFn = statusColor[component.status];\n    console.log(\n      `  ${colorFn(icon)} ${component.name.padEnd(15)} ${colorFn(component.status)}`\n    );\n    if (component.message) {\n      console.log(chalk.gray(`    ${component.message}`));\n    }\n    if (component.responseTime !== undefined) {\n      console.log(chalk.gray(`    Response time: ${component.responseTime}ms`));\n    }\n  }\n  console.log('');\n}\n\nfunction formatBytes(bytes: number): string {\n  if (bytes < 1024) return `${bytes} B`;\n  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(2)} KB`;\n  return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;\n}\n"],"names":[],"mappings":"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"}