{"version":3,"file":"server.js","sources":["../../src/graphql/server.ts"],"sourcesContent":["/**\n * GraphQL Server Setup\n *\n * Provides GraphQL server configuration using graphql-yoga with WebSocket\n * subscriptions, CORS configuration, health checks, and GraphiQL playground.\n *\n * @module graphql/server\n */\n\nimport { createServer, type IncomingMessage, type ServerResponse, type Server } from 'http';\nimport { readFileSync, existsSync } from 'fs';\nimport { join } from 'path';\nimport { createYoga, type YogaServerInstance } from 'graphql-yoga';\nimport { useServer } from 'graphql-ws/lib/use/ws';\nimport { WebSocketServer } from 'ws';\nimport { makeExecutableSchema } from '@graphql-tools/schema';\n\nimport { createLogger } from '../utils/index.js';\nimport { createContextFactory, type GraphQLContext, type ContextFactoryConfig } from './context.js';\nimport { customScalars } from './scalars.js';\nimport type { KnowledgeGraphDatabase } from '../core/database.js';\nimport type { AdvancedCache } from '../caching/lru-cache.js';\nimport type { ServiceManager } from '../services/index.js';\n\nconst logger = createLogger('graphql-server');\n\n// ============================================================================\n// Types\n// ============================================================================\n\n/**\n * GraphQL server configuration options\n */\nexport interface GraphQLServerConfig {\n  /** Port to listen on */\n  port: number;\n  /** Host to bind to */\n  host?: string;\n  /** Path for GraphQL endpoint */\n  graphqlPath?: string;\n  /** Path for health check endpoint */\n  healthPath?: string;\n  /** Enable GraphiQL playground */\n  enableGraphiQL?: boolean;\n  /** Enable WebSocket subscriptions */\n  enableSubscriptions?: boolean;\n  /** CORS configuration */\n  cors?: CorsConfig;\n  /** Database instance */\n  database: KnowledgeGraphDatabase;\n  /** Cache instance */\n  cache: AdvancedCache<unknown>;\n  /** Service manager instance */\n  serviceManager: ServiceManager;\n  /** API key for authentication (optional) */\n  apiKey?: string;\n  /** Whether to require authentication */\n  requireAuth?: boolean;\n  /** Custom resolvers (merged with defaults) */\n  resolvers?: Record<string, unknown>;\n  /** Custom schema path (default: src/graphql/schema.graphql) */\n  schemaPath?: string;\n}\n\n/**\n * CORS configuration options\n */\nexport interface CorsConfig {\n  /** Allowed origins (string or array) */\n  origin?: string | string[] | boolean;\n  /** Allowed methods */\n  methods?: string[];\n  /** Allowed headers */\n  allowedHeaders?: string[];\n  /** Exposed headers */\n  exposedHeaders?: string[];\n  /** Allow credentials */\n  credentials?: boolean;\n  /** Max age for preflight cache (seconds) */\n  maxAge?: number;\n}\n\n/**\n * Health check response\n */\nexport interface HealthCheckResponse {\n  status: 'healthy' | 'degraded' | 'unhealthy';\n  timestamp: string;\n  uptime: number;\n  version: string;\n  components: {\n    database: boolean;\n    cache: boolean;\n    services: boolean;\n  };\n}\n\n/**\n * GraphQL server instance with lifecycle methods\n */\nexport interface GraphQLServerInstance {\n  /** Start the server */\n  start(): Promise<void>;\n  /** Stop the server gracefully */\n  stop(): Promise<void>;\n  /** Get the HTTP server instance */\n  getHttpServer(): Server;\n  /** Get the Yoga instance */\n  getYoga(): YogaServerInstance<Record<string, unknown>, GraphQLContext>;\n  /** Check if server is running */\n  isRunning(): boolean;\n  /** Get server URL */\n  getUrl(): string;\n}\n\n// ============================================================================\n// Server Factory\n// ============================================================================\n\n/**\n * Create a GraphQL server with all configured features\n *\n * @param config - Server configuration\n * @returns GraphQL server instance\n *\n * @example\n * ```typescript\n * const server = createGraphQLServer({\n *   port: 4000,\n *   database,\n *   cache,\n *   serviceManager,\n *   enableGraphiQL: true,\n *   enableSubscriptions: true,\n *   cors: {\n *     origin: ['http://localhost:3000'],\n *     credentials: true,\n *   },\n * });\n *\n * await server.start();\n * console.log(`GraphQL server running at ${server.getUrl()}`);\n * ```\n */\nexport function createGraphQLServer(config: GraphQLServerConfig): GraphQLServerInstance {\n  const {\n    port,\n    host = '0.0.0.0',\n    graphqlPath = '/graphql',\n    healthPath = '/health',\n    enableGraphiQL = true,\n    enableSubscriptions = true,\n    cors = {},\n    database,\n    cache,\n    serviceManager,\n    apiKey,\n    requireAuth = false,\n    resolvers: customResolvers = {},\n    schemaPath,\n  } = config;\n\n  let httpServer: Server | null = null;\n  let wsServer: WebSocketServer | null = null;\n  let isServerRunning = false;\n  const startTime = Date.now();\n\n  // Load schema\n  const typeDefs = loadSchema(schemaPath);\n\n  // Create resolvers with custom scalars\n  const resolvers = {\n    ...customScalars,\n    ...createDefaultResolvers(),\n    ...customResolvers,\n  };\n\n  // Create executable schema\n  const schema = makeExecutableSchema({\n    typeDefs,\n    resolvers,\n  });\n\n  // Create context factory\n  const contextFactory = createContextFactory({\n    database,\n    cache,\n    serviceManager,\n    apiKey,\n    requireAuth,\n  });\n\n  // Create CORS configuration\n  const corsConfig = buildCorsConfig(cors);\n\n  // Create Yoga instance\n  const yoga = createYoga<Record<string, unknown>, GraphQLContext>({\n    schema,\n    context: contextFactory,\n    graphqlEndpoint: graphqlPath,\n    graphiql: enableGraphiQL\n      ? {\n          title: 'Knowledge Graph API',\n          defaultQuery: DEFAULT_QUERY,\n          subscriptionsProtocol: 'WS',\n        }\n      : false,\n    cors: {\n      origin: Array.isArray(corsConfig.origin) ? corsConfig.origin : corsConfig.origin === true ? '*' : [],\n      methods: corsConfig.methods,\n      allowedHeaders: corsConfig.allowedHeaders,\n      exposedHeaders: corsConfig.exposedHeaders,\n      credentials: corsConfig.credentials,\n      maxAge: corsConfig.maxAge,\n    },\n    logging: {\n      debug: (...args) => logger.debug('GraphQL', { args }),\n      info: (...args) => logger.info(args.join(' ')),\n      warn: (...args) => logger.warn(args.join(' ')),\n      error: (...args) => logger.error(args.join(' ')),\n    },\n    maskedErrors: process.env.NODE_ENV === 'production',\n    landingPage: false,\n  });\n\n  // Create HTTP server with health check\n  httpServer = createServer(async (req: IncomingMessage, res: ServerResponse) => {\n    // Handle health check\n    if (req.url === healthPath && req.method === 'GET') {\n      const health = await getHealthCheck(database, cache, serviceManager, startTime);\n      const statusCode = health.status === 'healthy' ? 200 : health.status === 'degraded' ? 200 : 503;\n\n      res.writeHead(statusCode, {\n        'Content-Type': 'application/json',\n        'Cache-Control': 'no-cache, no-store, must-revalidate',\n      });\n      res.end(JSON.stringify(health));\n      return;\n    }\n\n    // Handle CORS preflight\n    if (req.method === 'OPTIONS') {\n      handleCorsPreFlight(req, res, corsConfig);\n      return;\n    }\n\n    // Delegate to Yoga - yoga.handle returns void and writes directly to response\n    yoga.handle(req, res);\n  });\n\n  // Setup WebSocket server for subscriptions\n  if (enableSubscriptions) {\n    wsServer = new WebSocketServer({\n      server: httpServer,\n      path: graphqlPath,\n    });\n\n    useServer(\n      {\n        schema,\n        context: async (ctx) => {\n          // Create context from WebSocket connection\n          const request = new Request(`ws://${host}:${port}${graphqlPath}`, {\n            headers: ctx.connectionParams as Record<string, string> | undefined,\n          });\n          return contextFactory({ request });\n        },\n        onConnect: () => {\n          logger.info('WebSocket client connected');\n          return true;\n        },\n        onDisconnect: (ctx, code, reason) => {\n          logger.info('WebSocket client disconnected', { code, reason: reason?.toString() });\n        },\n        onError: (ctx, message, errors) => {\n          logger.error('WebSocket error', undefined, { message, errors });\n        },\n      },\n      wsServer\n    );\n\n    logger.info('WebSocket subscriptions enabled', { path: graphqlPath });\n  }\n\n  // Return server instance\n  return {\n    async start(): Promise<void> {\n      if (isServerRunning) {\n        logger.warn('Server already running');\n        return;\n      }\n\n      return new Promise((resolve, reject) => {\n        httpServer!.listen(port, host, () => {\n          isServerRunning = true;\n          logger.info('GraphQL server started', {\n            url: `http://${host}:${port}${graphqlPath}`,\n            graphiql: enableGraphiQL ? `http://${host}:${port}${graphqlPath}` : 'disabled',\n            health: `http://${host}:${port}${healthPath}`,\n            subscriptions: enableSubscriptions ? `ws://${host}:${port}${graphqlPath}` : 'disabled',\n          });\n          resolve();\n        });\n\n        httpServer!.on('error', (error) => {\n          logger.error('Server error', error);\n          reject(error);\n        });\n      });\n    },\n\n    async stop(): Promise<void> {\n      if (!isServerRunning) {\n        return;\n      }\n\n      logger.info('Stopping GraphQL server...');\n\n      // Close WebSocket server\n      if (wsServer) {\n        await new Promise<void>((resolve) => {\n          wsServer!.close(() => {\n            logger.debug('WebSocket server closed');\n            resolve();\n          });\n        });\n      }\n\n      // Close HTTP server\n      await new Promise<void>((resolve, reject) => {\n        httpServer!.close((error) => {\n          if (error) {\n            reject(error);\n          } else {\n            isServerRunning = false;\n            logger.info('GraphQL server stopped');\n            resolve();\n          }\n        });\n      });\n    },\n\n    getHttpServer(): Server {\n      return httpServer!;\n    },\n\n    getYoga() {\n      return yoga;\n    },\n\n    isRunning(): boolean {\n      return isServerRunning;\n    },\n\n    getUrl(): string {\n      return `http://${host}:${port}${graphqlPath}`;\n    },\n  };\n}\n\n// ============================================================================\n// Schema Loading\n// ============================================================================\n\n/**\n * Load GraphQL schema from file\n */\nfunction loadSchema(customPath?: string): string {\n  // Try custom path first\n  if (customPath && existsSync(customPath)) {\n    logger.debug('Loading schema from custom path', { path: customPath });\n    return readFileSync(customPath, 'utf-8');\n  }\n\n  // Schema search paths (relative to cwd)\n  const searchPaths = [\n    join(process.cwd(), 'src/graphql/schema.graphql'),\n    join(process.cwd(), 'graphql/schema.graphql'),\n    join(process.cwd(), 'schema.graphql'),\n    // For dist builds\n    join(process.cwd(), 'dist/graphql/schema.graphql'),\n  ];\n\n  for (const schemaPath of searchPaths) {\n    if (existsSync(schemaPath)) {\n      logger.debug('Loading schema from path', { path: schemaPath });\n      return readFileSync(schemaPath, 'utf-8');\n    }\n  }\n\n  throw new Error(\n    `GraphQL schema not found. Tried: ${[customPath, ...searchPaths].filter(Boolean).join(', ')}`\n  );\n}\n\n// ============================================================================\n// Default Resolvers\n// ============================================================================\n\n/**\n * Create default resolvers for system queries\n */\nfunction createDefaultResolvers(): Record<string, unknown> {\n  return {\n    Query: {\n      // System health query\n      health: async (\n        _parent: unknown,\n        _args: unknown,\n        context: GraphQLContext\n      ): Promise<{\n        status: string;\n        components: { database: boolean; cache: boolean; agents: boolean; vectorStore: boolean };\n        uptime: number;\n        requestCount: number;\n        toolCount: number;\n      }> => {\n        const { services } = context;\n        const dbHealthy = !!services.database;\n        const cacheHealthy = !!services.cache;\n\n        return {\n          status: dbHealthy && cacheHealthy ? 'HEALTHY' : 'DEGRADED',\n          components: {\n            database: dbHealthy,\n            cache: cacheHealthy,\n            agents: true, // Would check agent registry\n            vectorStore: false, // Not implemented yet\n          },\n          uptime: process.uptime() * 1000,\n          requestCount: 0, // Would track in context\n          toolCount: 0, // Would count MCP tools\n        };\n      },\n\n      // Version info query\n      version: (): {\n        version: string;\n        buildTime: Date | null;\n        gitCommit: string | null;\n        nodeVersion: string;\n        schemaVersion: string;\n      } => ({\n        version: process.env.npm_package_version ?? '0.0.0',\n        buildTime: null,\n        gitCommit: process.env.GIT_COMMIT ?? null,\n        nodeVersion: process.version,\n        schemaVersion: '1.0.0',\n      }),\n    },\n\n    // Subscription resolvers would be added here\n    Subscription: {},\n  };\n}\n\n// ============================================================================\n// CORS Helpers\n// ============================================================================\n\n/**\n * Build CORS configuration for Yoga\n */\nfunction buildCorsConfig(cors: CorsConfig): {\n  origin: string[] | boolean;\n  methods: string[];\n  allowedHeaders: string[];\n  exposedHeaders: string[];\n  credentials: boolean;\n  maxAge: number;\n} {\n  const origin = cors.origin === true\n    ? true\n    : cors.origin === false\n      ? false\n      : Array.isArray(cors.origin)\n        ? cors.origin\n        : cors.origin\n          ? [cors.origin]\n          : ['http://localhost:3000', 'http://localhost:5173']; // Default dashboard origins\n\n  return {\n    origin: origin === false ? [] : origin,\n    methods: cors.methods ?? ['GET', 'POST', 'OPTIONS'],\n    allowedHeaders: cors.allowedHeaders ?? ['Content-Type', 'Authorization', 'X-Request-ID'],\n    exposedHeaders: cors.exposedHeaders ?? ['X-Request-ID'],\n    credentials: cors.credentials ?? true,\n    maxAge: cors.maxAge ?? 86400, // 24 hours\n  };\n}\n\n/**\n * Handle CORS preflight request\n */\nfunction handleCorsPreFlight(\n  req: import('http').IncomingMessage,\n  res: import('http').ServerResponse,\n  corsConfig: ReturnType<typeof buildCorsConfig>\n): void {\n  const origin = req.headers.origin;\n\n  if (origin && (corsConfig.origin === true || (Array.isArray(corsConfig.origin) && corsConfig.origin.includes(origin)))) {\n    res.setHeader('Access-Control-Allow-Origin', origin);\n  }\n\n  res.setHeader('Access-Control-Allow-Methods', corsConfig.methods.join(', '));\n  res.setHeader('Access-Control-Allow-Headers', corsConfig.allowedHeaders.join(', '));\n  res.setHeader('Access-Control-Max-Age', corsConfig.maxAge.toString());\n\n  if (corsConfig.credentials) {\n    res.setHeader('Access-Control-Allow-Credentials', 'true');\n  }\n\n  res.writeHead(204);\n  res.end();\n}\n\n// ============================================================================\n// Health Check\n// ============================================================================\n\n/**\n * Get health check response\n */\nasync function getHealthCheck(\n  database: KnowledgeGraphDatabase,\n  cache: AdvancedCache<unknown>,\n  serviceManager: ServiceManager,\n  startTime: number\n): Promise<HealthCheckResponse> {\n  let dbHealthy = false;\n  let cacheHealthy = false;\n  let servicesHealthy = false;\n\n  try {\n    // Check database\n    const db = database.getDatabase();\n    db.prepare('SELECT 1').get();\n    dbHealthy = true;\n  } catch (error) {\n    logger.error('Database health check failed', error instanceof Error ? error : undefined);\n  }\n\n  try {\n    // Check cache\n    cache.set('_health_check', Date.now(), { ttl: 1000 });\n    const value = cache.get('_health_check');\n    cacheHealthy = value !== undefined;\n    cache.delete('_health_check');\n  } catch (error) {\n    logger.error('Cache health check failed', error instanceof Error ? error : undefined);\n  }\n\n  try {\n    // Check services\n    const states = serviceManager.getAllStates();\n    const runningCount = Array.from(states.values()).filter((s) => s.status === 'running').length;\n    servicesHealthy = runningCount >= 0; // At least no errors\n  } catch (error) {\n    logger.error('Services health check failed', error instanceof Error ? error : undefined);\n  }\n\n  const allHealthy = dbHealthy && cacheHealthy && servicesHealthy;\n  const anyHealthy = dbHealthy || cacheHealthy || servicesHealthy;\n\n  return {\n    status: allHealthy ? 'healthy' : anyHealthy ? 'degraded' : 'unhealthy',\n    timestamp: new Date().toISOString(),\n    uptime: Date.now() - startTime,\n    version: process.env.npm_package_version ?? '0.0.0',\n    components: {\n      database: dbHealthy,\n      cache: cacheHealthy,\n      services: servicesHealthy,\n    },\n  };\n}\n\n// ============================================================================\n// Default Query for GraphiQL\n// ============================================================================\n\nconst DEFAULT_QUERY = `# Welcome to the Knowledge Graph API\n#\n# Try these example queries:\n\nquery SystemHealth {\n  health {\n    status\n    components {\n      database\n      cache\n      agents\n      vectorStore\n    }\n    uptime\n    requestCount\n    toolCount\n  }\n}\n\nquery SystemVersion {\n  version {\n    version\n    nodeVersion\n    schemaVersion\n  }\n}\n\n# Uncomment to query graph stats:\n# query GraphStats {\n#   graphStats {\n#     totalNodes\n#     totalEdges\n#     nodesByType {\n#       type\n#       count\n#     }\n#     orphanNodes\n#     avgLinksPerNode\n#   }\n# }\n\n# Uncomment to search nodes:\n# query SearchNodes($query: String!) {\n#   search(query: $query) {\n#     totalMatches\n#     nodes {\n#       id\n#       title\n#       type\n#       tags\n#     }\n#   }\n# }\n`;\n"],"names":["WebSocketServer"],"mappings":"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"}