{"version":3,"file":"index.js","sources":["../../src/health/index.ts"],"sourcesContent":["/**\n * Health Monitoring Module\n *\n * Provides system health monitoring, diagnostics, and alerting.\n */\n\n// ============================================================================\n// Types\n// ============================================================================\n\n/**\n * Health status values\n */\nexport type HealthStatus = 'healthy' | 'degraded' | 'unhealthy' | 'unknown';\n\n/**\n * Component health information\n */\nexport interface ComponentHealth {\n  /** Component name */\n  name: string;\n  /** Health status */\n  status: HealthStatus;\n  /** Optional message */\n  message?: string;\n  /** Last check time */\n  lastCheck: Date;\n  /** Response time in milliseconds */\n  responseTime?: number;\n  /** Additional metadata */\n  metadata?: Record<string, unknown>;\n}\n\n/**\n * System-wide health information\n */\nexport interface SystemHealth {\n  /** Overall status */\n  status: HealthStatus;\n  /** Component health details */\n  components: ComponentHealth[];\n  /** Check timestamp */\n  timestamp: Date;\n  /** System uptime in milliseconds */\n  uptime: number;\n}\n\n/**\n * Memory metrics\n */\nexport interface MemoryMetrics {\n  /** Heap used in bytes */\n  heapUsed: number;\n  /** Heap total in bytes */\n  heapTotal: number;\n  /** RSS in bytes */\n  rss: number;\n  /** External memory in bytes */\n  external: number;\n  /** Array buffers in bytes */\n  arrayBuffers: number;\n}\n\n/**\n * Performance metrics\n */\nexport interface PerformanceMetrics {\n  /** CPU usage percentage */\n  cpuUsage?: number;\n  /** Memory metrics */\n  memory: MemoryMetrics;\n  /** Event loop lag in milliseconds */\n  eventLoopLag?: number;\n  /** Active handles count */\n  activeHandles?: number;\n  /** Active requests count */\n  activeRequests?: number;\n}\n\n/**\n * Health check function\n */\nexport interface HealthCheck {\n  /** Check name */\n  name: string;\n  /** Check function */\n  check: () => Promise<ComponentHealth>;\n  /** Check interval in milliseconds */\n  interval?: number;\n  /** Critical component flag */\n  critical?: boolean;\n}\n\n/**\n * Health monitor configuration\n */\nexport interface HealthMonitorConfig {\n  /** Check interval in milliseconds */\n  interval?: number;\n  /** Timeout for individual checks */\n  timeout?: number;\n  /** Enable automatic checks */\n  autoStart?: boolean;\n}\n\n// ============================================================================\n// Health Monitor\n// ============================================================================\n\n/**\n * Health Monitor for tracking system health\n */\nexport class HealthMonitor {\n  private checks: Map<string, HealthCheck> = new Map();\n  private results: Map<string, ComponentHealth> = new Map();\n  private startTime: Date = new Date();\n  private intervalId?: ReturnType<typeof setInterval>;\n  private config: HealthMonitorConfig;\n\n  constructor(config: HealthMonitorConfig = {}) {\n    this.config = {\n      interval: config.interval || 60000,\n      timeout: config.timeout || 5000,\n      autoStart: config.autoStart ?? false,\n    };\n\n    if (this.config.autoStart) {\n      this.start();\n    }\n  }\n\n  register(check: HealthCheck): void {\n    this.checks.set(check.name, check);\n  }\n\n  unregister(name: string): void {\n    this.checks.delete(name);\n    this.results.delete(name);\n  }\n\n  async check(): Promise<SystemHealth> {\n    const components: ComponentHealth[] = [];\n\n    for (const [name, check] of this.checks) {\n      try {\n        const result = await Promise.race([\n          check.check(),\n          this.timeout(check.name),\n        ]);\n        this.results.set(name, result);\n        components.push(result);\n      } catch (error) {\n        const errorResult: ComponentHealth = {\n          name,\n          status: 'unhealthy',\n          message: error instanceof Error ? error.message : String(error),\n          lastCheck: new Date(),\n        };\n        this.results.set(name, errorResult);\n        components.push(errorResult);\n      }\n    }\n\n    const status = this.calculateOverallStatus(components);\n\n    return {\n      status,\n      components,\n      timestamp: new Date(),\n      uptime: Date.now() - this.startTime.getTime(),\n    };\n  }\n\n  getLastStatus(): SystemHealth {\n    const components = Array.from(this.results.values());\n    return {\n      status: this.calculateOverallStatus(components),\n      components,\n      timestamp: new Date(),\n      uptime: Date.now() - this.startTime.getTime(),\n    };\n  }\n\n  getPerformanceMetrics(): PerformanceMetrics {\n    const memoryUsage = process.memoryUsage();\n    return {\n      memory: {\n        heapUsed: memoryUsage.heapUsed,\n        heapTotal: memoryUsage.heapTotal,\n        rss: memoryUsage.rss,\n        external: memoryUsage.external,\n        arrayBuffers: memoryUsage.arrayBuffers,\n      },\n    };\n  }\n\n  start(): void {\n    if (this.intervalId) return;\n    this.intervalId = setInterval(() => {\n      this.check().catch(() => {});\n    }, this.config.interval);\n  }\n\n  stop(): void {\n    if (this.intervalId) {\n      clearInterval(this.intervalId);\n      this.intervalId = undefined;\n    }\n  }\n\n  private timeout(name: string): Promise<ComponentHealth> {\n    return new Promise((_, reject) => {\n      setTimeout(() => {\n        reject(new Error(`Health check timeout: ${name}`));\n      }, this.config.timeout);\n    });\n  }\n\n  private calculateOverallStatus(components: ComponentHealth[]): HealthStatus {\n    if (components.length === 0) return 'unknown';\n    const hasUnhealthy = components.some((c) => c.status === 'unhealthy');\n    const hasDegraded = components.some((c) => c.status === 'degraded');\n    if (hasUnhealthy) return 'unhealthy';\n    if (hasDegraded) return 'degraded';\n    return 'healthy';\n  }\n}\n\nexport function createHealthMonitor(config?: HealthMonitorConfig): HealthMonitor {\n  return new HealthMonitor(config);\n}\n\n// ============================================================================\n// Built-in Health Checks\n// ============================================================================\n\nexport function createDatabaseCheck(dbPath: string): HealthCheck {\n  return {\n    name: 'database',\n    critical: true,\n    check: async (): Promise<ComponentHealth> => {\n      const startTime = Date.now();\n      const { existsSync } = await import('fs');\n      const exists = existsSync(dbPath);\n      return {\n        name: 'database',\n        status: exists ? 'healthy' : 'unhealthy',\n        message: exists ? 'Database accessible' : 'Database file not found',\n        lastCheck: new Date(),\n        responseTime: Date.now() - startTime,\n      };\n    },\n  };\n}\n\nexport function createCacheCheck(): HealthCheck {\n  return {\n    name: 'cache',\n    check: async (): Promise<ComponentHealth> => {\n      return {\n        name: 'cache',\n        status: 'healthy',\n        message: 'Cache operational',\n        lastCheck: new Date(),\n      };\n    },\n  };\n}\n\nexport function createMemoryCheck(thresholdMB: number = 500): HealthCheck {\n  return {\n    name: 'memory',\n    check: async (): Promise<ComponentHealth> => {\n      const { heapUsed } = process.memoryUsage();\n      const usedMB = heapUsed / (1024 * 1024);\n      let status: HealthStatus = 'healthy';\n      if (usedMB > thresholdMB * 0.9) {\n        status = 'unhealthy';\n      } else if (usedMB > thresholdMB * 0.7) {\n        status = 'degraded';\n      }\n      return {\n        name: 'memory',\n        status,\n        message: `Heap usage: ${usedMB.toFixed(2)}MB`,\n        lastCheck: new Date(),\n        metadata: { heapUsedMB: usedMB, thresholdMB },\n      };\n    },\n  };\n}\n\nexport function createDiskCheck(path: string): HealthCheck {\n  return {\n    name: 'disk',\n    check: async (): Promise<ComponentHealth> => {\n      const { accessSync, constants } = await import('fs');\n      try {\n        accessSync(path, constants.R_OK | constants.W_OK);\n        return {\n          name: 'disk',\n          status: 'healthy',\n          message: 'Disk accessible',\n          lastCheck: new Date(),\n        };\n      } catch {\n        return {\n          name: 'disk',\n          status: 'unhealthy',\n          message: 'Disk not accessible',\n          lastCheck: new Date(),\n        };\n      }\n    },\n  };\n}\n"],"names":[],"mappings":"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"}