{"version":3,"file":"claude-flow.js","sources":["../../src/integrations/claude-flow.ts"],"sourcesContent":["/**\n * Claude-Flow Integration\n *\n * Integrates knowledge graph with claude-flow memory and coordination.\n */\n\nimport type {\n  KnowledgeNode,\n  GraphStats,\n  MemoryEntry,\n  SyncResult,\n} from '../core/types.js';\nimport { KnowledgeGraphDatabase } from '../core/database.js';\n\n/**\n * Claude-Flow client configuration\n */\nexport interface ClaudeFlowConfig {\n  namespace: string;\n  defaultTTL?: number;\n  syncOnChange?: boolean;\n}\n\n/**\n * Memory entry for knowledge graph node\n */\ninterface NodeMemoryEntry {\n  id: string;\n  title: string;\n  type: string;\n  status: string;\n  path: string;\n  tags: string[];\n  outgoingLinks: string[];\n  incomingLinks: string[];\n  summary?: string;\n  lastModified: string;\n}\n\n/**\n * Claude-Flow Knowledge Graph Integration\n *\n * Syncs knowledge graph data with claude-flow memory for\n * cross-session persistence and agent coordination.\n */\nexport class ClaudeFlowIntegration {\n  private config: Required<ClaudeFlowConfig>;\n\n  constructor(config: ClaudeFlowConfig) {\n    this.config = {\n      namespace: config.namespace,\n      defaultTTL: config.defaultTTL || 0,\n      syncOnChange: config.syncOnChange ?? true,\n    };\n  }\n\n  /**\n   * Sync all nodes to claude-flow memory\n   */\n  async syncToMemory(db: KnowledgeGraphDatabase): Promise<SyncResult> {\n    const result: SyncResult = {\n      synced: 0,\n      failed: 0,\n      errors: [],\n    };\n\n    const nodes = db.getAllNodes();\n    const entries: MemoryEntry[] = [];\n\n    // Convert nodes to memory entries\n    for (const node of nodes) {\n      try {\n        const entry = this.nodeToMemoryEntry(node);\n        entries.push({\n          key: `node/${node.id}`,\n          value: entry,\n          namespace: this.config.namespace,\n          ttl: this.config.defaultTTL,\n        });\n      } catch (error) {\n        result.failed++;\n        result.errors.push({\n          key: node.id,\n          error: String(error),\n        });\n      }\n    }\n\n    // Store graph stats\n    const stats = db.getStats();\n    entries.push({\n      key: 'stats',\n      value: stats,\n      namespace: this.config.namespace,\n    });\n\n    // Store metadata\n    entries.push({\n      key: 'metadata',\n      value: {\n        lastSync: new Date().toISOString(),\n        nodeCount: nodes.length,\n        version: db.getMetadata('version'),\n      },\n      namespace: this.config.namespace,\n    });\n\n    // Store index of all node IDs for quick lookup\n    entries.push({\n      key: 'index/nodes',\n      value: nodes.map(n => ({\n        id: n.id,\n        title: n.title,\n        type: n.type,\n        path: n.path,\n      })),\n      namespace: this.config.namespace,\n    });\n\n    // Store tag index\n    const tagIndex = this.buildTagIndex(nodes);\n    entries.push({\n      key: 'index/tags',\n      value: tagIndex,\n      namespace: this.config.namespace,\n    });\n\n    // Log what would be synced (MCP call would happen here)\n    result.synced = entries.length;\n\n    // Generate MCP commands for actual sync\n    console.log(`\\n[Claude-Flow Sync] Would sync ${entries.length} entries to namespace: ${this.config.namespace}`);\n    console.log('\\nTo sync, run these MCP commands:');\n\n    for (const entry of entries.slice(0, 5)) {\n      console.log(`mcp__claude-flow__memory_usage { action: \"store\", key: \"${entry.key}\", namespace: \"${this.config.namespace}\", value: \"...\" }`);\n    }\n\n    if (entries.length > 5) {\n      console.log(`... and ${entries.length - 5} more entries`);\n    }\n\n    return result;\n  }\n\n  /**\n   * Sync a single node to memory\n   */\n  async syncNode(node: KnowledgeNode): Promise<boolean> {\n    try {\n      const entry = this.nodeToMemoryEntry(node);\n\n      // Generate MCP command\n      console.log(`\\n[Claude-Flow Sync] Syncing node: ${node.id}`);\n      console.log(`mcp__claude-flow__memory_usage {`);\n      console.log(`  action: \"store\",`);\n      console.log(`  key: \"node/${node.id}\",`);\n      console.log(`  namespace: \"${this.config.namespace}\",`);\n      console.log(`  value: ${JSON.stringify(entry, null, 2)}`);\n      console.log(`}`);\n\n      return true;\n    } catch (error) {\n      console.error(`Failed to sync node ${node.id}: ${error}`);\n      return false;\n    }\n  }\n\n  /**\n   * Generate memory retrieval commands\n   */\n  generateRetrievalCommands(): string[] {\n    return [\n      `// Get graph stats`,\n      `mcp__claude-flow__memory_usage { action: \"retrieve\", key: \"stats\", namespace: \"${this.config.namespace}\" }`,\n      ``,\n      `// Get node index`,\n      `mcp__claude-flow__memory_usage { action: \"retrieve\", key: \"index/nodes\", namespace: \"${this.config.namespace}\" }`,\n      ``,\n      `// Get specific node`,\n      `mcp__claude-flow__memory_usage { action: \"retrieve\", key: \"node/<node-id>\", namespace: \"${this.config.namespace}\" }`,\n      ``,\n      `// Search by pattern`,\n      `mcp__claude-flow__memory_search { pattern: \"node/*\", namespace: \"${this.config.namespace}\" }`,\n    ];\n  }\n\n  /**\n   * Generate hook commands for automatic sync\n   */\n  generateHookCommands(): string[] {\n    return [\n      `# Pre-task hook to restore graph context`,\n      `npx claude-flow@alpha hooks session-restore --session-id \"kg-${this.config.namespace}\"`,\n      ``,\n      `# Post-edit hook to sync changes`,\n      `npx claude-flow@alpha hooks post-edit --file \"<file>\" --memory-key \"kg/${this.config.namespace}/changes\"`,\n      ``,\n      `# Session end hook to persist`,\n      `npx claude-flow@alpha hooks session-end --export-metrics true`,\n    ];\n  }\n\n  /**\n   * Convert node to memory entry format\n   */\n  private nodeToMemoryEntry(node: KnowledgeNode): NodeMemoryEntry {\n    // Extract first paragraph as summary\n    const summary = this.extractSummary(node.content);\n\n    return {\n      id: node.id,\n      title: node.title,\n      type: node.type,\n      status: node.status,\n      path: node.path,\n      tags: node.tags,\n      outgoingLinks: node.outgoingLinks.map(l => l.target),\n      incomingLinks: node.incomingLinks.map(l => l.target),\n      summary,\n      lastModified: node.lastModified.toISOString(),\n    };\n  }\n\n  /**\n   * Extract summary from content\n   */\n  private extractSummary(content: string, maxLength = 200): string {\n    // Skip frontmatter and headers\n    const lines = content.split('\\n');\n    let summary = '';\n\n    for (const line of lines) {\n      const trimmed = line.trim();\n\n      // Skip empty lines, headers, and code blocks\n      if (!trimmed || trimmed.startsWith('#') || trimmed.startsWith('```')) {\n        continue;\n      }\n\n      // Skip frontmatter markers\n      if (trimmed === '---') {\n        continue;\n      }\n\n      summary = trimmed;\n      break;\n    }\n\n    // Truncate if needed\n    if (summary.length > maxLength) {\n      summary = summary.slice(0, maxLength - 3) + '...';\n    }\n\n    return summary;\n  }\n\n  /**\n   * Build tag index from nodes\n   */\n  private buildTagIndex(nodes: KnowledgeNode[]): Record<string, string[]> {\n    const index: Record<string, string[]> = {};\n\n    for (const node of nodes) {\n      for (const tag of node.tags) {\n        if (!index[tag]) {\n          index[tag] = [];\n        }\n        index[tag].push(node.id);\n      }\n    }\n\n    return index;\n  }\n}\n\n/**\n * Create claude-flow integration instance\n */\nexport function createClaudeFlowIntegration(\n  config: ClaudeFlowConfig\n): ClaudeFlowIntegration {\n  return new ClaudeFlowIntegration(config);\n}\n\n/**\n * Generate MCP configuration for CLAUDE.md\n */\nexport function generateMcpConfig(namespace: string): string {\n  return `## Claude-Flow MCP Configuration\n\nAdd this to your Claude Code configuration:\n\n\\`\\`\\`bash\nclaude mcp add claude-flow npx claude-flow@alpha mcp start\n\\`\\`\\`\n\n### Memory Namespace\n\nThe knowledge graph uses namespace: \\`${namespace}\\`\n\n### Available Operations\n\n\\`\\`\\`javascript\n// Store knowledge\nmcp__claude-flow__memory_usage {\n  action: \"store\",\n  key: \"node/<id>\",\n  namespace: \"${namespace}\",\n  value: { ... }\n}\n\n// Retrieve knowledge\nmcp__claude-flow__memory_usage {\n  action: \"retrieve\",\n  key: \"node/<id>\",\n  namespace: \"${namespace}\"\n}\n\n// Search knowledge\nmcp__claude-flow__memory_search {\n  pattern: \"node/*\",\n  namespace: \"${namespace}\"\n}\n\n// List all keys\nmcp__claude-flow__memory_usage {\n  action: \"list\",\n  namespace: \"${namespace}\"\n}\n\\`\\`\\`\n`;\n}\n"],"names":[],"mappings":"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"}