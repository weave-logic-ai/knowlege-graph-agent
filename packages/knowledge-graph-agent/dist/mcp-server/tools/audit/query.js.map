{"version":3,"file":"query.js","sources":["../../../../src/mcp-server/tools/audit/query.ts"],"sourcesContent":["/**\n * Audit Query Tool\n *\n * MCP tool for querying the audit log with filtering by event type,\n * time range, and result limits.\n *\n * @module mcp-server/tools/audit/query\n */\n\nimport type { Tool } from '@modelcontextprotocol/sdk/types.js';\nimport type { ToolHandler, ToolResult } from '../../types/index.js';\nimport type { AuditChain } from '../../../audit/services/audit-chain.js';\nimport type { HybridLogicalClock, KnowledgeGraphEventPayload } from '../../../audit/types.js';\n\n/**\n * Audit query tool definition\n *\n * Provides filtering capabilities for the audit log including:\n * - Event type filtering\n * - Time range filtering via ISO timestamps\n * - Result limiting\n * - Optional payload inclusion\n */\nexport const auditQueryTool: Tool = {\n  name: 'kg_audit_query',\n  description: 'Query the audit log for events with filtering by type, time range, and limit. Returns events from the deterministic append-only log.',\n  inputSchema: {\n    type: 'object' as const,\n    properties: {\n      eventType: {\n        type: 'string',\n        description: 'Filter by event type (e.g., NodeCreated, WorkflowCompleted, SyncStarted)',\n      },\n      startTime: {\n        type: 'string',\n        description: 'Start time filter as ISO 8601 timestamp (e.g., 2024-01-01T00:00:00Z)',\n      },\n      endTime: {\n        type: 'string',\n        description: 'End time filter as ISO 8601 timestamp (e.g., 2024-12-31T23:59:59Z)',\n      },\n      limit: {\n        type: 'number',\n        description: 'Maximum number of results to return (default: 50, max: 1000)',\n        default: 50,\n        minimum: 1,\n        maximum: 1000,\n      },\n      includePayload: {\n        type: 'boolean',\n        description: 'Include the full event payload in results (default: false)',\n        default: false,\n      },\n    },\n  },\n};\n\n/**\n * Parameters for the audit query tool\n */\nexport interface AuditQueryParams {\n  /** Filter by event type */\n  eventType?: string;\n  /** Start time as ISO timestamp */\n  startTime?: string;\n  /** End time as ISO timestamp */\n  endTime?: string;\n  /** Maximum results to return */\n  limit?: number;\n  /** Include full payload in results */\n  includePayload?: boolean;\n}\n\n/**\n * Create audit query handler\n *\n * Factory function that creates a tool handler with access to the audit chain.\n *\n * @param auditChain - The audit chain instance to query\n * @returns Tool handler function\n *\n * @example\n * ```typescript\n * const auditChain = createAuditChain({ agentDid: 'did:exo:agent-1' });\n * const handler = createAuditQueryHandler(auditChain);\n *\n * const result = await handler({\n *   eventType: 'NodeCreated',\n *   limit: 10,\n *   includePayload: true\n * });\n * ```\n */\nexport function createAuditQueryHandler(auditChain?: AuditChain): ToolHandler {\n  return async (params: Record<string, unknown>): Promise<ToolResult> => {\n    const startTime = Date.now();\n    const {\n      eventType,\n      startTime: startTimeParam,\n      endTime: endTimeParam,\n      limit = 50,\n      includePayload = false,\n    } = params as AuditQueryParams;\n\n    try {\n      // Check audit chain availability\n      if (!auditChain) {\n        return {\n          success: false,\n          error: 'Audit chain not initialized. The exochain audit system is not available.',\n          metadata: { executionTime: Date.now() - startTime },\n        };\n      }\n\n      // Enforce limits\n      const safeLimit = Math.min(Math.max(1, Number(limit) || 50), 1000);\n\n      // Build query options\n      const queryOptions: {\n        type?: KnowledgeGraphEventPayload['type'];\n        since?: HybridLogicalClock;\n        until?: HybridLogicalClock;\n        limit: number;\n        includeProof?: boolean;\n      } = {\n        limit: safeLimit,\n      };\n\n      // Add event type filter\n      if (eventType && typeof eventType === 'string') {\n        queryOptions.type = eventType as KnowledgeGraphEventPayload['type'];\n      }\n\n      // Add time range filters\n      if (startTimeParam && typeof startTimeParam === 'string') {\n        const startMs = new Date(startTimeParam).getTime();\n        if (!isNaN(startMs)) {\n          queryOptions.since = { physicalMs: startMs, logical: 0 };\n        }\n      }\n\n      if (endTimeParam && typeof endTimeParam === 'string') {\n        const endMs = new Date(endTimeParam).getTime();\n        if (!isNaN(endMs)) {\n          queryOptions.until = { physicalMs: endMs, logical: Number.MAX_SAFE_INTEGER };\n        }\n      }\n\n      // Execute query\n      const result = await auditChain.queryEvents(queryOptions);\n\n      // Format results\n      const formattedEvents = result.events.map((event) => {\n        const baseEvent = {\n          id: event.id,\n          type: event.envelope.payload.type,\n          author: event.envelope.author,\n          timestamp: new Date(event.envelope.hlc.physicalMs).toISOString(),\n          hlc: {\n            physicalMs: event.envelope.hlc.physicalMs,\n            logical: event.envelope.hlc.logical,\n          },\n          parentCount: event.envelope.parents.length,\n        };\n\n        if (includePayload) {\n          return {\n            ...baseEvent,\n            payload: event.envelope.payload,\n            signature: event.signature,\n            parents: event.envelope.parents,\n          };\n        }\n\n        return baseEvent;\n      });\n\n      return {\n        success: true,\n        data: {\n          events: formattedEvents,\n          count: formattedEvents.length,\n          totalCount: result.totalCount,\n          hasMore: result.hasMore,\n          filters: {\n            eventType: eventType || null,\n            startTime: startTimeParam || null,\n            endTime: endTimeParam || null,\n          },\n        },\n        metadata: {\n          executionTime: Date.now() - startTime,\n          itemCount: formattedEvents.length,\n        },\n      };\n    } catch (error) {\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : String(error),\n        metadata: { executionTime: Date.now() - startTime },\n      };\n    }\n  };\n}\n"],"names":[],"mappings":"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"}