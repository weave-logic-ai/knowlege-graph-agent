{"version":3,"file":"logger.js","sources":["../../src/utils/logger.ts"],"sourcesContent":["/**\n * Structured Logger\n *\n * Provides consistent logging with levels, context, and structured output.\n * Based on weaver logging patterns.\n *\n * @module utils/logger\n */\n\nimport chalk from 'chalk';\n\n/**\n * Log levels\n */\nexport enum LogLevel {\n  TRACE = 0,\n  DEBUG = 1,\n  INFO = 2,\n  WARN = 3,\n  ERROR = 4,\n  FATAL = 5,\n  SILENT = 6,\n}\n\n/**\n * Log level names\n */\nconst LOG_LEVEL_NAMES: Record<LogLevel, string> = {\n  [LogLevel.TRACE]: 'TRACE',\n  [LogLevel.DEBUG]: 'DEBUG',\n  [LogLevel.INFO]: 'INFO',\n  [LogLevel.WARN]: 'WARN',\n  [LogLevel.ERROR]: 'ERROR',\n  [LogLevel.FATAL]: 'FATAL',\n  [LogLevel.SILENT]: 'SILENT',\n};\n\n/**\n * Log level colors\n */\nconst LOG_LEVEL_COLORS: Record<LogLevel, (text: string) => string> = {\n  [LogLevel.TRACE]: chalk.gray,\n  [LogLevel.DEBUG]: chalk.blue,\n  [LogLevel.INFO]: chalk.green,\n  [LogLevel.WARN]: chalk.yellow,\n  [LogLevel.ERROR]: chalk.red,\n  [LogLevel.FATAL]: chalk.bgRed.white,\n  [LogLevel.SILENT]: (s: string) => s,\n};\n\n/**\n * Sanitize stack traces for production to remove/anonymize full file paths.\n * In development, returns the stack unchanged for debugging convenience.\n *\n * @param stack - The stack trace string to sanitize\n * @returns Sanitized stack trace (production) or original (development)\n */\nfunction sanitizeStackTrace(stack: string | undefined): string | undefined {\n  if (!stack) return undefined;\n  if (process.env.NODE_ENV !== 'production') return stack;\n  // Replace full paths with just file:line:column for security\n  return stack.replace(/\\(\\/[^)]+\\/([^/]+:\\d+:\\d+)\\)/g, '($1)');\n}\n\n/**\n * Log entry structure\n */\nexport interface LogEntry {\n  level: LogLevel;\n  message: string;\n  timestamp: Date;\n  context?: Record<string, unknown>;\n  name?: string;\n  error?: Error;\n}\n\n/**\n * Logger configuration\n */\nexport interface LoggerOptions {\n  /** Minimum level to log (default: INFO) */\n  level?: LogLevel;\n\n  /** Logger name/prefix */\n  name?: string;\n\n  /** Whether to include timestamps (default: true) */\n  timestamps?: boolean;\n\n  /** Whether to output as JSON (default: false) */\n  json?: boolean;\n\n  /** Whether to use colors (default: true) */\n  colors?: boolean;\n\n  /** Custom output function */\n  output?: (entry: LogEntry) => void;\n}\n\n/**\n * Parse log level from string\n */\nexport function parseLogLevel(level: string): LogLevel {\n  const upper = level.toUpperCase();\n  switch (upper) {\n    case 'TRACE':\n      return LogLevel.TRACE;\n    case 'DEBUG':\n      return LogLevel.DEBUG;\n    case 'INFO':\n      return LogLevel.INFO;\n    case 'WARN':\n    case 'WARNING':\n      return LogLevel.WARN;\n    case 'ERROR':\n      return LogLevel.ERROR;\n    case 'FATAL':\n      return LogLevel.FATAL;\n    case 'SILENT':\n    case 'NONE':\n      return LogLevel.SILENT;\n    default:\n      return LogLevel.INFO;\n  }\n}\n\n/**\n * Logger class\n */\nexport class Logger {\n  private level: LogLevel;\n  private name?: string;\n  private timestamps: boolean;\n  private json: boolean;\n  private colors: boolean;\n  private output: (entry: LogEntry) => void;\n\n  constructor(options: LoggerOptions = {}) {\n    this.level = options.level ?? LogLevel.INFO;\n    this.name = options.name;\n    this.timestamps = options.timestamps ?? true;\n    this.json = options.json ?? false;\n    this.colors = options.colors ?? true;\n    this.output = options.output ?? this.defaultOutput.bind(this);\n  }\n\n  /**\n   * Default output implementation\n   */\n  private defaultOutput(entry: LogEntry): void {\n    if (this.json) {\n      console.log(JSON.stringify({\n        level: LOG_LEVEL_NAMES[entry.level],\n        message: entry.message,\n        timestamp: entry.timestamp.toISOString(),\n        name: entry.name,\n        ...entry.context,\n        error: entry.error ? {\n          name: entry.error.name,\n          message: entry.error.message,\n          stack: sanitizeStackTrace(entry.error.stack),\n        } : undefined,\n      }));\n      return;\n    }\n\n    const parts: string[] = [];\n\n    // Timestamp\n    if (this.timestamps) {\n      const time = entry.timestamp.toISOString().slice(11, 23);\n      parts.push(this.colors ? chalk.gray(`[${time}]`) : `[${time}]`);\n    }\n\n    // Level\n    const levelName = LOG_LEVEL_NAMES[entry.level].padEnd(5);\n    const colorFn = LOG_LEVEL_COLORS[entry.level];\n    parts.push(this.colors ? colorFn(levelName) : levelName);\n\n    // Name\n    if (entry.name) {\n      parts.push(this.colors ? chalk.cyan(`[${entry.name}]`) : `[${entry.name}]`);\n    }\n\n    // Message\n    parts.push(entry.message);\n\n    // Context\n    if (entry.context && Object.keys(entry.context).length > 0) {\n      const contextStr = JSON.stringify(entry.context);\n      parts.push(this.colors ? chalk.gray(contextStr) : contextStr);\n    }\n\n    // Output\n    const line = parts.join(' ');\n    if (entry.level >= LogLevel.ERROR) {\n      console.error(line);\n      if (entry.error?.stack) {\n        console.error(this.colors ? chalk.gray(entry.error.stack) : entry.error.stack);\n      }\n    } else {\n      console.log(line);\n    }\n  }\n\n  /**\n   * Log at specified level\n   */\n  log(level: LogLevel, message: string, context?: Record<string, unknown>): void {\n    if (level < this.level) return;\n\n    const entry: LogEntry = {\n      level,\n      message,\n      timestamp: new Date(),\n      name: this.name,\n      context,\n    };\n\n    this.output(entry);\n  }\n\n  /**\n   * Log trace message\n   */\n  trace(message: string, context?: Record<string, unknown>): void {\n    this.log(LogLevel.TRACE, message, context);\n  }\n\n  /**\n   * Log debug message\n   */\n  debug(message: string, context?: Record<string, unknown>): void {\n    this.log(LogLevel.DEBUG, message, context);\n  }\n\n  /**\n   * Log info message\n   */\n  info(message: string, context?: Record<string, unknown>): void {\n    this.log(LogLevel.INFO, message, context);\n  }\n\n  /**\n   * Log warning message\n   */\n  warn(message: string, context?: Record<string, unknown>): void {\n    this.log(LogLevel.WARN, message, context);\n  }\n\n  /**\n   * Log error message\n   */\n  error(message: string, error?: Error, context?: Record<string, unknown>): void {\n    const entry: LogEntry = {\n      level: LogLevel.ERROR,\n      message,\n      timestamp: new Date(),\n      name: this.name,\n      context,\n      error,\n    };\n\n    if (LogLevel.ERROR >= this.level) {\n      this.output(entry);\n    }\n  }\n\n  /**\n   * Log fatal message\n   */\n  fatal(message: string, error?: Error, context?: Record<string, unknown>): void {\n    const entry: LogEntry = {\n      level: LogLevel.FATAL,\n      message,\n      timestamp: new Date(),\n      name: this.name,\n      context,\n      error,\n    };\n\n    if (LogLevel.FATAL >= this.level) {\n      this.output(entry);\n    }\n  }\n\n  /**\n   * Create a child logger with additional context\n   */\n  child(name: string): Logger {\n    const childName = this.name ? `${this.name}:${name}` : name;\n    return new Logger({\n      level: this.level,\n      name: childName,\n      timestamps: this.timestamps,\n      json: this.json,\n      colors: this.colors,\n      output: this.output,\n    });\n  }\n\n  /**\n   * Set log level\n   */\n  setLevel(level: LogLevel): void {\n    this.level = level;\n  }\n\n  /**\n   * Get current log level\n   */\n  getLevel(): LogLevel {\n    return this.level;\n  }\n\n  /**\n   * Check if level is enabled\n   */\n  isLevelEnabled(level: LogLevel): boolean {\n    return level >= this.level;\n  }\n}\n\n/**\n * Default logger instance\n */\nlet defaultLogger: Logger | null = null;\n\n/**\n * Get or create the default logger\n */\nexport function getLogger(): Logger {\n  if (!defaultLogger) {\n    const level = parseLogLevel(process.env.LOG_LEVEL ?? 'info');\n    defaultLogger = new Logger({\n      level,\n      name: 'kg',\n      colors: process.stdout.isTTY ?? true,\n    });\n  }\n  return defaultLogger;\n}\n\n/**\n * Create a named logger\n */\nexport function createLogger(name: string, options: Omit<LoggerOptions, 'name'> = {}): Logger {\n  return new Logger({ ...options, name });\n}\n\n/**\n * Set the default logger\n */\nexport function setDefaultLogger(logger: Logger): void {\n  defaultLogger = logger;\n}\n\n/**\n * Progress indicator for long-running operations\n */\nexport interface ProgressLogger {\n  start(message: string): void;\n  update(message: string): void;\n  succeed(message?: string): void;\n  fail(message?: string): void;\n  stop(): void;\n}\n\n/**\n * Create a simple progress logger\n */\nexport function createProgressLogger(logger: Logger = getLogger()): ProgressLogger {\n  let currentMessage = '';\n\n  return {\n    start(message: string) {\n      currentMessage = message;\n      logger.info(`⏳ ${message}`);\n    },\n    update(message: string) {\n      currentMessage = message;\n      logger.debug(`   ${message}`);\n    },\n    succeed(message?: string) {\n      logger.info(`✅ ${message ?? currentMessage}`);\n    },\n    fail(message?: string) {\n      logger.error(`❌ ${message ?? currentMessage}`);\n    },\n    stop() {\n      // No-op for simple logger\n    },\n  };\n}\n"],"names":["LogLevel"],"mappings":"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"}