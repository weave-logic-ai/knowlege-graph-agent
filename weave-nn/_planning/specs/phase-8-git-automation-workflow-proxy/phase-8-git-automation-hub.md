# Phase 8: Git Automation & Workflow Proxy - Spec Kit

**Phase ID**: PHASE-8
**Status**: â³ **PENDING** (blocked by Phase 7)
**Priority**: ğŸŸ¡ **MEDIUM**
**Duration**: 2 days
**Generated**: 2025-10-26

---

## ğŸ“ Spec-Kit Contents

This directory contains the complete specification kit for Phase 8: Git Automation & Workflow Proxy.

### Files

1. **[constitution.md](./constitution.md)** - Guiding principles and constraints
2. **[specification.md](./specification.md)** - Functional and non-functional requirements
3. **[tasks.md](./phase-8-git-tasks.md)** - Detailed task breakdown (12 tasks)
4. **[.speckit/metadata.json](./.speckit/metadata.json)** - Phase metadata

---

## ğŸ¯ Phase Overview

Implement **automated git version control** for the Obsidian vault using:
- **simple-git** for git operations
- **Claude API** for intelligent commit message generation
- **Weaver workflow proxy** for durable git orchestration

**Key Deliverables**:
- âœ… Auto-commit on file save (debounced)
- âœ… AI-generated semantic commit messages
- âœ… Weaver workflow proxy for git operations
- âœ… Git operation logging and admin API

---

## ğŸ—ï¸ Architecture

### Components

```
weaver/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ git/
â”‚   â”‚   â”œâ”€â”€ git-client.ts         # simple-git wrapper
â”‚   â”‚   â”œâ”€â”€ auto-commit.ts        # Auto-commit service
â”‚   â”‚   â”œâ”€â”€ workflow-proxy.ts     # Weaver git workflow proxy
â”‚   â”‚   â””â”€â”€ commit-message.ts     # Claude commit message generator
â”‚   â”œâ”€â”€ watcher/
â”‚   â”‚   â””â”€â”€ event-processor.ts    # Trigger auto-commit on file events
â”‚   â””â”€â”€ server.ts                 # Register git proxy routes
â”œâ”€â”€ workflows/
â”‚   â””â”€â”€ git-commit.yaml           # Weaver git-commit workflow
â”œâ”€â”€ logs/
â”‚   â””â”€â”€ git-operations.log        # Git operation audit log
â””â”€â”€ tests/
    â””â”€â”€ git/
        â”œâ”€â”€ git-client.test.ts
        â””â”€â”€ auto-commit.test.ts
```

---

## ğŸš€ Quick Start

### 1. Read the Constitution

Start with **[constitution.md](./constitution.md)** to understand:
- Core principles (automation first, semantic messages)
- Design constraints (safety, non-blocking)
- Anti-patterns to avoid

### 2. Review the Specification

Read **[specification.md](./specification.md)** for:
- Functional requirements (FR-1 to FR-7)
- Non-functional requirements (performance, security, reliability)
- Data models and API contracts
- Integration points with Phase 6 and Phase 7

### 3. Implement Tasks

Follow **[tasks.md](./phase-8-git-tasks.md)** for:
- 12 detailed implementation tasks
- Effort estimates and priorities
- Acceptance criteria for each task
- Files to create/modify

---

## ğŸ“Š Implementation Tasks

### Day 1: Git Automation Core (8 hours)

**Morning** (3 hours):
- 1.1: Install simple-git library (0.5h)
- 1.2: Create GitClient wrapper class (2h)
- 1.3: Add git configuration to .env (0.5h)

**Afternoon** (6.5 hours):
- 2.1: Create AutoCommitService class (3h)
- 2.2: Implement commit message generation (2h)
- 2.3: Integrate auto-commit with file watcher (1.5h)

### Day 2: Weaver Workflow Proxy (8 hours)

**Morning** (5.5 hours):
- 3.1: Create GitWorkflowProxy class (2h)
- 3.2: Create Weaver git-commit workflow (1.5h)
- 3.3: Add git proxy API endpoints (2h)

**Afternoon** (6 hours):
- 4.1: Implement git operation logging (1.5h)
- 4.2: Add git metrics endpoint (1h)
- 5.1: Write unit tests for GitClient (1.5h)
- 5.2: Write integration tests for auto-commit (2h)

**End of Day 2** (1 hour):
- 5.3: Update documentation (1h)

**Total**: 22 hours (2.75 days) â†’ **Target: 2 days**

---

## ğŸ”‘ Key Features

### 1. Auto-Commit Service

**How it works**:
1. File watcher detects vault changes
2. AutoCommitService queues changes
3. Debounce timer waits 5 minutes (configurable)
4. Batch commit all queued changes
5. Generate semantic commit message via Claude
6. Execute git commit
7. Log operation to `git-operations.log`

**Configuration**:
```bash
GIT_AUTO_COMMIT_ENABLED=true
GIT_COMMIT_DEBOUNCE_MS=300000  # 5 minutes
```

---

### 2. Semantic Commit Messages

**Generated by Claude API**:
- Input: List of changed file paths
- Output: Conventional commit message

**Examples**:
- `docs(meetings): add project kickoff notes`
- `feat(concepts): add neural network taxonomy`
- `refactor(technical): reorganize API documentation`

**Fallback** (if Claude fails):
- Single file: `docs: update path/to/file.md`
- Multiple files: `docs: update 5 files`

---

### 3. Weaver Workflow Proxy

**Purpose**: Execute git operations as durable workflows.

**Benefits**:
- Workflow resume on failure
- Audit trail for compliance
- Advanced orchestration (branching, PRs)

**API Endpoint**:
```bash
POST /git/proxy/commit
{
  "files": ["meetings/project-kickoff.md"],
  "message": "docs(meetings): add project kickoff notes"
}
```

**Response**:
```json
{
  "status": "queued",
  "workflow": "git-commit"
}
```

---

### 4. Admin Endpoints

**GET /admin/git/status** - Git repository status:
```json
{
  "staged": ["file1.md"],
  "unstaged": ["file2.md"],
  "untracked": ["file3.md"]
}
```

**GET /admin/git/logs** - Recent commits:
```json
{
  "commits": [
    {
      "sha": "abc123",
      "message": "docs(meetings): add notes",
      "date": "2025-10-26T10:30:00Z",
      "files": ["meetings/notes.md"]
    }
  ]
}
```

**GET /admin/git/metrics** - Git metrics:
```json
{
  "totalCommits": 142,
  "commitsToday": 8,
  "avgMessageLength": 48,
  "failureRate": 0.02
}
```

**POST /admin/git/force-commit** - Force immediate commit (bypass debounce):
```json
{
  "status": "success",
  "sha": "def456"
}
```

---

## ğŸ§ª Testing Strategy

### Unit Tests

**git-client.test.ts**:
- Test repo initialization
- Test git operations (add, commit, log, diff)
- Test error handling (not a repo, corrupted index)

**auto-commit.test.ts**:
- Test debounce behavior
- Test commit message generation
- Test fallback messages
- Test force commit

### Integration Tests

**End-to-End**:
1. Create temp vault
2. Edit files via file system
3. Wait for auto-commit (or force)
4. Verify commit exists with correct message
5. Verify files staged and committed

**Manual Testing**:
1. Start MCP server: `npm run dev`
2. Edit note in Obsidian
3. Wait 5 minutes (or reduce debounce in .env)
4. Check `git log -1` for commit
5. Verify commit message is semantic

---

## ğŸ“ Configuration

### Environment Variables

```bash
# Git Configuration
GIT_USER_NAME=Weave-NN
GIT_USER_EMAIL=weave-nn@local
GIT_AUTO_COMMIT_ENABLED=true
GIT_COMMIT_DEBOUNCE_MS=300000  # 5 minutes

# Workflow Proxy (Optional)
GIT_WORKFLOW_PROXY_ENABLED=false
WEAVER_WEBHOOK_URL=http://localhost:3001/webhook

# Claude API (from Phase 7)
ANTHROPIC_API_KEY=sk-ant-...
```

### Dependencies

**npm packages**:
```json
{
  "dependencies": {
    "simple-git": "^3.24.0",
    "hono": "^4.0.0"
  }
}
```

**Runtime**:
- Node.js 18+
- Git CLI installed on system
- Weaver running (for workflow proxy)

---

## ğŸ”— Dependencies

### Required Phases

- **Phase 6 (Vault Initialization)**: Provides file watcher and shadow cache
- **Phase 7 (Agent Rules & MCP Tool)**: Provides `ClaudeClient` for message generation

### External Services

- **Claude API**: For commit message generation
- **Weaver**: For workflow proxy (optional)

---

## ğŸ“ˆ Success Criteria

### Technical Validation

- [ ] File changes auto-commit within 5 minutes
- [ ] Commit messages follow conventional format (95%+ compliance)
- [ ] Rapid changes batched into single commit
- [ ] Workflow proxy triggers Weaver workflows
- [ ] Git operations logged with SHA and timestamp
- [ ] Code coverage 85%+
- [ ] All tests passing

### User Experience

- [ ] No manual commits required
- [ ] Meaningful commit history (not "update" messages)
- [ ] Easy to review git logs via admin endpoint
- [ ] No performance degradation during auto-commit

### Performance

- Auto-commit latency: 5 minutes (configurable)
- Commit message generation: < 3 seconds (95th percentile)
- Workflow proxy response: < 1 second
- Git status check: < 500ms

---

## ğŸ”® Future Enhancements (Phase 9+)

### GitHub Integration

1. **Issue Sync**: Auto-create issues from `#bug` or `#feature` tags in notes
2. **Pull Requests**: Trigger PR creation when feature branch created
3. **Code Review**: Link commits to GitHub PRs for review

### Advanced Workflows

1. **Branch Automation**: Auto-create feature branches for large changes
2. **Conflict Resolution**: Detect merge conflicts, notify user via Obsidian
3. **Semantic Versioning**: Tag releases based on commit history

### Analytics

1. **Commit Analytics**: Track writing patterns (commits per day, time of day)
2. **Content Analysis**: Most edited topics, longest writing sessions
3. **Productivity Metrics**: Lines written per session, session duration

---

## ğŸ“ Design Decisions

### Why Debouncing?

**Problem**: Without debouncing, every file save triggers a commit.

**Solution**: 5-minute debounce window batches related changes into single commit.

**Benefits**:
- Fewer commits (cleaner history)
- Related changes grouped together
- Reduced Claude API calls (cost savings)

---

### Why Claude for Commit Messages?

**Problem**: Generic commit messages like "update" are useless.

**Solution**: Claude analyzes changed files and generates semantic messages.

**Benefits**:
- Meaningful commit history
- Searchable git log
- Automated changelog generation
- Understanding of vault evolution

---

### Why Workflow Proxy?

**Problem**: Direct git commits are not durable (server restart loses queued commits).

**Solution**: Weaver workflow proxy provides durable execution.

**Benefits**:
- Workflow resume on failure
- Audit trail for compliance
- Advanced orchestration (branching, PRs, issue sync)

---

## ğŸ“š Additional Resources

### Related Documentation

- [simple-git Documentation](https://github.com/steveukx/git-js)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [Weaver Workflows](../../../weaver/workflows/workflows-overview-hub.md)

### Internal Links

- [[phase-6-vault-initialization]] - Vault initialization system
- [[phase-7-agent-rules-memory-sync]] - Agent rules and Claude client
- [[phase-9-testing-documentation]] - Testing and documentation

---

## ğŸš€ Getting Started

1. **Read the Constitution**: Understand principles and constraints
2. **Review the Specification**: Understand requirements and architecture
3. **Follow the Tasks**: Implement step-by-step with acceptance criteria
4. **Test Thoroughly**: Unit tests + integration tests + manual testing
5. **Document**: Update README.md and add usage examples

---

**Status**: â³ **PENDING** (blocked by Phase 7)
**Dependencies**: Phase 7 (Agent Rules & MCP Tool)
**Next Phase**: [[phase-9-testing-documentation|Phase 9: Testing & Documentation]]

---

**Generated**: 2025-10-26
**Method**: AI-powered spec-kit generation
**Tool**: Claude Code with Spec-Kit workflow
