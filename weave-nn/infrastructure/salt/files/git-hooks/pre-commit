#!/bin/bash
#
# Weave-NN Git Pre-Commit Hook
#
# Validates commits before they are made to ensure quality and consistency
#

set -e

echo "Running Weave-NN pre-commit validation..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Function to print colored messages
print_status() {
    echo -e "${GREEN}[✓]${NC} $1"
}

print_error() {
    echo -e "${RED}[✗]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

# Check 1: Validate YAML frontmatter in markdown files
validate_frontmatter() {
    print_status "Validating YAML frontmatter..."

    staged_md_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' || true)

    if [ -z "$staged_md_files" ]; then
        return 0
    fi

    for file in $staged_md_files; do
        if [ ! -f "$file" ]; then
            continue
        fi

        # Check if file starts with ---
        if ! head -n 1 "$file" | grep -q '^---$'; then
            print_warning "$file: Missing YAML frontmatter"
            continue
        fi

        # Extract frontmatter and validate YAML
        frontmatter=$(sed -n '/^---$/,/^---$/p' "$file" | sed '1d;$d')

        if ! echo "$frontmatter" | python3 -c "import sys, yaml; yaml.safe_load(sys.stdin)" 2>/dev/null; then
            print_error "$file: Invalid YAML frontmatter"
            exit 1
        fi
    done

    print_status "Frontmatter validation passed"
}

# Check 2: Ensure no API keys are being committed
check_secrets() {
    print_status "Checking for secrets..."

    # Patterns that might indicate secrets
    secret_patterns=(
        'ANTHROPIC_API_KEY.*sk-ant-'
        'OBSIDIAN_API_KEY.*[a-f0-9]{32,}'
        'password.*=.*[^changeme]'
        'token.*=.*[a-zA-Z0-9]{20,}'
    )

    staged_files=$(git diff --cached --name-only --diff-filter=ACM)

    for file in $staged_files; do
        if [ ! -f "$file" ]; then
            continue
        fi

        for pattern in "${secret_patterns[@]}"; do
            if grep -iE "$pattern" "$file" >/dev/null 2>&1; then
                print_error "$file: Possible secret detected (pattern: $pattern)"
                print_error "Remove secrets before committing!"
                exit 1
            fi
        done
    done

    print_status "No secrets detected"
}

# Check 3: Prevent committing .env files
check_env_files() {
    print_status "Checking for .env files..."

    if git diff --cached --name-only | grep -E '^\.env$' >/dev/null; then
        print_error ".env file should not be committed!"
        print_error "Use .env.template instead"
        exit 1
    fi

    print_status "No .env files in commit"
}

# Check 4: Validate Python syntax (if any Python files changed)
validate_python() {
    print_status "Validating Python syntax..."

    staged_py_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

    if [ -z "$staged_py_files" ]; then
        return 0
    fi

    for file in $staged_py_files; do
        if [ ! -f "$file" ]; then
            continue
        fi

        if ! python3 -m py_compile "$file" 2>/dev/null; then
            print_error "$file: Python syntax error"
            exit 1
        fi
    done

    print_status "Python syntax validation passed"
}

# Run all checks
validate_frontmatter
check_secrets
check_env_files
validate_python

echo ""
print_status "All pre-commit checks passed!"
echo ""

exit 0
