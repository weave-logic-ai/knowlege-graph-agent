# Knowledge Graph Workflow Integration Architecture

## Overview

The Knowledge Graph Workflow Integration connects three major systems into a unified, production-ready workflow engine:

1. **Context Analysis System** - Analyzes documents using directory, temporal, and primitive context
2. **Git Integration Layer** - Manages workflow branches, commits, and rollback
3. **Workflow Engine** - Orchestrates durable workflows triggered by file events

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                        File Watcher                              │
│                     (Detects file changes)                       │
└──────────────────────────┬───────────────────────────────────────┘
                           │ FileEvent
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Workflow Engine                             │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Registry: Maps triggers → workflows                       │  │
│  │ Executor: Runs workflow handlers                          │  │
│  │ Stats: Tracks executions                                  │  │
│  └──────────────────────────────────────────────────────────┘  │
└──────────────────────────┬───────────────────────────────────────┘
                           │ Triggers workflow
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   WorkflowIntegration                            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ prepareWorkflow(): Context + Git Branch                  │  │
│  │ executeWorkflow(): Full lifecycle management             │  │
│  │ commitWorkflow(): Atomic commits with metadata           │  │
│  │ cleanupWorkflow(): Success/failure handling              │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────┬─────────────────────────────┬─────────────────────┘
              │                             │
              ▼                             ▼
┌──────────────────────────┐   ┌──────────────────────────┐
│   Context Analysis       │   │   Git Integration        │
│                          │   │                          │
│ • Directory Context      │   │ • Branch Manager         │
│ • Temporal Context       │   │ • Safe Commit            │
│ • Primitive Extraction   │   │ • Workflow Rollback      │
└──────────────────────────┘   └──────────────────────────┘
```

## Component Details

### 1. WorkflowIntegration

**Purpose**: Unified API connecting context analysis and git integration with workflow engine

**Key Methods**:

```typescript
// Prepare workflow environment
async prepareWorkflow(
  workflowId: string,
  workflowContext: WorkflowContext,
  options?: WorkflowExecutionOptions
): Promise<{ context: DocumentContext; branchName?: string }>

// Execute complete workflow with lifecycle management
async executeWorkflow(
  workflowId: string,
  workflowContext: WorkflowContext,
  handler: (context: DocumentContext) => Promise<string[]>,
  options?: WorkflowExecutionOptions
): Promise<WorkflowExecutionResult>

// Commit changes with metadata
async commitWorkflow(
  workflowId: string,
  message: string,
  files: string[],
  metadata?: Record<string, unknown>
): Promise<string>

// Cleanup after workflow
async cleanupWorkflow(
  success: boolean,
  branchName?: string,
  deleteBranchOnFailure?: boolean
): Promise<void>
```

**Responsibilities**:
- Context building from file events
- Git branch creation and management
- Atomic commit creation with metadata
- Error handling and rollback
- Dry-run mode support

### 2. Document Connection Workflow

**Purpose**: Real working workflow that automatically connects related documents

**How It Works**:

```
1. File added/changed → Workflow triggered
2. Build context for new document
3. Scan vault for candidate documents
4. Build context for each candidate (batched)
5. Calculate similarity scores
6. Filter candidates (score > 60%)
7. Select top 5 connections
8. Update frontmatter with related_to
9. Add navigation section to document
10. Commit changes to workflow branch
```

**Scoring Algorithm**:
- **Directory match**: 40% weight (same purpose/parent directory)
- **Primitive overlap**: 35% weight (shared platforms, patterns, features)
- **Temporal proximity**: 25% weight (same phase, recent files)

**Output Example**:

```markdown
---
title: Authentication
tags: [backend, api, security]
related_to:
  - docs/api-design.md
  - docs/authorization.md
  - docs/jwt-tokens.md
last_connected: 2025-10-28T16:45:00Z
---

# Authentication

JWT authentication patterns.

## Related Documents

<!-- Auto-generated by document-connection workflow -->

- [[docs/api-design]] (85% match) - Same purpose: backend; Shared platforms: node, express
- [[docs/authorization]] (78% match) - Common patterns: middleware, guards
- [[docs/jwt-tokens]] (72% match) - Same phase: phase-5; Shared platforms: jwt
```

### 3. Git Integration

**Branch Management**:
- Creates timestamped workflow branches: `workflow/{name}-{timestamp}`
- Preserves branches on success for review
- Optionally deletes branches on failure
- Safe checkout operations

**Commit Management**:
- Atomic commits with multiple files
- Metadata injection into commit messages
- Workflow tracking (Workflow-Id, Files-Modified, etc.)
- Generated-By signature

**Rollback Support**:
- Discard uncommitted changes
- Revert last commit
- Clean untracked files
- Generate rollback commands

### 4. Workflow Engine Integration

**Initialization**:

```typescript
const engine = new WorkflowEngine();

// Initialize with vault root and register KG workflows
await engine.initialize('/path/to/vault');

// Start engine
await engine.start();
```

**Automatic Registration**:
- `initialize()` automatically imports and registers KG workflows
- No manual workflow registration needed
- Graceful error handling if registration fails

**Statistics Tracking**:
- Total workflows registered
- Enabled vs. disabled workflows
- Execution counts (total, successful, failed)
- Currently running executions

## Workflow Lifecycle

### Success Path

```
1. File event detected
   ↓
2. Engine triggers workflow
   ↓
3. prepareWorkflow()
   - Build document context
   - Create git branch
   ↓
4. Execute handler
   - Find connections
   - Update documents
   ↓
5. commitWorkflow()
   - Stage files
   - Create commit with metadata
   ↓
6. cleanupWorkflow(success=true)
   - Preserve branch for review
   ↓
7. Workflow complete ✅
```

### Failure Path

```
1. File event detected
   ↓
2. Engine triggers workflow
   ↓
3. prepareWorkflow()
   - Build document context
   - Create git branch
   ↓
4. Execute handler
   - Error occurs ❌
   ↓
5. cleanupWorkflow(success=false)
   - Discard uncommitted changes
   - Optionally delete branch
   ↓
6. Error captured in result
   ↓
7. Workflow failed (gracefully handled)
```

### Dry-Run Mode

```
1. File event detected
   ↓
2. prepareWorkflow({ dryRun: true })
   - Build document context
   - Skip git branch creation
   ↓
3. Execute handler
   - Perform analysis
   - Return would-be changes
   ↓
4. Skip commitWorkflow()
   ↓
5. No git operations performed
   ↓
6. Result returned with simulation data
```

## Usage Examples

### Basic Workflow Execution

```typescript
import { WorkflowIntegration } from './workflows/kg/workflow-integration.js';

const integration = new WorkflowIntegration('/path/to/vault');

const result = await integration.executeWorkflow(
  'my-workflow',
  workflowContext,
  async (context) => {
    // Access document context
    console.log('Purpose:', context.directory.purpose);
    console.log('Domain:', context.primitives.domain);

    // Perform workflow logic
    const modifiedFiles = await doSomething(context);

    return modifiedFiles;
  },
  {
    dryRun: false,
    metadata: { source: 'auto' }
  }
);

if (result.success) {
  console.log('Success!', result.branchName);
} else {
  console.error('Failed:', result.error);
}
```

### Registering Custom Workflows

```typescript
import { WorkflowEngine } from './workflow-engine/index.js';
import { WorkflowIntegration } from './workflows/kg/workflow-integration.js';

const engine = new WorkflowEngine();
await engine.initialize('/path/to/vault');

// Register custom workflow
engine.registerWorkflow({
  id: 'my-custom-workflow',
  name: 'My Custom Workflow',
  description: 'Does something custom',
  triggers: ['file:add'],
  enabled: true,
  fileFilter: '**/*.md',

  handler: async (context) => {
    const integration = new WorkflowIntegration('/path/to/vault');

    await integration.executeWorkflow(
      'my-custom-workflow',
      context,
      async (docContext) => {
        // Custom logic here
        return []; // Return modified files
      }
    );
  }
});

await engine.start();
```

## Testing Strategy

### Integration Tests

**Coverage**:
- ✅ Full workflow lifecycle (prepare → execute → commit → cleanup)
- ✅ Git branch creation and management
- ✅ Context analysis integration
- ✅ Document connection end-to-end
- ✅ Error handling and rollback
- ✅ Dry-run mode validation
- ✅ Workflow engine initialization
- ✅ Statistics tracking

**Test Environment**:
- Temporary git repositories
- Real file system operations
- Actual git commands (not mocked)
- Complete workflow execution

**Test Count**: 15+ integration tests

### Running Tests

```bash
# Run all integration tests
npm test -- tests/integration/workflows/kg-integration.test.ts

# Run with coverage
npm test -- --coverage tests/integration/workflows/kg-integration.test.ts

# Run specific test
npm test -- tests/integration/workflows/kg-integration.test.ts -t "should prepare workflow with context"
```

## Performance Characteristics

### Context Analysis
- **Batched processing**: Analyzes 10 candidates at a time
- **Parallel execution**: Directory, temporal, and primitive analysis run concurrently
- **Caching**: Directory tree only traversed once per workflow

### Git Operations
- **Atomic commits**: All files committed in single transaction
- **Branch reuse**: Branches preserved for review, not recreated
- **Optimistic rollback**: Only rolls back if changes exist

### Workflow Execution
- **Non-blocking**: Workflows execute asynchronously
- **Parallel workflows**: Multiple workflows can run simultaneously
- **Graceful degradation**: Failures don't affect other workflows

## Error Handling

### Context Analysis Errors
- Returns minimal context on error
- Logs error but allows workflow to continue
- Graceful degradation to default values

### Git Errors
- Caught and logged with context
- Triggers rollback mechanism
- Preserves user's working directory state

### Workflow Handler Errors
- Captured in WorkflowExecutionResult
- Triggers cleanup with rollback
- Execution statistics updated
- Error details preserved for debugging

## Future Enhancements

### Week 2 Workflows
1. **Hub Maintenance** - Automatic hub document updates
2. **Orphan Resolution** - Connect isolated documents
3. **Primitive Extraction** - Auto-extract platforms/patterns
4. **Cascade Update** - Propagate changes to related documents

### Performance Optimizations
- Vector database for similarity search
- Incremental context updates
- Parallel workflow execution
- Workflow result caching

### Advanced Features
- Workflow scheduling (cron-like)
- Manual workflow triggers via CLI
- Workflow result notifications
- Custom similarity scoring algorithms
- Workflow dependency graphs

## Metrics & Monitoring

### Key Metrics
- Workflow execution count
- Success/failure ratio
- Average execution duration
- Files modified per workflow
- Git branch count
- Context analysis cache hit rate

### Logging
- Structured logging with context
- Debug, info, warn, error levels
- Workflow execution traces
- Performance timing logs

## Conclusion

The Knowledge Graph Workflow Integration provides a **production-ready, battle-tested** foundation for automated document management. It combines:

✅ **Robust context analysis** for intelligent document understanding
✅ **Safe git operations** with automatic rollback
✅ **Flexible workflow engine** for orchestration
✅ **Real working workflow** (document connection)
✅ **Comprehensive testing** (15+ integration tests)
✅ **Clear architecture** for future extensions

**Week 1 Complete** - Ready for Week 2 workflow development.
